ZVSE2
** Author orig.  : Algor
** Name          : Battle Heroes: main section



!?FU(BH_PreBattleClearBattleVars);
  !!SN:W^algor_cbf_a^/0 W^algor_cbf_d^/0;[обнуляем переменные состояний командиров]

  !!re (side:y)/0/(BATTLE_RIGHT);
    !!re (town:y)/0/(TOWN_LAST_WOG);
      !!re i/0/3;
        !!SN:W^b%(side).%(town).%i^;    
      !!en;
    !!en;

    !!re i/0/9;
      !!SN:W^Cmndr%(side)Sp%i^/-1;    [Очистка слотов магии командиров]
    !!en;
    !!SN:W^spec_%(side)^ W^Cmndr%(side)R^; [обнуляем специализации героев и командиров]
  !!en;

  !!SN:W^NextStack^/-1 W^FakeStack^/-1; [сброс переопределения хода]

!?BA52&i^battle_hasHuman^/i^battle_hero_1^<>(NO_HERO);                               [начало боя]
!!BA:H0/?v9998 H1/?v9999;             [v9998/v9999 - левый/правый герои]
!!FU|v9998<0/v9999<0:E;               [выход, если не герой-на-героя]

!!FU(BH_PreBattleClearBattleVars):P;

*!SN:W^spec_0^/0 W^spec_1^/0;         [обнуляем специализации героев]

  *!SN:W^b0.0.0^/0 W^b0.0.1^/0 W^b0.0.2^/0 W^b0.1.0^/0 W^b0.1.1^/0 W^b0.1.2^/0 W^b0.2.0^/0 W^b0.2.1^/0 W^b0.2.2^/0; [обнуляем спец.строения героев]
  *!SN:W^b0.3.0^/0 W^b0.3.1^/0 W^b0.3.2^/0 W^b0.4.0^/0 W^b0.4.1^/0 W^b0.4.2^/0 W^b0.5.0^/0 W^b0.5.1^/0 W^b0.5.2^/0; [...]
  *!SN:W^b0.6.0^/0 W^b0.6.1^/0 W^b0.6.2^/0 W^b0.7.0^/0 W^b0.7.1^/0 W^b0.7.2^/0 W^b0.8.0^/0 W^b0.8.1^/0 W^b0.8.2^/0; [...]
  *!SN:W^b1.0.0^/0 W^b1.0.1^/0 W^b1.0.2^/0 W^b1.1.0^/0 W^b1.1.1^/0 W^b1.1.2^/0 W^b1.2.0^/0 W^b1.2.1^/0 W^b1.2.2^/0; [...]
  *!SN:W^b1.3.0^/0 W^b1.3.1^/0 W^b1.3.2^/0 W^b1.4.0^/0 W^b1.4.1^/0 W^b1.4.2^/0 W^b1.5.0^/0 W^b1.5.1^/0 W^b1.5.2^/0; [...]
  *!SN:W^b1.6.0^/0 W^b1.6.1^/0 W^b1.6.2^/0 W^b1.7.0^/0 W^b1.7.1^/0 W^b1.7.2^/0 W^b1.8.0^/0 W^b1.8.1^/0 W^b1.8.2^/0; [...]

  *!SN:W^Cmndr0Sp0^/-1 W^Cmndr0Sp1^/-1; [Очистка слотов магии командиров]
  *!SN:W^Cmndr0Sp2^/-1 W^Cmndr0Sp3^/-1; [...]
  *!SN:W^Cmndr0Sp4^/-1 W^Cmndr0Sp5^/-1; [...]
  *!SN:W^Cmndr0Sp6^/-1 W^Cmndr0Sp7^/-1; [...]
  *!SN:W^Cmndr0Sp8^/-1 W^Cmndr0Sp9^/-1; [...]
  *!SN:W^Cmndr1Sp0^/-1 W^Cmndr1Sp1^/-1; [...]
  *!SN:W^Cmndr1Sp2^/-1 W^Cmndr1Sp3^/-1; [...]
  *!SN:W^Cmndr1Sp4^/-1 W^Cmndr1Sp5^/-1; [...]
  *!SN:W^Cmndr1Sp6^/-1 W^Cmndr1Sp7^/-1; [...]
  *!SN:W^Cmndr1Sp8^/-1 W^Cmndr1Sp9^/-1; [...]
  *!SN:W^Cmndr0R^/0 W^Cmndr1R^/0;       [...]


!!UN:C6919200/4/?v7920;               [v7920 - combatmanager]
!!HEv9998:O?y1 E?v9966/?v9968;        [y3/y4 = 1 для ИИ героя...]
!!HEv9999:O?y2 E?v9967/?v9969;        [v9966-9969 - опыт и уровни героев...]
!!OW:Iy1/?y3;                         [...]
!!OW:Iy2/?y4;                         [...]
!!FU&y3=1/y4=1:E;                     [выход, если ИИ-на-ИИ]
!!FU9024&y3=1:Pv9998;                 [Загрузка параметров схемы предпочтений нападающего ИИ]
!!FU9024&y4=1:Pv9999;                 [Загрузка параметров схемы предпочтений защищающегося ИИ]
** Параметры уровня сложности
!!VRz1:S^BattleHeroes.ini^;           [z1 - имя ini-файла]
!!VRz2:S^difficulty^;                 [z2 - секция "difficulty"]
!!UN:N6/3/0/2/1;                      [z3 - текстовое значение опции 0]
!!VRv9918:Vz3;                        [v9918 - бонус/щтраф здоровья от уровня сложности]
!!UN:N6/3/1/2/1;                      [z3 - текстовое значение опции 1]
!!VRv9919:Vz3;                        [v9919 - фора (бонусные раздачи) от уровня сложности]
!!UN:N6/3/2/2/1;                      [z3 - текстовое значение опции 2]
!!VRv9993:Vz3;                        [v9993 - стартовые раздачи]
!!UN:N6/3/3/2/1;                      [z3 - текстовое значение опции 3]
!!VRv7909:Vz3;                        [v7909 - параметр отображения состояния/действий ИИ]
***
!!BA:Q0;                              [сброс флага быстрой битвы]
!!UN:J1/1/?y10;                       [ограничение на прокачку героев: 1й уровень]
!!IF:V445/0;                          [обнуление флага начала боя]
!!DO9002/0/69/1:Pv9998/1 Pv9999/2;    [сохранение параметров, заклинаний и навыков героев]
** Добавление заклинаний от надетых подвесок
!!HE-10:A2/100/?i/?y20 A2/101/?i/?y21 A2/102/?i/?y22 A2/103/?i/?y23 A2/104/?i/?y24 A2/105/?i/?y25 A2/106/?i/?y26 A2/107/?i/?y27; [y10-y27 - надетые подвески]
!!HE-10&y20>0:M59/1;                  [добавление заклинаний подвесками]
!!HE-10&y21>0:M62/1;                  [...]
!!HE-10&y22>0:M42/1;                  [...]
!!HE-10&y23>0:M24/1;                  [...]
!!HE-10&y24>0:M25/1;                  [...]
!!HE-10&y25>0:M60/1;                  [...]
!!HE-10&y26>0:M17/1 M19/1;            [...]
!!HE-10&y27>0:M61/1;                  [...]
!!HE-20:A2/100/?i/?y20 A2/101/?i/?y21 A2/102/?i/?y22 A2/103/?i/?y23 A2/104/?i/?y24 A2/105/?i/?y25 A2/106/?i/?y26 A2/107/?i/?y27; [y10-y27 - надетые подвески]
!!HE-20&y20>0:M59/1;                  [добавление заклинаний подвесками]
!!HE-20&y21>0:M62/1;                  [...]
!!HE-20&y22>0:M42/1;                  [...]
!!HE-20&y23>0:M24/1;                  [...]
!!HE-20&y24>0:M25/1;                  [...]
!!HE-20&y25>0:M60/1;                  [...]
!!HE-20&y26>0:M17/1 M19/1;            [...]
!!HE-20&y27>0:M61/1;                  [...]
**
!!HE-10:S12/?v9970 S12/0 S10/?i S20/i S27/i; [Перемещение навыков Некромантии героев в v-переменные...]
!!HE-20:S12/?v9971 S12/0 S10/?i S20/i S27/i; [... и установка Артиллерии и Первой Помощи равными Боевым машинам (Баллистике)]
!!DO9039/0/41/1:P-1;                  [сброс базовых количеств отрядов живых существ для некромантии]
!!IF:V444/0;                          [обнуление флага некромантии]
!!HEv9998:I10/1;                      [установка маны]
!!HEv9999:I10/1;                      [установка маны]
!!FU9017:Pv9998 Pv9999;               [сброс параметров командиров]
!!VRv9964:C0/0;                       [сброс способностей "повышенная регенерация"]
!!SN:W^BH.Commander0.Hardiness^/0;    [сброс способности «Выносливость»]
!!SN:W^BH.Commander1.Hardiness^/0;    [...]
!!HE-10:S13/?y1;                      [y1 - уровень Поместий левого]
!!HE-20:S13/?y2;                      [y2 - уровень Поместий правого]
!!VRy1:+1;                            [y1 - начальный уровень зданий левого]
!!VRy2:+1;                            [y2 - начальный уровень зданий правого]
!!VRv9980:Cy1/y1/y1/y2/y2/y2;         [герои имеют отстроенные жилища 1-2го уровней (в зависимости от навыка Поместья) для каждой расы дружественной фракции]
!!HE-10:S(SKILL_TACTICS)/?i^bh_tactics_0^ S(SKILL_TACTICS)/0;             [v9986 - Навык Тактики левого. Отключение тактической фазы]
!!HE-20:S(SKILL_TACTICS)/?i^bh_tactics_1^ S(SKILL_TACTICS)/0;             [v9987 - Навык Тактики правого. Отключение тактической фазы]
!!COv9998:E1;                         [Включение командира левого]
!!COv9999:E1;                         [Включение командира правого]
!!VRv9963:S-1;                        [обнуляем значение произнесенного заклинания (Глаз Орла)]

!?BA53;                               [окончание боя боя]
!!BA:H0/?y1 H1/?y2;                   [y1/y2 - левый и правый герои]
!!HEy1:O?y3;                          [y3 - хозяин левого]
!!HEy2:O?y4;                          [y4 - хозяин левого]
!!OW:Iy3/?y5 Iy4/?y6;                 [y5/y6 - ИИ статусы левого и правого героев (1-ИИ, 0-человек)]
!!VRy7:S-1;                           [инициализация y7]
!!VRy7&y3>-1:Sy1;                     [y7 - номер победившего героя]
!!VRy7&y4>-1:Sy2;                     [-1, если оба проиграли]
!!SN:W^BH.AI.LOG^/?i;                 [i - флаг логирования состояния ИИ послеокончания боя]
!!FU9052&y5=1/i>0:Py1/y3/0;           [формирование лога ИИ]
!!FU9052&y6=1/i>0:Py2/y4/1;           [...]
!!UN:J1/75/?y10;                      [снятие ограничения по уровню героев]
!!HEv9998:Ev9966/v9968;               [восстановление уровней и опыта сражавшихся героев]
!!HEv9999:Ev9967/v9969;               []
!!if&y7>-1;                           [если есть победитель]
  !!HEy7:Ed/?y8;                      [y8 - уровень игрока победителя +1]
  !!VRy8:+1;                          [...]
  !!UN:J1/y8/?y9 J1/75/?y10;          [y9 - опыт для следующего уровня]
  !!HEy7:E?y10;                       [...]
  !!VRy9:-y10;                        [...]
  !!HEy7:Edy9 Ed/y8;                  [повышение уровня героя-победителя до нового уровня]
!!en; 
!!COv9998:E0;                         [Выключение командира левого]
!!COv9999:E0;                         [Выключение командира правого]

!?FU9002;                             [сохранение/восстановление параметров,заклинания и втор. навыков x16 героя x1 (x2=1/2/11/12 - сохранить 1/сохранить 2/восстановть 1/восстановть 2)]
!!VRy10:Sx2 -1;                       [y10 - "номер слота" (0..1)]
!!VRy10&x2>10:Sx2 -11;                [...]
!!VRy1:Sy10 *100 +9700 +x16;          [y1 - индекс заклинания]
!!VRy2:Sy1 +70;                       [y2 - индекс навыка]
!!VRy3:Sy10 *100 +9700;               [y3 - индекс атаки]
!!VRy4:Sy10 *100 +9701;               [y3 - индекс защиты]
!!VRy5:Sy10 *100 +9702;               [y3 - индекс силы]
!!VRy6:Sy10 *100 +9703;               [y3 - индекс знания]
!!VRy7:Sy10 *100 +9704;               [y3 - индекс маны]
!!if|x2<10; 
  !!HEx1&x16>9:Mx16/?vy1;             [сохранить заклинание героя]
  !!HEx1&x16<28:Sx16/?vy2;            [сохранить вторичный навык героя]
  !!HEx1&x16=0:F?vy3/?vy4/?vy5/?vy6 I?vy7/1; [сохранить параметры и ману]
!!en; 
!!if|x2>10; 
  !!HEx1&x16>9:Mx16/vy1;              [восстановить заклинание героя]
  !!HEx1&x16<28:Sx16/vy2;             [восстановить вторичный навык героя]
  !!HEx1&x16=0:Fvy3/vy4/vy5/vy6 Ivy7/1; [восстановить параметры и ману]
!!en; 

!?FU9007;                             [обнуление v-переменных]
!!VRvx16:S0;                          [обнуление vx16]


!?FU(BH_SetCommStats);
!#VA(side:x) (gameDiff:x);

  !!VR(min:y):S(side) *21;
  !!VR(max:y):S(min) +20;

  !!re i/(min)/(max);
    !!BMi:T?(monType:y);
    !!if&(monType)>=(MON_COMMANDER_FIRST_A)/(monType)<=(MON_COMMANDER_LAST_D);
      !!VRi^bh_commander_stack_%(side)^:Si;
      !!VRi:S(max);
    !!en;
  !!en;

  !!BMi^bh_commander_stack_%(side)^:S2 E0;[установка базовой скорости командира, обнуление количества заклинаний]

  !!VR(baseHp:y):S3000;

  !!if&(gameDiff)<>1;
    !!VR(tax:y):S1 -(gameDiff) *v9918 *-1;

    !!if&i^battle_ai_%(side)^=(TRUE);   if AI side
      !!VR(baseHp):+(tax);
    !!el; if human side
      !!VR(baseHp):-(tax);
    !!en;

    !!VR(baseHp)&(baseHp)<1:S1;
  !!en;

  !!BMi^bh_commander_stack_%(side)^:S2 E0 H(baseHp); [set com stack speed, spells, hp]
  !!MA:P(monType)/(baseHp);                                        [set com mon Hp]

  !!HEi^battle_hero_%(side)^:S(SKILL_LOGISTICS)/?(speedBonus:y);

  !!if&(speedBonus);
    !!DO9018/(min)/(max)/1:P(speedBonus);             [увеличение скорости отрядов левого на навык Логистики]
  !!en;

  !!HEi^battle_hero_%(side)^:A2/(ART_RING_OF_THE_WAYFARER)/d/?(isRing:y) A2/(ART_NECKLACE_OF_SWIFTNESS)/d/?(isNeck:y) A2/99/d/?(isCloak:y);
  !!VR(speedBonus):S0;
  !!VR(speedBonus)&(isRing:y):+1; !!VR(speedBonus)&(isNeck:y):+1; !!VR(speedBonus)&(isCloak:y):+1;
  !!BMi^bh_commander_stack_%(side)^:Sd(speedBonus); [set com stack bon speed]


  !!HEi^battle_hero_%(side)^:S(SKILL_TACTICS)/i^bh_tactics_%(side)^; [restore tactics]
  !!SN:W^bh_tactics_%(side)^;

  !!HEi^battle_hero_%(side)^:N?y20 A2/146/?y21/?i A2/154/?y22/?i A2/147/?y23/?i A2/148/?y24/?i A2/150/?y25/?i A2/151/?y26/?i A2/155/?y27/?i; [...]
  !!BMi^bh_commander_stack_%(side)^&y21>0:Ad12;                 [повышение атаки отряда]
  !!BMi^bh_commander_stack_%(side)^&y22>0:Dd12;                 [повышение защиты отряда]
  !!BMi^bh_commander_stack_%(side)^&y23>0:Hd750;                [повышение здоровья отряда]
  !!BMi^bh_commander_stack_%(side)^&y24>0:U1/d12 U2/d24;        [повышение урона отряда]
  !!COi^battle_hero_%(side)^&y25>0:P6/d30;                 [повышение сопротивления командира]
  !!BMi^bh_commander_stack_%(side)^&y26>0:Sd3;                  [повышение скорости отряда]
  !!BMi^bh_commander_stack_%(side)^&y27>0:Ad4 Dd4 Hd250 U1/d4 U2/d8 Sd1; [повышение параметров отряда]
  !!COi^battle_hero_%(side)^&y27>0:P6/d10;                 [повышение сопротивления командира]


!?FU(BH_BonusStartingHands);
!#VA(side:x) (gameDiff:x);
!!VR(bonusDistr:y):S0;

!!if&(gameDiff)<>1;
  !!VR(bonusDistr:y):S(gameDiff) -1 *i^battle_ai_%(side)^ |i^battle_human_%(side)^;
!!en;

!!VR(bonusDistr):+v9993;

!!DO9005/1/(bonusDistr)/1:Pi^battle_hero_%(side)^/(side)/0;        [бонусные раздачи атакующего ИИ]

!?FU(BH_BattleStatsInit);

!!UN:J2/?(gameDiff:y);


  *!BMi^bh_commander_stack_0^:S2 E0;                      [установка базовой скорости командира левого, обнуление количества заклинаний]
  *!BMi^bh_commander_stack_1^:S2 E0;                      [установка базовой скорости командира правого, обнуление количества заклинаний]


  *!HE-10:O?y1;                         [y1 - владелец левого]
  *!HE-20:O?y2;                         [y2 - владелец правого]
  *!OW:Iy1/?y3 Iy2/?y4;                 [y3/y4 - признак ИИ для левого/правого]
  *!UN:J2/?y5;                          [y5 - уровень сложности (0..4)]
  *!VRy6:S3000;                         [y6 - базовое здоровье командира ии 3000]

  *!VRy6&y5=0:-v9918;                   [штраф за легкий уровень]
  *!VRy6&y5=2:+v9918;                   [бонусы за тяжелые уровни]
  *!VRy6&y5=3:+v9918 +v9918;            [...]
  *!VRy6&y5=4:+v9918 +v9918 +v9918;     [...]
  *!VRy6&y6<1:S1;                       [...]


  *!VRy7:S3000;                         [y7 - базовое здоровье командира человека 3000]
  *!VRy7&y5=0:+v9918;                   [штраф за легкий уровень]

  *!VRy7&y5=2:-v9918;                   [бонусы за тяжелые уровни]
  *!VRy7&y5=3:-v9918 -v9918;            [...]
  *!VRy7&y5=4:-v9918 -v9918 -v9918;     [...]
  *!VRy7&y7<1:S1;                       [...]
  *!BMi^bh_commander_stack_0^&y3=1:Hy6;                   [установка здоровья командиров]
  *!BMi^bh_commander_stack_0^&y3=0:Hy7;                   [...]
  *!BMi^bh_commander_stack_1^&y4=1:Hy6;                   [...]
  *!BMi^bh_commander_stack_1^&y4=0:Hy7;                   [...]
  *!BMi^bh_commander_stack_0^:T?i H?j;                    [...]
  *!MA:Pi/j;                            [...]
  *!BMi^bh_commander_stack_1^:T?i H?j;                    [...]
  *!MA:Pi/j;                            [...]

  *!HE-10:S2/?y1;                       [y1 - навык Логистики левого]
  *!DO9018/0/20/1&y1>0:Py1;             [увеличение скорости отрядов левого на навык Логистики]

  *!HE-10:A2/69/?i/?y3 A2/97/?i/?y4 A2/99/?i/?y5; [y3/y5 - Кольцо странника/Ожерелье стремительности/Накидка скорости]
  *!VRy5:*2 +y4 +y3;                    [y5 - общий бонус артефактов скорости]

  *!BMi^bh_commander_stack_0^:Sdy5;                       [повышение скорости командира]


  *!HE-20:S2/?y1;                       [y1 - навык Логистики правого]
  *!DO9018/21/41/1&y1>0:Py1;            [увеличение скорости отрядов правого на навык Логистики]
  *!HE-20:A2/69/?i/?y3 A2/97/?i/?y4 A2/99/?i/?y5; [y3/y5 - Кольцо странника/Ожерелье стремительности/Накидка скорости]

  *!VRy5:*2 +y4 +y3;                    [y5 - общий бонус артефактов скорости]
  *!BMi^bh_commander_stack_1^:Sdy5;                       [повышение скорости командира]

  *!HE-10:S19/v9986;                    [восстановление Тактики левого]
  *!HE-20:S19/v9987;                    [восстановление Тактики правого]
  ** бонусы артефактов командира

  **y20 - номер командира, y21-y26 - имеющиеся артефакты командира
  *!HE-10:N?y20 A2/146/?y21/?i A2/154/?y22/?i A2/147/?y23/?i A2/148/?y24/?i A2/150/?y25/?i A2/151/?y26/?i A2/155/?y27/?i; [...]
  *!BMi^bh_commander_stack_0^&y21>0:Ad12;                 [повышение атаки отряда]
  *!BMi^bh_commander_stack_0^&y22>0:Dd12;                 [повышение защиты отряда]
  *!BMi^bh_commander_stack_0^&y23>0:Hd750;                [повышение здоровья отряда]
  *!BMi^bh_commander_stack_0^&y24>0:U1/d12 U2/d24;        [повышение урона отряда]
  *!COy20&y25>0:P6/d30;                 [повышение сопротивления командира]
  *!BMi^bh_commander_stack_0^&y26>0:Sd3;                  [повышение скорости отряда]
  *!BMi^bh_commander_stack_0^&y27>0:Ad4 Dd4 Hd250 U1/d4 U2/d8 Sd1; [повышение параметров отряда]
  *!COy20&y27>0:P6/d10;                 [повышение сопротивления командира]


  *!HE-20:N?y20 A2/146/?y21/?i A2/154/?y22/?i A2/147/?y23/?i A2/148/?y24/?i A2/150/?y25/?i A2/151/?y26/?i A2/155/?y27/?i; [...]
  *!BMi^bh_commander_stack_1^&y21>0:Ad12;                 [повышение атаки отряда]
  *!BMi^bh_commander_stack_1^&y22>0:Dd12;                 [повышение защиты отряда]
  *!BMi^bh_commander_stack_1^&y23>0:Hd750;                [повышение здоровья отряда]
  *!BMi^bh_commander_stack_1^&y24>0:U1/d12 U2/d24;        [повышение урона отряда]
  *!COy20&y25>0:P6/d30;                 [повышение сопротивления командира]
  *!BMi^bh_commander_stack_1^&y26>0:Sd3;                  [повышение скорости отряда]
  *!BMi^bh_commander_stack_1^&y27>0:Ad4 Dd4 Hd250 U1/d4 U2/d8 Sd1; [повышение параметров отряда]
  *!COy20&y27>0:P6/d10;                 [повышение сопротивления командира]

!!FU(BH_SetCommStats):P0/(gameDiff) P1/(gameDiff);
**
!!IF:V445/1;                          [установка флага начала боя]

** фора (бонусные раздачи) за уровень сложности
!!HE-10:O?y1;                         [y1 - владелец левого]
!!HE-20:O?y2;                         [y2 - владелец правого]
!!OW:Iy1/?y3 Iy2/?y4;                 [y3/y4 - признак ИИ для левого/правого]
!!UN:J2/?y5;                          [y5 - уровень сложности (0..4)]


!!FU(BH_BonusStartingHands):P0/(gameDiff) P1/(gameDiff);


*!VRy6:S0;                            [обнуление y6]
*!VRy7:S0;                            [обнуление y7]

*!VRy6&y5>1:Sy5 -1 *v9919;            [для ИИ +v9919 бонусных раздач за каждый УС более нормального]
*!VRy7&y5=0:Sv9919;                   [для человека v9919 бонусных раздач за УС "легкий"]

*!VRy6:+v9993;                        [общее кол-во раздач (бонусные + стартовые для ИИ)]
*!VRy7:+v9993;                        [общее кол-во раздач (бонусные + стартовые для человека)]

*!DO9005/1/y6/1&y3=1:P-10/0/0;        [бонусные раздачи атакующего ИИ]
*!DO9005/1/y7/1&y3=0:P-10/0/0;        [бонусные раздачи атакующего человека]
*!DO9005/1/y6/1&y4=1:P-20/1/0;        [бонусные раздачи защищающегося ИИ]
*!DO9005/1/y7/1&y4=0:P-20/1/0;        [бонусные раздачи защищающегося человека]
**
!!FU9044:P;                           [ходы героев в первом раунде]
!!FU9062:P-10/0 P-20/1;               [действия строений в первом раунде]
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?BR;                                 [начало раунда]
!!FU&-445:E;                          [выход, если бой еще не начался]
** Проверка на смерть командиров
!!BMi^bh_commander_stack_1^:N?y1;                       [y1=0, если командир правого мертв...]
!!BMi^bh_commander_stack_0^:N?y2;                       [y2=0, если командир левого мертв...]
!!if|y1=0/y2=0;                       [если погиб один из командиров]
  !!FU9017:Pv9998 Pv9999;             [сброс параметров командиров]
  !!FU9056:P-10/0 P-20/1;             [отмена усиления Университета Магии]
  !!DO9002/0/69/1:Pv9998/11 Pv9999/12;[восстановление параметров, заклианний и навыков у героев, если бой завершен]
  !!DO9016/0/41/1:P;                  [отзыв отрядов]
  !!FU:E;                             [выход, если бой закончен]
!!en; 
!!FU9040&444:P;                       [если некромантия не проверялась, вызываем проверку]
!!FU9003&v997>0:P-10/0 P-20/1;        [восполнение маны героям]
!!FU9056:P-10/0 P-20/1;               [отмена усиления Университета Магии]
!!FU9044&v997>0:P;                    [ходы героев, если раунд не первый]
!!FU9062&v997>0:P-10/0 P-20/1;        [действия строений]
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?FU9044;                             [ходы героев]
!!VRz1:Sz179191;                      [z1 - сообщение о фазе выбора карт]
!!BU:Mz1;                             [вывод сообщения в лог боя]
!!VRy1:Sv997 %2 +1 *-10;              [y1 = -10/-20 в зависимости от номера раунда]
!!VRy2:Sv997 +1 %2 +1 *-10;           [y2 = -20/-10 в зависимости от номера раунда]
!!VRy3:Sv997 %2;                      [y3 = 0/1 в зависимости от номера раунда]
!!VRy4:Sv997 +1 %2;                   [y4 = 0/1 в зависимости от номера раунда]
!!FU9005:Py1/y3/0;                    [предлагаем действие первому герою]
!!HEy1:S24/?i;                        [i - Интеллект первого героя]
!!VRi&i>0:+1;                         [0/2/3/4]
!!SN:W^b%Y3.1.0^/?y10;                [y10 - наличие Фонтана фортуны]
!!VRy10:*5;                           [бонус Фонтана]
!!VRi:*5;                             [Шанс срабатывания Интеллекта 0/10/15/20%]
!!VRi&i>0/y10>0:+5;                   [+5% за ФФ]
!!VRj:S1 R99;                         [j - случайное число 1..100]
!!FU9005&i>=j:Py1/y3/0;               [предлагаем первому герою бонусное действие, если сработал Интеллект]
!!FU9005:Py2/y4/0;                    [предлагаем действие второму герою]
!!HEy2:S24/?i;                        [i - Интеллект второго героя]
!!VRi&i>0:+1;                         [0/2/3/4]
!!SN:W^b%Y4.1.0^/?y10;                [y10 - наличие Фонтана фортуны]
!!VRy10:*5;                           [бонус Фонтана]
!!VRi:*5;                             [Шанс срабатывания Интеллекта 0/10/15/20%]
!!VRi&i>0/y10>0:+5;                   [+5% за ФФ]
!!VRj:S1 R99;                         [j - случайное число 1..100]
!!FU9005&i>=j:Py2/y4/0;               [предлагаем второму герою бонусное действие, если сработал Интеллект]

!?BG0;                                [перед действием в бою]
** сохранение последнего действия командира
!!BG:A?y1 N?y2;                       [y1 - тип действия, y2 - активный отряд]
!!BMy2&y2>=0:T?y3;                    [y3 - тип активного отряда]
!!SN&y3>=174/y3<=182:W^algor_cbf_a^/y1;[сохраняем последнее действие атакующего командира]
!!SN&y3>=183/y3<=191:W^algor_cbf_d^/y1;[сохраняем последнее действие защищающегося командира]
** некромантия - сохранение базовых количеств отрядов живых существ перед действием в v9920-9961
!!if&-444; 
  !!DO9039/0/41/1:P0;                 [сохранение базовых количеств отрядов живых существ для некромантии]
  !!BG:Q?v9962;                       [v9962 - сторона выполняющая действие (0..1)]
  !!IF:V444/1;                        [установка флага некромантии]
!!en; 

!?FU9039;                             [сохранение базовых количеств отрядов живых существ для некромантии, суммирование в v1 базовых численностей погибших отрядов (x1=1)]
!!VRi:S9920 +x16;                     [i - индекс v-переменной для сохранения]
!!if&x1=-1;                           [в начале боя обнулем информацию о живых отрядах (x1=-1)]
  !!VRvi:S0;                          [...]
  !!FU:E;                             [...]
!!en; 
!!BMx16:T?y1 N?y2;                    [y1/y2 - тип/численность отряда]
!!if|y1=-1/y2=0;                      [если отряд не существует]
  !!VRv1&x1=1:+vi;                    [после действия добавляем в v1 базовое количество существ убитого отряда]
  !!VRvi:S0;                          [обнуление v-переменной]
  !!FU:E;                             [выход]
!!el; 
  !!VRvi:S0;                          [обнуление v-переменной]
!!en; 
!!BMx16:B?y3 F?y4;                    [y3/y4 - базовое количество/флаги отряда]
!!VRy5:Sy4 &16;                       [y5=16 для живого отряда]
!!VRy6:Sy4 &8388608;                  [y6=0 для не-клона]
!!VRvi&y5=16/y6=0:Sy3;                [сохранение базовой численности неклонированного отряда живых существ в v-переменную]

!?FU9040;                             [Некромантия]
!!IF:V444/0;                          [сброс флага некромантии]
!!VRy1:Sv9962 *-10 -10;               [y1 - ходящий герой (-10/-20)]
!!VRy2&y1=-10:Sv9970;                 [y2 - навык Некромантии Героя]
!!VRy2&y1=-20:Sv9971;                 [...]
!!HEy1:A2/54/?i/?y3 A2/55/?i/?y4 A2/56/?i/?y5 A2/130/?i/?y6; [y3/y6 - Амулет Гробовщика/Мантия Вампира/Сапоги мертвеца/ПКН]
** Усилитель Некромантии - +2 к рангу поднимаемой нежити
!!VRy7:Sy1 :-20;                      [y7 - ходящая сторона]
!!SN:W^b%Y7.4.0^/?y8;                 [y8 - Усилитель некромантии]
!!VRv1:S0;                            [инициализация v1]
!!DO9039/0/41/1:P1;                   [сохранение базовых количеств отрядов живых существ для некромантии]
!!if|y2>0/y3>0/y4>0/y5>0/y6>0;        [если у героя есть хоть что-то некромантское]
  !!if&v1>0;                          [если есть погибшие отряды живых существ]
  !!VRy10:Sy2;                        [y10 - Эффективный уровень Некромантии - % восстанавливаемых существ]
  !!VRy10&y2>0:*10 +40;               [Навык: 50/60/70%]
  !!VRy10&y3>0:+5;                    [Амулет Гробовщика +5%]
  !!VRy10&y4>0:+10;                   [Мантия Вампира +10%]
  !!VRy10&y5>0:+15;                   [Сапоги Мертвеца +15%]
  !!VRy10&y6>0:+30%;                  [ПКН +5%]
  !!VRy11:S55;                        [y11 - Эффективный уровень Некромантии - тип восстанавливаемых существ]
  !!VRy11&y2>0:+y2;                   [Навык: Скелеты/Ск.воины/Ход.мертвецы%]
  !!VRy11&y3>0:+1;                    [Амулет Гробовщика +1 уровень]
  !!VRy11&y4>0:+1;                    [Мантия Вампира +1 уровень]
  !!VRy11&y5>0:+1;                    [Сапоги Мертвеца +1 уровень]
  !!VRy11&y6>0:+3;                    [ПКН +3 уровня]
  !!VRy11&y8>0:+2;                    [Усилитель Некромантии +2 уровня]
  !!VRy12:Sv1 *y10 :100;              [y12 - кол-во поднимаемых существ]
  !!FU&y12<1:E;                       [выход, если герой никого не можеть поднять]
  !!HEy1:B0/?z1;                      [z1 - имя героя]
  !!UN&y12=1:N3/2/y11/0;              [z2 - название существ]
  !!UN&y12>1:N3/2/y11/1;              [...]
  !!VRz3:Sz179966;                    [получаем текст сообщения для вывода в лог]
  !!BU:Mz3;                           [вывод сообщения]
  !!FU9010:Py11/v9962/y12/0/1;        [поднятие отряда нежити]
  !!en; 
!!en; 

!?FU77006;                            [получение хода отрядом]
** Проверка на смерть командиров, переоценка командиров
!!BMi^bh_commander_stack_1^:N?y1;                       [y1=0, если командир правого мертв...]
!!BMi^bh_commander_stack_0^:N?y2;                       [y2=0, если командир левого мертв...]
!!if|y1=0/y2=0;                       [если погиб один из командиров]
  !!FU9017:Pv9998 Pv9999;             [сброс параметров командиров]
  !!FU9056:P-10/0 P-20/1;             [отмена усиления Университета Магии]
  !!DO9002/0/69/1:Pv9998/11 Pv9999/12;[восстановление параметров, заклианний и навыков у героев, если бой завершен]
  !!DO9016/0/41/1:P;                  [отзыв отрядов]
  !!FU:E;                             [выход, если бой закончен]
!!en; 
!!BMi^bh_commander_stack_0^:H?y1 L?y2 T?y3;             [y1/y2/y3 - здоровье/ранения/тип командира атакующего]
!!VRy4:S2500 -y1 +y2 :10 *y4;         [Боевая ИИ-ценность командира(250-HP/10)^2 min 1000]
!!VRy4&y4<1000:S1000;                 [...]
!!MA:Fy3/y4;                          [Обновление ИИ ценности командира]
!!BMi^bh_commander_stack_1^:H?y1 L?y2 T?y3;             [y1/y2/y3 - здоровье/ранения/тип командира защищающегося]
!!VRy4:S2500 -y1 +y2 :10 *y4;         [Боевая ИИ-ценность командира(250-HP/10)^2 min 1000]
!!VRy4&y4<1000:S1000;                 [...]
!!MA:Fy3/y4;                          [Обновление ИИ ценности командира]
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?BG0;                                [Перед действием в бою]
** Глаз орла - выставление переменных при произнесени заклианния героем/существом
!!BG:A?y1 N?y2; !!BMy2:T?y3;          [y1/y2/y3 - тип действия/отряд/тип отряда]
!!BG|y1=1/y1=10:S?v9963;              [v9963 - номер колдующегося заклинания, если колдовство героя/монстра]
!!VRv9963&y3=91/y1=10:S43;            Orge Bloodlust
!!VRv9963&y3=13/y1=10:S38;            Archangel resurrect
!!VRv9963&y3=150/y1=10:S38;           S.Archangel resurrect
!!VRv9963&y1=10/v9963=32:S-1;         [сброс номера колдующегося заклинания Защита от воды(стихий) существами]

!?MR2;
!!BG:A?y1 N?y2; !!BMy2:T?y3;          [y1/y2/y3 - тип действия/отряд/тип отряда]
!!MR:S?y5;                            [%Y5 - проверяемое заклинание]
!!VRv9963&y1=10/y3=134:Sy5;           DM Spell
!!VRv9963&y1=10/y3=37:Sy5;            M.Genie Spell
!!VRv9963&y1=0/y3=136:Sy5;            Enchanter Spell

!?MR0;
!!BG:A?y1 N?y2;                       [y1 - тип действия, активный отряд]
!!FU&y1<>10:E;                        [выход, если не колдовство существа]
!!BMy2:T?y3;                          [y3 - тип колдующего отряда]
!!FU&y3<>134:E;                       [выход, если не колдовство ДМ]
!!MR:S?y10;                           [y10 - номер колдующегося заклинания]
!!BMy2:N?y11 H?y12 L?y13 E5;          [Параметры отряда ДМ, восстановление кол-ва заклинаний]
!!SSy10:C2/?y4;                       [y4 - стоимость заклинания на продвинутом уровне]
!!VRy13:+y4;                          [y13 - новое "потерянное здоровье"]
!!VRy11&y13>y12:-1;                   [y11 - новая численность ДМ]
!!VRy13&y13>y12:-y12;                 [y13 - новое потерянное здоровье]
!!BMy2:V51 Ny11 Ly13;                 [анимация на ДМ, новые параметры ДМ]
!!BMy2&y11<1:K100500;                 [если ДМ погиб, убиваем его]
!!SN:D;                               [обновляем поле боя]
!!VRv9963:Sy10;                       [сохранение заклинания для изучения Глазом Орла]

!?BG1;                                [после действия в бою]
** Проверка на смерть командиров
!!BMi^bh_commander_stack_1^:N?y1;                       [y1=0, если командир правого мертв...]
!!BMi^bh_commander_stack_0^:N?y2;                       [y2=0, если командир левого мертв...]
!!if|y1=0/y2=0;                       [если погиб один из командиров]
  !!FU9017:Pv9998 Pv9999;             [сброс параметров командиров]
  !!FU9056:P-10/0 P-20/1;             [отмена усиления Университета Магии]
  !!DO9002/0/69/1:Pv9998/11 Pv9999/12;[восстановление параметров, заклианний и навыков у героев, если бой завершен]
  !!DO9016/0/41/1:P;                  [отзыв отрядов]
  !!FU:E;                             [выход, если бой закончен]
!!en; 
** Глаз орла
** сброс запрещенных для изучения героем заклинаний, которые могут колдовать существа
!!VRv9963|v9963=49/v9963=50/v9963=14/v9963=11/v9963=10/v9963=57/v9963=40/v9963=36/v9963=13/v9963=30/v9963=31/v9963=33/v9963=29:S-1;
!!if&v9963>0/v9963<70;                [если колдовалось заклинание]
** левый герой
  !!HE-10:S11/?y5 Mv9963/?y6;         [y5 - уровень Глаза Орла (0..3), y6=1/0 известно/нет заклианние герою]
  !!HE-10:A2/63/?i/?y11 A2/64/?i/?y12 A2/65/?i/?y13; [y11-y13 - Птица Познания/Бесстрашный Хранитель/Символ Знаний у героя]
  !!VRy10:Sy5 *20;                    [y10 - общий показатель Орлиного глаза]
  !!SN:W^b0.1.0^/?k;                  [k - наличие Фонтана фортуны]
  !!VRy10&y10>0/k=1:+5;               [+5% за ФФ]
  !!VRy10&y11>0:+10;                  [...]
  !!VRy10&y12>0:+10;                  [...]
  !!VRy10&y13>0:+20;                  [...]
  !!if&y6=0/y10>0;                    [если заклинание еще неизвестно и есть эффект Орлиного глаза]
    !!VRy8:S1 R99;                    [y8 - случайное число 1..100]
    !!if&y8<=y10;                     [если заклинание узучено]
      !!HE-10:Mv9963/1 B0/?z1;        [добавляем его в книгу героя, z1 - имя героя]
      !!UN:N1/2/v9963;                [z2 - Название заклинания]
      !!VRz4:Sz179964;                [получаем текст сообщения для вывода в лог битвы]
      !!BU:Mz4;                       [вывод сообщения в лог битвы]
      !!UN:C6919200/4/?i;             [анимация на герое]
      !!SN:E4810128/2/i/20/0/1/0;     [...]
    !!en; 
  !!en; 
** правый герой
  !!HE-20:S11/?y5 Mv9963/?y6;         [y5 - уровень Глаза Орла (0..3), y6=1/0 известно/нет заклианние герою]
  !!HE-20:A2/63/?i/?y11 A2/64/?i/?y12 A2/65/?i/?y13; [y11-y13 - Птица Познания/Бесстрашный Хранитель/Символ Знаний у героя]
  !!VRy10:Sy5 *20;                    [y10 - общий показатель Орлиного глаза]
  !!SN:W^b1.1.0^/?k;                  [k - наличие Фонтана фортуны]
  !!VRy10&y10>0/k=1:+5;               [+5% за ФФ]
  !!VRy10&y11>0:+10;                  [...]
  !!VRy10&y12>0:+10;                  [...]
  !!VRy10&y13>0:+20;                  [...]
  !!if&y6=0/y10>0;                    [если заклинание еще неизвестно и есть эффект Орлиного глаза]
    !!VRy8:S1 R99;                    [y8 - случайное число 1..100]
    !!if&y8<=y10;                     [если заклинание узучено]
      !!HE-20:Mv9963/1 B0/?z1;        [добавляем его в книгу героя, z1 - имя героя]
      !!UN:N1/2/v9963;                [z2 - Название заклинания]
      !!VRz4:Sz179964;                [получаем текст сообщения для вывода в лог]
      !!BU:Mz4;                       [вывод сообщения в лог битвы]
      !!UN:C6919200/4/?i;             [анимация на герое]
      !!SN:E4810128/2/i/20/16/1/0;    [...]
    !!en; 
  !!en; 
  !!VRv9963:S-1;                      [обнуляем значение произнесенного заклинания]
!!en; 
!!FU9040&444:P;                       [если некромантия не проверялась, вызываем проверку]
!!DO9022/0/41/1:P;                    [обнуляем базовые количества погибших отрядов]

!?FU9003;                             [восполнение маны героя x1 стороны x2, оплата содержания Волшебниц, Чародеев и ДМ]
!!FU9047:Px1/?y1;                     [y1 - регенерация маны героя]
!!HEx1:I?i/1 Fd/d/d/?j;               [i/j - Текущая мана/Знание героя]
!!VRi:+y1;                            [i - новое значение маны без ограничения по знанию]
!!VRj:*10 +10;                        [j - предельное количество маны (10*Знание+10)]
!!VRi&i>j:Sj;                         [i - новое значение маны c учетом ограничения по Знанию]
!!HEx1:Ii/1;                          [восстановление маны герою]
!!VRy31:Sx2 *21;                      [y31 - первый отряд героя]
!!VRy32:Sy31+20;                      [y32 - последний отряд героя]
!!VRy33:Sx2*16;                       [y33 - гекс героя]
** Оплата содержания Чародеев
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P136;              [v1>0, если есть отряд Чародеев]
!!if&v1>0;                            [если есть Чародеи]
  !!VRy2:Sv1 -1;                      [y2 - номер отряда Чародеев]
  !!BMy2:N?y3;                        [y3 - текущая численность отряда Чародеев]
  !!VRy6:Sy3 +1 :2;                   [y6 - текущая стоимость отряда]
  !!HEx1:I?y5/1;                      [y5 - текущая мана героя]
  !!VRy3&y6>y5:Sy5 *2;                [y3 - численность отряда, которую герой способен оплатить]
  !!VRy6&y6>y5:Sy5;                   [y6 - стоимость содержания]
  !!BMy2&y3=0:K100500;                [если нет маны для оплаты...]
  !!BU&y3=0:R;                        [...убиваем отряд]
  !!VRy5:-y6;                         [y5 - мана героя после оплаты]
  !!HEx1:Iy5/1;                       [y5 - обновляем ману]
  !!UN:C6919200/4/?i;                 [анимация на герое]
  !!SN:E4810128/2/i/76/y33/1/0;       [...]
  !!BMy2:Ny3 L0 U3/10 V75;            [изменение численности, восполнение потерянного здоровья и анимация отряда]
!!en; 
** Оплата содержания Волшебниц
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P193;              [v1>0, если есть отряд Волшебниц]
!!if&v1>0;                            [если есть Волшебницы]
  !!VRy2:Sv1 -1;                      [y2 - номер отряда Волшебниц]
  !!BMy2:N?y3;                        [y3 - текущая численность отряда Волшебниц]
  !!VRy6:Sy3 +1 :2;                   [y6 - текущая стоимость отряда]
  !!HEx1:I?y5/1;                      [y5 - текущая мана героя]
  !!VRy3&y6>y5:Sy5 *2;                [y3 - численность отряда, которую герой способен оплатить]
  !!VRy6&y6>y5:Sy5;                   [y6 - стоимость содержания]
  !!BMy2&y3=0:K100500;                [если нет маны для оплаты...]
  !!BU&y3=0:R;                        [...убиваем отряд]
  !!VRy5:-y6;                         [y5 - мана героя после оплаты]
  !!HEx1:Iy5/1;                       [y5 - обновляем ману]
  !!UN:C6919200/4/?i;                 [анимация на герое]
  !!SN:E4810128/2/i/76/y33/1/0;       [...]
  !!BMy2:Ny3 L0 U3/10 V75;            [изменение численности, восполнение потерянного здоровья, боезапаса и анимация отряда]
!!en; 
** Оплата содержания Фанатиков
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P169;              [v1>0, если есть отряд Фанатиков]
!!if&v1>0;                            [если есть Фанатики]
  !!VRy2:Sv1 -1;                      [y2 - номер отряда Фанатиков]
  !!BMy2:N?y3;                        [y3 - текущая численность отряда Фанатиков]
  !!VRy6:Sy3 +1 :2;                   [y6 - текущая стоимость отряда]
  !!HEx1:I?y5/1;                      [y5 - текущая мана героя]
  !!VRy3&y6>y5:Sy5 *2;                [y3 - численность отряда, которую герой способен оплатить]
  !!VRy6&y6>y5:Sy5;                   [y6 - стоимость содержания]
  !!BMy2&y3=0:K100500;                [если нет маны для оплаты...]
  !!BU&y3=0:R;                        [...убиваем отряд]
  !!VRy5:-y6;                         [y5 - мана героя после оплаты]
  !!HEx1:Iy5/1;                       [y5 - обновляем ману]
  !!UN:C6919200/4/?i;                 [анимация на герое]
  !!SN:E4810128/2/i/76/y33/1/0;       [...]
  !!BMy2:Ny3 L0 U3/10 V75;            [изменение численности, восполнение потерянного здоровья, боезапаса и анимация отряда]
!!en; 
** Перекачка маны в ДМ
!!HEx1:I?y5/1;                        [y5 - текущая мана героя]
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P134;              [v1>0, если есть отряд ДМ]
!!if&v1>0/y5>0;                       [если есть ДМ и мана]
  !!VRy2:Sv1 -1;                      [y2 - номер отряда ДМ]
  !!VRy3:Sy5 *10;                     [y3 - восстанавливаемое здоровье (10*мана)]
  !!BMy2:N?y11 H?y12 L?y13 B?y14;     [y11-y13 параметры отряда ДМ]
  !!VRy11&y3>y13:+1;                  [если здоровья восполняется больше, чем потрено увеличиваем численность ДМ...]
  !!VRy14&y14<y11:Sy11;               [... и поднимаем максимальную численность]
  !!VRy13:-y3;                        [y13 - новое "потерянное здоровье"]
  !!VRy13&y13<0:+y12;                 [y13 - новое "потерянное здоровье", если численность ДМ увеличилась]
  !!HEx1:I0/1;                        [обнуляем ману героя]
  !!UN:C6919200/4/?i;                 [анимация на герое]
  !!SN:E4810128/2/i/76/y33/1/0;       [...]
  !!BMy2:Ny11 Ly13 By14 E5 V75;       [изменение численности, восполнение потерянного здоровья, заклинаний и анимация отряда]
!!en; 

!?FU9010;                             [добавление отряда x1 на поле боя, сторона x2 (0/1), количество x3, потерянное здоровье x4]
*** x5 тип призыва: 0 - вербовка, 1 - поднятие нежити, 2 - чародейский телепорт, 3 - призыв посланников,
*** 4 - Гильдия Горняков, 5 - Трансформатор Нежити, 6 - Портал Вызова, 7 - Гильдия Наемников, 8 - Грааль
** Врата Города - шанс "украсть" вражеский призыв
!!IF|x1<0/x1>196:M^DEBUG: INCORRECT CREATURE (FU9010.X1=%X1)^;
!!VRy1:Sx2 -1 *-1;                    [y1 - Вражеская сторона]
!!SN:W^b%Y1.3.0^/?y2;                 [y2 - наличие Врат Города]
!!VRy3:S0 R19;                        [шанс кражи - 5%]
!!VRy4:S0;                            [Кража не действует на Хранителей]
!!VRy4&x1>=150/x1<=158:S1;            [...]
!!if&y2=1/y3=1/x5<>1/y4=0;            [если кража произошла]
  !!VRx2:Sy1;                         [меняем сторону призыва]
  !!VRy1:Sx2 *-10 -10;                [y1 - номер героя]
    !!HEy1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179204;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
!!en; 
** Трансформатор Нежити - шанс преобразовать призываемых живых сущесв в аналогичную или более высокоуровневую нежить Некрополя
!!SN:W^b%X2.4.1^/?y1;                 [y1 - Наличие Трансформатора]
!!VRy2:S0 R3;                         [шанс трансформации - 25%]
!!MA:Xx1/?y3;                         [y3 - флаги призываемых существ]
!!VRy3:&16;                           [y3>0 для живых существ]
!!VRy4:S0;                            [Трансформация не действует на Хранителей]
!!VRy4&x1>=150/x1<=158:S1;            [...]
!!if&y1=1/y2=1/y3>0/y4=0;             [если трансформация произошла]
  !!MA:Lx1/?y5 Fx1/?y6;               [y5/y6 - уровень/FV существа]
  !!VRy7:Sy5 *2 +56 R4 +1;            [y7 - номер нового существа...]
  !!VRy7&y7>69:S69;                   [...не более Дракона-призрака]
  !!MA:Fy7/?y8;                       [y8 - FV нового существа]
  !!VRy10:Sy8 :3;                     [y10 - бонус FV - 1/3 от FV нового существа]
  !!VRy9:Sx3 *y6 +y10 :y8;            [y9 - кол-во новых существ...]
  !!VRy9&y9<1:S1;                     [...не менее 1]
  !!VRy9&y9>x3:Sx3;                   [...и не более количества трансформируемых существ]
  !!VRx1:Sy7;                         [изменяем тип призываемых существ,]
  !!VRx3:Sy9;                         [количество и]
  !!VRx5:S1;                          [тип призыва на "Поднятие Нежити"]
  !!VRy1:Sx2 *-10 -10;                [y1 - номер героя]
  !!HEy1:B0/?z7;                      [z7 - имя героя]
  !!VRz9:Sz179205;                    [z9 - строка действия]
  !!BU:Mz9;                           [вывод сообщения в лог боя]
!!en; 
**
!!VRy1:Sx2 *21;                       [y1 - первый отряд для поиска (0/21)]
!!VRy2:Sy1 +20;                       [y2 - последний отряд для поиска (20/41)]
!!VRv1:S0;                            [инизиализация v1]
!!DO9004/y1/y2/1:Px1;                 [v1>0, если есть отряд для допризыва, v1<0, если есть свободный отряд]
!!if&v1=0; 
  !!VRz1:Sz179325;                    [z1 - сообщение о неудачном призыве (нет свободного отряда)]
  !!BU:Mz1;                           [вывод сообщения в лог боя]
  !!FU:E;                             [выход, если некуда призывать или допризывать отряд]
!!en; 
!!if&v1<0;                            [Расчет позиции и призыв нового отряда]
  !!MA:Xx1/?y1;                       [y1 - флаги существа]
  !!VRy3:Sy1 &2;                      [y3>0 для летающих]
  !!VRy2:Sy1 &4;                      [y2>0 для стреляющих]
  !!VRy8:Sy1 &1;                      [y8>0 для двугексовых]
** Смещения
  !!VRy5:S0;                          [обнуление смещений]
  !!VRy6:S0;                          [...]
  !!VRy9:S0;                          [...]
  !!VRy10:S0;                         [...]
  !!VRy5&y2=0:Sx2 *-4 +2;             [y5 - смещение (+2/-2) для существ ближнего боя]
  !!VRy6&y3>0/x1<>193/x1<>196:Sx2 *-4 +2;[y6 - смещение (+2/-2) для летающих существ (кроме Волшебниц и Драколичей)]
  !!VRy9|x1=140/x1=142/x1=143/x1=144/x1=168/x1=194/x1=195:Sx2 *-6 +3;[y9 - смещение (+3/-3) для существ Гильдии Головорезов]
  !!VRy10:S0;
** Конюшни - +2 гекса ближе к врагу при призыве существ
  !!SN:W^b%X2.0.1^/?y11;              [y11 - наличие Конюшен]
  !!VRy10&y11=1/y2=0:Sx2 *-4 +2;      [y5 - смещение (+2/-2) при наличии Конюшен для не стреляющих отрядов]
  !!VRy1:Sx2 *14 +1 +y5 +y6 +y9 +y10; [y1 - базовая позиция существа 1/15 +-смещение]
  !!VRy1&x1=148:Sx2 *14 +1;           [y1 - базовая позиция для Подводы (1/15)]
  !!VRy1&x1>=145/x1<=147:Sx2 *16;     [y1 - базовая позиция для Палатки/Баллисты/Катапульты (0/16)]
  !!VRy1&x1=134:Sx2 *14 +1;           [y1 - базовая позиция для ДМ (1/15)]
  !!VRv1:S0;                          [инициализация v1]
  !!DO9015/y1/186/17:P0/x2/y8;        [v1 - количество свободных позиций (x=0)]
  !!if&v1>0;                          [если есть хоть одна свободная позиция]
    !!VRv1:-1;                        [y2 - номер свободной позиции для призыва...]
    !!VRy2:S1 Rv1;                    [...]
    !!VRv1:S0;                        [инициализация v1]
    !!DO9015/y1/186/17:Py2/x2/y8;     [v1 - y2-я свободная позиция для призыва (x>0)]
!_!IF&x5=1:L^Debug 4 BU:S%X1/%X3/%V1/%X2/-1/1^;
    !!BU:Sx1/x3/v1/x2/-1/1;           [призыв нового отряда и получение его номера в y4]
!_!IF&x5=1:L^Debug 5 SN:D^;
    !!SN:D;                           [...]
    !!BU:Ev1/?y4;                     [...]
    !!if&y4>=0; 
      !!BMy4&x4>0:Lx4;                [потерянное здоровье отряда, если указано]
      !!BA:Hx2/?y8;                   [y8 - герой]
      !!HEy8:S2/?y9;                  [y9 - уровень Логистики Героя]
      !!BMy4:Sdy9;                    [увеличиваем скорость отряда на уровень Логистики]
    !!en; 
  !!el; 
    !!VRz1:Sz179326;                  [z1 - сообщение о неудачном призыве (нет свободной позиции)]
    !!BU:Mz1;                         [вывод сообщения в лог боя]
    !!VRy4:S-1;                       [отключаем анимацию на призываемом отряде]
  !!en; 
!!el;                                 [допризыв отряда в y4]
  !!VRy4:Sv1 -1;                      [y4 - номер отряда для допризыва]
  !!MA:Bx1/?y2;                       [y2 - базовое кол-во кастов заклинателя]
  !!BMy4:H?y11 L?y12;                 [y11/y12 - макс./потер. здоровье существа]
  !!VRy13&y11>0:Sy12 +x4 %y11;        [y13 - новое потерянное здоровье]
  !!VRy14&y11>0:Sy12 +x4 :y11;        [y14 - уменьшение призываемых существ из-за "суммарного потерянного здоровья"]
  !!VRx3:-y14;                        [x3 - новое количество призываемых существ]
  !!BMy4:Bdx3 Ly13 Ndx3;              [добавление количества]
!!en; 
!!if&x5=0;                            [обычный призыв]
  !!VRz77:S^AGE^;                     [z77 - звуковой файл]
  !!VRi:S6;                           [i - анимация]
!!en; 
!!if&x5=1;                            [поднятие нежити]
  !!VRz77:S^ANIMDEAD^;                [z77 - звуковой файл]
  !!VRi:S74;                          [i - анимация]
!!en; 
!!if&x5=2;                            [чародейский телепорт]
  !!VRz77:S^ZELTDFND^;                [z77 - звуковой файл]
  !!VRi:S29;                          [i - анимация]
!!en; 
!!if&x5=3;                            [призыв посланников]
  !!VRz77:S^SUMNELM^;                 [z77 - звуковой файл]
  !!VRi:S75;                          [i - анимация]
!!en; 
!!if&x5=4;                            [Гильдия Горняков]
  !!VRz77:S^AGE^;                     [z77 - звуковой файл]
  !!VRi:S6;                           [i - анимация]
!!en; 
!!if&x5=5;                            [Трансформатор Нежити]
  !!VRz77:S^ANIMDEAD^;                [z77 - звуковой файл]
  !!VRi:S74;                          [i - анимация]
!!en; 
!!if&x5=6;                            [Портал Вызова]
  !!VRz77:S^ZELTDFND^;                [z77 - звуковой файл]
  !!VRi:S29;                          [i - анимация]
!!en; 
!!if&x5=7;                            [Гильдия Наемников]
  !!VRz77:S^AGE^;                     [z77 - звуковой файл]
  !!VRi:S6;                           [i - анимация]
!!en; 
!!if&x5=8;                            [Грааль]
  !!VRz77:S^MIRTH^;                   [z77 - звуковой файл]
  !!VRi:S20;                          [i - анимация]
!!en; 
!!SN:Pz77;                            [вывод звука]
!!BMy4&y4>=0:Vi;                      [анимация на (до)призванном отряде]
!!if&x1=148;                          [Если призывается Подвода]
  !!VRy11:Sx2 *21;                    [y11 - номер первого отряда]
  !!VRy12:Sy11 +10;                   [y12 - номер последнего отряда]
!!en; 
!!if&x1>=145/x1<=148;                 [для БМ]
  !!BMy4&y4>=0:S0 F?i;                [нулевая скорость]
  !!VRi:|4096 |65536;                 [нет штрафа в ближнем бою и безответный удар]
  !!BMy4&y4>=0:Fi;                    [обновление флагов]
!!en; 
!!if|x1=136/x1=169/x1=193;            [для Фанатиков/Волшебниц/Чародеев]
  !!BMy4&y4>=0:U3/10;                 [боезапас 10]
!!en; 
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?FU9004;                             [возвращает в v1 номер отряда подобных существ +1, или -n свободных отрядов]
!!BMx16:T?y1 N?y2 P?y3 F?y5;          [y1 - тип отряда, y2 - кол-во существ в отряде, y3 - позиция, y5 - флаги]
!!VRy5:&8388608;                      [y5>0 если отряд - клон]
!!BU:Dy3/?y4;                         [y4=-1, если нет монстров на позиции]
!!BMx16&y4=-1:N0 B0; T-1              [иногда "умирающие не умирают". добиваем принудительно, обнуляем количества]
!!VRy1&y4=-1:S-1;                     [...]
!!VRy2&y4=-1:S0;                      [...]
!!VRv1|y1<0/y2<1:-1;                  [v1--, если отряд свободен]
!!VRv1&y1=x1/y2>0/y5=0:Sx16 +1;       [v1=x16+1, если найден подобный отряд не-клон]
!!VRx16&y1=x1/y2>0/y5=0:S42;          [прерываем цикл, если найден подобный отряд]

!?FU9005;                             [ход героя x1, сторона x2]
!!HEx1:N?y10;                         [y10 - номер героя]

!!HEy10:S(SKILL_TACTICS)/?y7 O?y8;                 [y7 - Тактика героя, y8 - игрок]
!!OW:Iy8/?y9;                         [y9=0/1 человек/ИИ]
!!SN:W^b%X2.1.0^/?i;                  [i - наличие Фонтана фортуны]
!!VRi:*5;                             [i=0/5]
!!VRj:S0 R99 -i;                      [j - разброс случайных значений 0/-5...100/95]
!!VRk:S4;                             [k - базовое кол-во карт - 4]
!!VRk&y7=1/j<67:+1;                   [Шанс открытия 5 карты для Тактики равен 67/100/100% +5% за ФФ]
!!VRk&y7>1:+1;                        [Шанс открытия 5 карты для Тактики равен 67/100/100% +5% за ФФ]
!!VRk&y7=1/j<0:+1;                    [Шанс открытия 6 карты для Тактики равен 0/33/100% +5% за ФФ]
!!VRk&y7=2/j<33:+1;                   [Шанс открытия 6 карты для Тактики равен 0/33/100% +5% за ФФ]
!!VRk&y7=3:+1;                        [Шанс открытия 6 карты для Тактики равен 0/33/100% +5% за ФФ]
!!VRy7:Sk;                            [y7 - количество доступных карт (4..6)]
!!VRy7&x3>0:Sx3;                      [ограничение количества карт для выбора, если задано (напр. Карты Судьбы)]
*** Генерация и выбор действий
!!VRy41:S-1;                          [Обнуляем ценности действий для ИИ]
!!VRy42:S-1;                          [...]
!!VRy43:S-1;                          [...]
!!VRy44:S-1;                          [...]
!!VRy45:S-1;                          [...]
!!VRy46:S-1;                          [...]
!!VRz1:S^-^;                          [Обнуляем сообщения]
!!VRz2:S^-^;                          [...]
!!VRz3:S^-^;                          [...]
!!VRz4:S^-^;                          [...]
!!VRz5:S^-^;                          [...]
!!VRz6:S^-^;                          [...]
!!VRv101:C0/0/0/0/0/0;                [обнуляем контрольные числа действий]
!!VRi:Sx2 -1 *-1;                     [i - сторона оппонента]
!!BA:Hi/?y77;                         [y77 - номер героя-оппонента]

!!re m/1/6;
  !!re n/0/3;
    !!VRp:Sn *10 +m;
    !!VRyp:S-1;
  !!en;
  !!VRp:S40 +m;
  !!VRyp:S-100500;
!!en;


*!VRy1:S-1; *!VRy11:S-1; *!VRy21:S-1; *!VRy31:S-1; *!VRy41:S-100500; [инициализация параметров карт]
*!VRy2:S-1; *!VRy12:S-1; *!VRy22:S-1; *!VRy32:S-1; *!VRy42:S-100500; [...]
*!VRy3:S-1; *!VRy13:S-1; *!VRy23:S-1; *!VRy33:S-1; *!VRy43:S-100500; [...]
*!VRy4:S-1; *!VRy14:S-1; *!VRy24:S-1; *!VRy34:S-1; *!VRy44:S-100500; [...]
*!VRy5:S-1; *!VRy15:S-1; *!VRy25:S-1; *!VRy35:S-1; *!VRy45:S-100500; [...]
*!VRy6:S-1; *!VRy16:S-1; *!VRy26:S-1; *!VRy36:S-1; *!VRy46:S-100500; [...]
!!FU9006&y7>0:Px1/x2/?y1/?y11/?y21/?y31; [y1, y11, y21, y31 - тип первого действия, подтип, значение, стоимость]
!!VRz1&y7>0:Sz8;                      [z1 - Текст 1го действия, Только Человек]
!!VRv101:Sy1 *100 +y11;               [v101 - контрольное число 1го действия для контроля уникальности]
!!FU9023&y7>0/y9=1:Py1/y11/y21/y31/?y41/x1/y77/1; [y41 - ценность действия для ИИ]
!!FU9006&y7>1:Px1/x2/?y2/?y12/?y22/?y32; [y2, y12, y22, y32 - тип первого действия, подтип, значение, стоимость]
!!VRz2&y7>1:Sz8;                      [z2 - Текст 2го действия, Только Человек]
!!VRv102:Sy2 *100 +y12;               [v102 - контрольное число 2го действия для контроля уникальности]
!!FU9023&y7>1/y9=1:Py2/y12/y22/y32/?y42/x1/y77/2; [y42 - ценность действия для ИИ]
!!FU9006&y7>2:Px1/x2/?y3/?y13/?y23/?y33; [y3, y13, y23, y33 - тип первого действия, подтип, значение, стоимость]
!!VRz3&y7>2:Sz8;                      [z3 - Текст 3го действия, Только Человек]
!!VRv103:Sy3 *100 +y13;               [v103 - контрольное число 3го действия для контроля уникальности]
!!FU9023&y7>2/y9=1:Py3/y13/y23/y33/?y43/x1/y77/3; [y43 - ценность действия для ИИ]
!!FU9006&y7>3:Px1/x2/?y4/?y14/?y24/?y34; [y4, y14, y24, y34 - тип первого действия, подтип, значение, стоимость]
!!VRz4&y7>3:Sz8;                      [z4 - Текст 4го действия, Только Человек]
!!VRv104:Sy4 *100 +y14;               [v104 - контрольное число 4го действия для контроля уникальности]
!!FU9023&y7>3/y9=1:Py4/y14/y24/y34/?y44/x1/y77/4; [y44 - ценность действия для ИИ]
!!FU9006&y7>4:Px1/x2/?y5/?y15/?y25/?y35; [y5, y15, y25, y35 - тип первого действия, подтип, значение, стоимость]
!!VRz5&y7>4:Sz8;                      [z5 - Текст 5го действия, Только Человек]
!!VRv105:Sy5 *100 +y15;               [v105 - контрольное число 5го действия для контроля уникальности]
!!FU9023&y7>4/y9=1:Py5/y15/y25/y35/?y45/x1/y77/5; [y45 - ценность действия для ИИ]
!!FU9006&y7>5:Px1/x2/?y6/?y16/?y26/?y36; [y6, y16, y26, y36 - тип первого действия, подтип, значение, стоимость]
!!VRz6&y7>5:Sz8;                      [z6 - Текст 6го действия, Только Человек]
**VRv106:Sy6 *100 +y16;               [v106 - контрольное число 6го действия для контроля уникальности]
!!FU9023&y7>5/y9=1:Py6/y16/y26/y36/?y46/x1/y77/6; [y46 - ценность действия для ИИ]
!!if&y9=0;                            [вывод диалога, Только Человек]
  !!BMi^bh_commander_stack_0^|x1=-10/x1=i^battle_hero_0^:T?i;               [i - тип существа-командира]
  !!BMi^bh_commander_stack_1^|x1=-20/x1=i^battle_hero_1^:T?i;               [...]
  !!VRj|x1=-10/x1=i^battle_hero_0^:Sv9998;                [j - номер героя]
  !!VRj|x1=-20/x1=i^battle_hero_1^:Sv9999;                [...]
  *!IF:M^%j %v9998 %y10^;

  !!VRv101:Cy1/y11/y21/y31/y2/y12/y22/y32/y3/y13/y23/y33/y4/y14/y24/y34; [подготовка данных для построения диалога]
  !!VRv117:Cy5/y15/y25/y35/y6/y16/y26/y36/y7/j/i; [...]

  !!FU(BH_BattleDlg_Prepare):P;                         [отображение диалога, v1 - номер выбранного действия (1..6)]

  !!VRk:Sv1;                          [k - выбранное действие]
!!el;                                 [ИИ выбирает наиболее ценный вариант]
  !!VRk:S1;                           [v1 - номер действия с максимальной ценностью]
  !!VRy40:Sy41;                       [...]
  !!VRk&y42>y40:S2;                   [...]
  !!VRy40&y42>y40:Sy42;               [...]
  !!VRk&y43>y40:S3;                   [...]
  !!VRy40&y43>y40:Sy43;               [...]
  !!VRk&y44>y40:S4;                   [...]
  !!VRy40&y44>y40:Sy44;               [...]
  !!VRk&y45>y40:S5;                   [...]
  !!VRy40&y45>y40:Sy45;               [...]
  !!VRk&y46>y40:S6;                   [...]
  !!VRy40&y46>y40:Sy46;               [...]
!!en; 
!!VRz1:Szk;                           [z1 - текст действия]
!!VRy1:Syk;                           [y1 - тип действия]
!!VRk:+10;                            [...]
!!VRy2:Syk;                           [y2 - подтип действия]
!!VRk:+10;                            [...]
!!VRy3:Syk;                           [y3 - значение действия]
!!VRk:+10;                            [...]
!!VRy4:Syk;                           [y4 - бонус маны (отрицательное значение для штрафа)]
!!VRk:-30;                            [DEBUG]
!!IF&y9<>0/y1<1:M^DEBUG FU9005
%Vk: %Y1/%Y2/%Y3/%Y4
1: %Y1/%Y11/%Y21/%Y31 == %Y41
2: %Y2/%Y12/%Y22/%Y32 == %Y42
3: %Y3/%Y13/%Y23/%Y33 == %Y43
4: %Y4/%Y14/%Y24/%Y34 == %Y44
5: %Y5/%Y15/%Y25/%Y35 == %Y45
6: %Y6/%Y16/%Y26/%Y36 == %Y46^;       [DEBUG]
** Действие
!!VRi:S0;                             [i - тип призыва (0 - обычный)]
!!VRi|y2=136/y2=169/y2=193:S2;        [i - тип призыва (2 - чародейский телепорт)]
!!FU9010&y1=1:Py2/x2/y3/0/i;          [1. Призыв существ]
!!if&y1=2;                            [2. Изучение заклинания]
  !!HEx1:My2/1;                       [Изучение заклинания]
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!UN:C6919200/4/?i;               [анимация на герое]
    !!SN&x2=0:E4810128/2/i/6/0/1/0;   [...]
    !!SN&x2=1:E4810128/2/i/6/16/1/0;  [...]
  !!en; 
!!en; 
!!if&y1=3;                            [3. Повышение параметра героя]
  !!HEy10&y2=31:Fdy3/d/d/d;           [Атака]
  !!HEy10&y2=32:Fd/dy3/d/d;           [Защита]
  !!HEy10&y2=33:Fd/d/dy3/d;           [Сила]
  !!HEy10&y2=34:Fd/d/d/dy3;           [Знание]
  !!HEy10:F?y5/?y6/?y7/?y8;           [y5-y8 - текущие параметры героя]
  !!HEx1:Fy5/y6/y7/y8;                [Установка параметров копии героя]
  !!VRy5:S0;                          [y5 - бонус Атаки...]
  !!VRy5&y2=31:Sy3;                   [...]
  !!VRy6:S0;                          [y6 - бонус Защиты...]
  !!VRy6&y2=32:Sy3;                   [...]
  !!DO9014/0/20/1&x2=0/y2<33:Px1/y5/y6;  [Увеличение атаки/защиты стеков левого]
  !!DO9014/21/41/1&x2=1/y2<33:Px1/y5/y6; [Увеличение атаки/защиты стеков правого]
  !!if&y2=33;
    !!UN:C6919200/4/?y5;              [повышение Силы магии героя, используемой при наложени заклинания...]
    !!VRy6:Sx2 *4 +21460 +y5;         [...отдельное большое спасибо Sav'у за пример...]
    !!UN:Cy6/4/dy3;                   [...]
  !!en; 
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!UN:C6919200/4/?i;               [анимация на герое]
    !!SN&x2=0:E4810128/2/i/6/0/1/0;   [...]
    !!SN&x2=1:E4810128/2/i/6/16/1/0;  [...]
  !!en; 
!!en; 
!!if&y1=4;                            [4. Изучение вторичного навыка герою]
  !!HEy10&y2<>12:Sy2/y3;              [Изучение вторичного навыка герою]
  !!HEx1&y2<>12:Sy2/y3;               [Установка вторичного навыка копии герою]
  !!HEy10&y2=10:S20/y3 S27/y3;        [Повышение Первой помощи и Артиллерии при изучении Боевых машин(Баллистика)]
  !!HEx1&y2=10:S20/y3 S27/y3;         [... и копии герою]
  !!VRv9970&x2=0/y2=12:Sy3;           [повышение уровня Некромантии в v-переменных]
  !!VRv9971&x2=1/y2=12:Sy3;           [...]
  !!if&y2=2;                          [Если изучается Логистика]
    !!VRy11:Sx2 *21;                  [y11 - номер первого отряда]
    !!VRy12:Sy11 +10;                 [y12 - номер последнего отряда]
    !!DO9018/y11/y12/1:P1;            [Увеличение скорости всем отрядам героя при изучении Логистики]
  !!en; 
  !!if&y2=13;                         [Если изучается Поместья]
    !!VRv9980&v9980<14/x2=0:+1;       [повышение на уровень отстроенных жилищ во всех городах]
    !!VRv9981&v9981<14/x2=0:+1;       [...]
    !!VRv9982&v9982<14/x2=0:+1;       [...]
    !!VRv9983&v9983<14/x2=1:+1;       [...]
    !!VRv9984&v9984<14/x2=1:+1;       [...]
    !!VRv9985&v9985<14/x2=1:+1;       [...]
  !!en; 
  !!if&y2=5;                          [Если изучается Специализация]
    !!if&y9=0;                        [вывод диалога, Только Человек]
      !!BMi^bh_commander_stack_0^&x1=-10:T?i;           [i - тип существа-командира]
      !!BMi^bh_commander_stack_1^&x1=-20:T?i;           [...]
      !!VRj&x1=-10:Sv9998;            [j - номер героя]
      !!VRj&x1=-20:Sv9999;            [...]
      !!VRv101:C9/y3/1/0/9/y3/2/0/9/y3/3/0/9/y3/4/0; [подготовка данных для построения диалога]
      !!VRv117:C9/y3/5/0/9/y3/6/0/6/j/i;[...]
      !!FU(BH_BattleDlg_Prepare):P;                     [отображение диалога, v1 - номер выбранного действия/специализации (1..6)]
    !!el; 
      !!FU9023:P9/y3/0/0/?y41/x1/y77/1;[v1 - выбранная ИИ специализация]
      !!VRv1:Sy41;                    [...]
    !!en; 
    !!SN:W^spec_%X2^/v1;              [Установка специализации героя]

    !!VRv1:*2 +179786;                [z1 - описание действия]
    !!VRz1:Szv1;                      [...]

  !!en; 
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!UN:C6919200/4/?i;               [анимация на герое]
    !!SN&x2=0:E4810128/2/i/6/0/1/0;   [...]
    !!SN&x2=1:E4810128/2/i/6/16/1/0;  [...]
  !!en; 
!!en; 
!!if&y1=5;                            [5. Постройка здания}
  !!if&y2=9;                          [Спецстроение]
    !!VRy5:Sy3 :3;                    [y5 - город]
    !!VRy6:Sy3 %3;                    [y6 - строение]
    !!SN&y6<2:W^b%X2.%Y5.%Y6^/1;      [отстройка спец.строения]
    !!SN&y6=2:W^b%X2.%Y5.%Y6^/2;      [отстройка грааля]
  !!el; 
    !!VRy5:Sy2 %3 +9980 +x2 +x2 +x2;  [y5 - индекс v-переменной со значением отстройки фракции]
    !!VRvy5:+1;                       [отстройка следующего здания]
  !!en; 
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!UN:C6919200/4/?i;               [анимация на герое]
    !!SN&x2=0:E4810128/2/i/6/0/1/0;   [...]
    !!SN&x2=1:E4810128/2/i/6/16/1/0;  [...]
  !!en; 
!!en; 
!!if&y1=6;                            [6. Улучшение командира]
  !!HEx1:N?y5;                        [y5 - номер командира]
  !!VRy6&x2=0:Si^bh_commander_stack_0^;                 [y6 - отряд командира]
  !!VRy6&x2=1:Si^bh_commander_stack_1^;                 [...]
  !!VRy7&x2=0:S-3;                    [y7 - "сторона" командира]
  !!VRy7&x2=1:S-4;                    [...]
  !!if&y2<7;                          [Первичные параметры]
    !!COy5&y2<7:Py2/dy3;              [повышение первичного параметра командира]
    !!BMy6&y2=0:Ady3;                 [повышение атаки отряда]
    !!BMy6&y2=1:Ddy3;                 [повышение защиты отряда]
    !!BMy6&y2=2:Hdy3;                 [повышение здоровья отряда]
    !!BMy6&y2=3:U2/dy3;               [повышение макс урона отряда]
    !!COy5&y2=3:B1/2/?y8;             [y8=1, если у командира есть способность "макс. урон"]
    !!VRy3&y2=3/y8=0::2;              [y3 - прирост мин. урона вдвое меньше, если нет способности "макс. урон"]
    !!BMy6&y2=3:U1/dy3;               [повышение мин урона отряда]
    !!BMy6&y2=4:Edy3;                 [пополнение запаса заклинаний]
    !!BMy6&y2=5:Sdy3;                 [повышение скорости]
  !!en; 
  !!if&y2=7;                          [Способности]
    !!COy5&y3<>11/y3<>8:B1/y3/1;      [обучение командира способности, кроме регенерации, выносливости]
    !!SN&y3=8:W^BH.Commander%X2.Hardiness^/1; [обучение способности "Выносливость"]
    !!VRv9964&x2=0/y3=11:S1;          [повышенная регенерация]
    !!VRv9965&x2=1/y3=11:S1;          [...]
    !!BMy6:F?y8;                      [y8 - флаги отряда]
    !!BMy6&y3=2:U2/?y19 U1/y19;       [всегда максимальный урон]
    !!VRy8&y3=3:|65536;               [добавление флага безответки отряду]
    !!VRy8&y3=4:|4 |4096;             [добавление флага стрельбы и отсутствия штрафа в рукопашной отряду]
    !!VRy8&y3=6:|524288;              [добавление флага кругового удара отряду]
    !!VRy8&y3=9:|32768;               [добавление флага двойного удара отряду]
    !!BMy6:Fy8;                       [обновление флагов отряда]
    !!BMy6&y3=4:U3/24;                [для стрельбы боезапас - 24 выстрела отряду]
    !!BMy6&y3=5:R20;                  [для бесконечных ответов добавляем контрудары]
    !!BMy6&y3=7:M29/1/2;              [наложение огненного щита]
  !!en; 
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!VRz77:S^AGE^;                   [z1 - звуковой файл]
    !!SN:Pz77;                        [вывод звука]
    !!BMy6:V6;                        [анимация на отряде командира]
  !!en; 
!!en; 
!!if&y1=7;                            [7. Помощь Гильдии Некромантов]
  !!VRv7910:C0/0/0/0/0/0/0/0/0/0;     [сброс "помеченной группы"]
  !!VRz77:S^DEVLKILL^;                [z77 - звуковой файл смерти]
  !!if&y2=1;                          [Некроманты. Реанимация Драколича]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!DO9020/y11/y12/1:P1/1/0;        [v1 - количество здоровья "живых" отрядов у героя, принесение  в жертву]
    !!SN:Pz77;                        [звук жертвы]
    !!SN:E5925584/2/v7920/?v7910/51/1;[анимация жертвы (с уроном) на помеченной группе]
    !!SN:D;                           [обновление поля боя]
    !!MA:P196/?y5;                    [y5 - здоровье Драколича]
    !!VRy6:Sy3 :y5;                   [y6 - Количество восстанавливаемых Драколичей]
    !!VRy7:Sy3 %y5;                   [...]
    !!VRy6&y7>0:+1;                   [...]
    !!VRy7:-y5 *-1;                   [y7 - "потерянное здоровье" последнего отряда]
    !!FU9010:P196/x2/y6/y7/1;         [призыв Драколича]
  !!en; 
  !!if&y2=2;                          [Некроманты. Зомбирование.]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!DO9020/y11/y12/1:P1/2/0;        [v1 - количество "живых" существ у героя, принесение в жертву]
!_!IF:L^Debug 0 SN:P%Z77^;
    !!SN:Pz77;                        [звук жертвы]
!_!IF:L^Debug 1 SN:E5925584/2/%V7920/?v7910/51/1^;
    !!SN:E5925584/2/v7920/?v7910/51/1;[анимация жертвы (с уроном) на помеченной группе]
!_!IF:L^Debug 2 SN:D, v7910=%V7910^;
    !!SN:D;                           [обновление поля боя]
!_!IF:L^Debug 3 FU9010^;
    !!FU9010:P59/x2/y3/0/1;           [призыв Зомби]
  !!en; 
  !!if&y2=3;                          [Некроманты. Обмен душ]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!DO9020/y11/y12/1:P1/2/0;        [v1 - количество "живых" существ у героя, принесение в жертву]
!_!IF:L^Debug 0 SN:P%Z77^;
    !!SN:Pz77;                        [звук жертвы]
!_!IF:L^Debug 1 SN:E5925584/2/%V7920/?v7910/51/1^;
    !!SN:E5925584/2/v7920/?v7910/51/1;[анимация жертвы (с уроном) на помеченной группе]
!_!IF:L^Debug 2 SN:D, v7910=%V7910^;
    !!SN:D;                           [обновление поля боя]
!_!IF:L^Debug 3 FU9010^;
    !!FU9010:P159/x2/y3/0/1;          [призыв Привидений]
  !!en; 
  !!if&y2=4;                          [Некроманты. Мумификация]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!DO9020/y11/y12/1:P1/2/0;        [v1 - количество "живых" существ у героя, принесение в жертву]
!_!IF:L^Debug 0 SN:P%Z77^;
    !!SN:Pz77;                        [звук жертвы]
!_!IF:L^Debug 1 SN:E5925584/2/%V7920/?v7910/51/1^;
    !!SN:E5925584/2/v7920/?v7910/51/1;[анимация жертвы (с уроном) на помеченной группе]
!_!IF:L^Debug 2 SN:D, v7910=%V7910^;
    !!SN:D;                           [обновление поля боя]
!_!IF:L^Debug 3 FU9010^;
    !!FU9010:P141/x2/y3/0/1;          [призыв Мумий]
  !!en; 
  !!if&y2=5;                          [Некроманты. Воплощение кошмаров]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!DO9020/y11/y12/1:P1/1/0;        [v1 - количество здоровья "живых" отрядов у героя, принесение  в жертву]
    !!SN:Pz77;                        [звук жертвы]
    !!SN:E5925584/2/v7920/?v7910/51/1;[анимация жертвы (с уроном) на помеченной группе]
    !!SN:D;                           [обновление поля боя]
    !!MA:P172/?y5;                    [y5 - здоровье Кошмара]
    !!VRy6:Sy3 :y5;                   [y6 - Количество восстанавливаемых Кошмаров]
    !!VRy7:Sy3 %y5;                   [...]
    !!VRy6&y7>0:+1;                   [...]
    !!VRy7:-y5 *-1;                   [y7 - "потерянное здоровье" последнего отряда]
    !!FU9010:P172/x2/y6/y7/1;         [призыв Кошмаров]
  !!en; 
!!en; 
!!if&y1=8;                            [8. Помощь Гильдии Чародеев]
  !!if&y2=1;                          [Карты Судьбы]
    !!if|y9=0/v7909=0/v7909=1;        [если не запрещен вывод информации о действиях ИИ]
      !!HEx1:B0/?z8;                  [z8 - имя героя]
      !!VRz9:Sz179967;                [z9 - сообщение в лог]
      !!BU:Mz9;                       [вывод сообщения]
    !!en; 
    !!HEx1:Idy4/1;                    [уменьшение маны героя]
    !!VRy4:S0;                        [обнуление стоимости]
    !!DO9048/1/5/1:Px1/x2/y3;         [5 карт судьбы с шансом открытия y3%]
  !!en; 
  !!if&y2=2;                          [Перекачка маны]
    !!VRi:Sx2 *-1 +1;                 [i - противоположная сторона]
    !!BA:Hi/?j;                       [j - вражеский герой]
    !!VRi:Sy3 *-1;                    [i - штраф маны вражеского героя]
    !!HEx1:Idy3/1;                    [прибавление маны герою]
    !!HEj:Idi/1;                      [убавление маны вражескому герою]
    !!UN:C6919200/4/?i;               [анимация на героях]
    !!SN&x2=0:E4810128/2/i/76/16/1/0 E4810128/2/i/75/0/1/0; [...]
    !!SN&x2=1:E4810128/2/i/76/0/1/0 E4810128/2/i/75/16/1/0; [...]
  !!en; 
  !!if&y2=3;                          [Создание ДМ]
    !!MA:P134/?y5;                    [y5 - здоровье ДМ]
    !!VRy6:Sy3 :y5;                   [y6 - Количество восстанавливаемых ДМ]
    !!VRy7:Sy3 %y5;                   [...]
    !!VRy6&y7>0:+1;                   [...]
    !!VRy7:-y5 *-1;                   [y7 - "потерянное здоровье" последнего отряда]
    !!FU9010:P134/x2/y6/y7/2;         [призыв ДМ]
  !!en; 
!!en; 
!!if&y1=10;                           [10. Магия командиров]
  !!HEx1:N?y5;                        [y5 - номер командира]
  !!COy5:P4/?y7 P4/d1;                [получение номера слота и увеличение силы]
  !!SN:W^Cmndr%X2Sp%Y7^/y2;           [запись заклинания в слот]
  !!COy5&y3>1:P4/?y7 P4/d1;           [получение номера слота и увеличение силы при удвоенном обучении]
  !!SN&y3>1:W^Cmndr%X2Sp%Y7^/y2;      [запись заклинания в слот при удвоенном обучении]
  !!VRy6&x2=0:Si^bh_commander_stack_0^;                 [y6 - отряд командира]
  !!VRy6&x2=1:Si^bh_commander_stack_1^;                 [...]
  !!BMy6:E0;                          [обнуление количества заклинаний]
  !!if|y9=0/v7909=0/v7909=1;          [если не запрещен вывод информации о действиях ИИ]
    !!VRz77:S^AGE^;                   [z1 - звуковой файл]
    !!SN:Pz77;                        [вывод звука]
    !!BMy6:V6;                        [анимация на отряде командира]
  !!en; 
!!en; 
!!HEx1&y4<>0:Idy4/1;                  [уменьшение маны героя, если действие не бесплатное]
** Сообщение в лог битвы и обновление поля боя
!!if|y9=0/v7909=0/v7909=1;            [если не запрещен вывод информации о действиях ИИ]
  !!HEx1:B0/?z8;                      [z8 - имя героя]
  !!VRz9:Sz179967;                     [z9 - сообщение в лог]
  !!BU|y1<>8/y2<>1:Mz9;               [вывод сообщения, кроме Карт Судьбы]
!!en; 
*!SN&v997>0:D;                        [обновление поля боя - Disable for now as it results in crash]

!?FU9006;                             [выбор действия герою x1, сторона x2. Возврат: x3 - тип, x4 - подтип, x5 - значение, z8 - текст действия]
!!VRy1:S1 T99 R1/y1;                  [инициализация ГСЧ]
!!DO9008/1/250/1:Px1/x2/?y3/?y4/?y5/?y6;  [250 попыток подобрать действие]
!!VRz8&y3=0:S^DEBUG-9006: No Action!^;[Название действия после 250 неудачных попыток подбора]
!!VRx3:Sy3;
!!VRx4:Sy4;
!!VRx5:Sy5;
!!VRx6:Sy6;

!?FU9008;                             [подбор карты герою x1, сторона x2. Возврат: x3 - тип, x4 - подтип, x5 - значение, x6 - бонус/-штраф маны, z8 - текст действия]
!!VRx3:S0;                            [по типа карты нет]
!!VRy1:S1 R5;                         [y1 - категория карт (1..6)]
!!VRy1&y1=5:S7;                       [Одна категория пополам для ПП Героя и отстройки зданий]
!!VRi:S0 R1;                          [...]
!!VRy1&y1=3/i=1:S5;                   [...]
*** Специализация
!!HEx1:S5/?y2;                        [y2 - уровень специализации героя]
!!SN:W^b%X2.1.0^/?i;                  [i - наличие Фонтана фортуны]
!!VRy2&y2>0/i>0:+1;                   [+1 к уровню специализации за ФФ, если специализация есть]
!!VRy3:S0 R15;                        [y3 = 0..15]
!!if&y2>y3;                           [если специализация сработала (6,25% на карту за уровень навыка и ФФ)]
  !!SN:W^spec_%X2^/?y4;               [y4 - тип специализации]
  !!VRy1&y4=1:S1;                     [установка новой категории карт]
  !!VRy1&y4=2:S2;                     [...]
  !!VRy1&y4=3:S3 R1;                  [...]
  !!VRy1&y4=4:S5;                     [...]
  !!VRy1&y4=5:S6;                     [...]
  !!VRy1&y4=6:S7;                     [...]
!!en; 
*** 1. Призыв существ
!!if&y1=1;                            [1. Призыв существ]
  !!HEx1:B2/?y2;                      [y2 - класс героя (0..17)]
  !!VRy2::6 *3 R2;                    [y2 - Замок для призыва (один из 3х дружественной фракции) (0..8)]
  !!VRy15:Sy2 %3;                     [y15 - номер расы для призыва (0..2)]
  !!VRy16:Sx2 *3 +9980 +y15;          [y16 - индекс v-переменной, с отстройкой для расы]
  !!VRy17:Svy16 -1 :2 +1;             [y17 - макс. отстроенный уровень существ выбранной расы (1..7)]
  !!VRy18:S1;                         [y18 - мин. уровень существа для призыва...]
  !!VRy18&y17>3:Sy17 -2;              [...N-2, но не меньше 1]
  !!VRy19:Sy17 -y18;                  [y19 - разброс для случайного выбора]
  !!VRy5:Sy18 Ry19 -1;                [y5 - призываемый уровень (N-2..N)]
  !!VRy6:Sy5 *2 +2;                   [y6 - номер улучшенного жилища призываемого существа]
  !!VRy6&y6<=vy16:S1;                 [y6=1, если отстроены улучшенные существа]
  !!VRy6&y6>vy16:S0;                  [y6=0, если НЕ отстроены улучшенные существа]
  !!FU9011:Py2/y5/y6/?y8;             [y8 - номер призываемого существа]
  !!VRy11:Sx2 *21;                    [y11 - первый отряд для поиска (0/21)]
  !!VRy12:Sy11 +20;                   [y12 - последний отряд для поиска (20/41)]
  !!VRv1:S0;                          [инизиализация v1]
  !!DO9004/y11/y12/1:Py6;             [v1>0, если есть отряд для (до)призыва]
  !!if&v1<>0;                         [если существо есть куда призывать]
    !!HEx1:S6/?y9;                    [y9 - уровень лидерства Героя]
    !!HEx1:A2/45/d/?i;                [i - активный Застывший Глаз Дракона]
    !!VRy9&i>0:+1;                    [+1 к Вербовке за Застывший Глаз Дракона]
    !!HEx1:A2/49/d/?i;                [i - активный Значок Смелости]
    !!VRy9&i>0:+1;                    [+1 к Вербовке за Значок Смелости]
    !!HEx1:A2/50/d/?i;                [i - активный Герб Доблести]
    !!VRy9&i>0:+1;                    [+1 к Вербовке за Герб Доблести]
    !!HEx1:A2/51/d/?i;                [i - активный Знак Отваги]
    !!VRy9&i>0:+1;                    [+1 к Вербовке за Знак Отваги]
    !!HEx1:A2/108/d/?i;               [i - активный Брелок Смелости]
    !!VRy9&i>0:+3;                    [+3 к Вербовке за Брелок Смелости]
    !!HE-10:A2/84/d/?i;               [i - активный Дух Уныния у атакующего героя]
    !!HE-20:A2/84/d/?j;               [j - активный Дух Уныния у атакующего героя]
    !!VRy9|i>0/j>0:S0;                [активный Дух Уныния подавляет навык Вербовка и действие артефактов усиливающих численность призыва]
    !!VRi&x2=0:Sv9980 +v9981 +v9982;  [i - количество отстроенных зданий]
    !!VRi&x2=1:Sv9983 +v9984 +v9985;  [...]
    !!VRi:*2;                         [2% к FV призыва за каждое отстроенное здание]
    !!VRk:S150 +y2;                   [k - номер существа-Хранителя]
    !!FU9060:Pk/x2;                   [v1 - наличие Хранителя в армии]
    !!VRy9&v1>=0:+5;                  [Бонус призыва Хранителя - 5]
    !!VRy9:*10 +100 +i;               [y9 - множитель призыва 100% +10% за уровень Лидерства +2% за здание]
    !!MA:Fy8/?y10 Ly8/?y12;           [y10 - FV существа, y12 - уровень]
    !!VRy11&y6=0:Sy5 +1 *1600 *y9 :100; [Базовое FV отряда - 1500*уровень существа*множитель (для degrade)...]
    !!VRy11&y6=1:Sy5 +1 *1800 *y9 :100; [Базовое FV отряда - 1700*уровень существа*множитель (для upgrade)...]
    !!VRy7&y10>0:Sy11 :y10;           [y7 - количество призываемых существ]
    !!HEx1:A2/118/?i/?y20 A2/119/?i/?y21 A2/120/?i/?y22 A2/121/?i/?y23 A2/122/?i/?y24 A2/133/?i/?y25; [y20/y25 - артефакты Легиона]
    !!VRy20:*10;                       [бонус прироста с учетом количества одетых артефактов]
    !!VRy21:*8;                       [...]
    !!VRy22:*6;                       [...]
    !!VRy23:*4;                       [...]
    !!VRy7&y12=1/y20>0:+y20;          [+10 к призыву 2го уровня за каждый одетый артефакт Ноги Легиона]
    !!VRy7&y12=2/y21>0:+y21;          [+8 к призыву 3го уровня за каждый одетый артефакт Поясница Легиона]
    !!VRy7&y12=3/y22>0:+y22;          [+6 к призыву 4го уровня за каждый одетый артефакт Торс Легиона]
    !!VRy7&y12=4/y23>0:+y23;          [+4 к призыву 5го уровня за каждый одетый артефакт Руки Легиона]
    !!VRy7&y12=5/y24>0:+y24;          [+2 к призыву 6го уровня за каждый одетый артефакт Голова Легиона]
    !!VRy7&y25>0:*3 :2;               [+50% к призыву, если одета Статуя Легиона]
    !!UN:N3/9/y8/1;                   [z9 - Имя существ, множ]
    !!VRz8:Sz179998;                  [z8 - строка действия]
    !!VRx3:S1;                        [возврат типа действия: 1]
    !!VRx4:Sy8;                       [возврат подтипа действия]
    !!VRx5:Sy7;                       [возврат значения действия]
    !!VRx6:S0;                        [возврат бонуса маны]
  !!en; 
!!en; 
*** 2. Изучение заклинания
!!if&y1=2;                            [2. Изучение заклинания]
  !!HEx1:S7/?y2;                      [y2 - Уровень мудрости героя]
  !!VRy2:+1;                          [y2 - макс. доступный для изучения уровень заклинания (1..4)]
  !!VRy3:S1 Ry2;                      [y3 - случ. уровень изучаемого заклинания (1..5)]
  !!VRv1:S0;                          [обнуление v1]
  !!DO9013/10/69/1:Px1/y3/0;          [v1 - количество неизученны боевых заклианний нужного уровня героем]
  !!if&v1>0;                          [если есть хоть одно неизученое заклинание нужного уровня]
    !!VRv1:-1;
    !!VRy2:S1 Rv1;                    [y2 - порядковый номер изучаемого неизученного заклинания нужного уровня]
    !!VRv1:S0;                        [обнуление v1]
    !!DO9013/10/69/1:Px1/y3/y2;       [v1 - номер изучаемого заклинания]
    !!UN:N1/9/v1;                     [z9 - Название заклинания]
    !!VRz8:Sz179997;                  [z8 - строка действия]
    !!VRx3:S2;                        [возврат типа действия: 2]
    !!VRx4:Sv1;                       [возврат подтипа действия]
    !!VRx5:S0;                        [возврат значения действия]
    !!VRx6:S0;                        [возврат бонуса маны]
  !!en; 
!!en; 
*** 3. Повышение параметра героя
!!if&y1=3;                            [3. Повышение параметра героя]
  !!VRx3:S3;                          [возврат типа действия: 3]
  !!VRy2:S31 R6; !!VRy2&y2>34:-4;     [y2 - параметр для повышения (31..34=ADSK), шансы выпадения ~28,5/28,5/28,5/14,5%]
  !!HEx1:F?y5/?y6/?y7/?y8;            [y3 - уровень навыка Обучения героя (0..3), y5-8 - первичные параметры]
  !!VRx3&y2=31/y5>24:S0;              [отмена действия, если...]
  !!VRx3&y2=32/y6>24:S0;              [...достигнут предел...]
  !!VRx3&y2=33/y7>24:S0;              [...развития первичного...]
  !!VRx3&y2=34/y8>24:S0;              [... параметра героя (25)]
  !!if&x3=3; 
    !!VRy4:S1;                        [y4 - базовый прирост первичного навыка]
    !!HEx1:S21/?y3;                   [y3 - Обучение героя (0..3)]
    !!SN:W^b%X2.1.0^/?k;              [k - наличие Фонтана фортуны]
    !!VRk:R1 :2;                      [k=0/1 если есть ФФ]
    !!VRi:S1 R9 -k;                   [i - случайное число (1..10 -0/1 за ФФ)]
    !!VRy4&i<=y3:S2;                  [y4 - удвоенный бонус, если Обучение сработало (шанс 10/20/30%)]
    !!VRy4&y2=31/y5=24:S1;            [одинарный бонус, если двойной...]
    !!VRy4&y2=32/y6=24:S1;            [...превысит предел...]
    !!VRy4&y2=33/y7=24:S1;            [...развития первичного...]
    !!VRy4&y2=34/y8=24:S1;            [... параметра героя (25)]
    !!VRz8&y2=31:Sz179996;            [z8 - строка действия]
    !!VRz8&y2=32:Sz179995;            [z8 - строка действия]
    !!VRz8&y2=33:Sz179994;            [z8 - строка действия]
    !!VRz8&y2=34:Sz179993;            [z8 - строка действия]
    !!VRx4:Sy2;                       [возврат подтипа действия]
    !!VRx5:Sy4;                       [возврат значения действия]
    !!VRx6:S0;                        [возврат бонуса маны]
  !!en; 
!!en; 
*** 4. Изучение вторичного навыка герою
!!if&y1=4;                            [4. Изучение вторичного навыка герою]
  !!VRy2:S0 R23;                      [y2 - навык для повышения (0.27)]
  !!VRy2&y2=0:S25;                    [Поиск Пути -> Волшебство]
  !!VRy2&y2=3:S24;                    [Разведка -> Интеллект]
  !!VRy2&y2=20:S26;                   [Артиллерия -> Сопротивление]
  !!HEx1:Sy2/?y3;                     [y3 - текущий уровень навыка героя]
  !!VRy3&y2=12/x2=0:Sv9970;           [для Некромантии актуальный уровень навыка в v-переменной]
  !!VRy3&y2=12/x2=1:Sv9971;           [...]
  !!VRy3&y2=13/x2=0/v9980=14/v9981=14/v9982=14:S3; [считаем уровень Поместий максимальным, если все жилища уже отстроены]
  !!VRy3&y2=13/x2=1/v9983=14/v9984=14/v9985=14:S3; [...]
  !!if&y3<3;                          [если навык не раскачан]
    !!VRx3:S4;                        [возврат типа действия: 4]
    !!VRx4:Sy2;                       [возврат подтипа действия]
    !!VRx5:Sy3 +1;                    [возврат значения действия]
    !!VRx6:S0;                        [возврат бонуса маны]
    !!UN:N4/9/y2;                     [z9 - Имя навыка]
    !!VRz10&y3=0:Sz179990;            [z10 - Уровень навыка (Базовый)]
    !!VRz10&y3=1:Sz179989;            [z10 - Уровень навыка (Продвинутый)]
    !!VRz10&y3=2:Sz179988;            [z10 - Уровень навыка (Эксперт)]
    !!VRz8:Sz179991;                  [z8 - строка действия]
  !!en; 
!!en; 
*** 5. Постройка здания
!!if&y1=5;                            [5. Постройка здания]
  !!HEx1:B2/?y2;                      [y2 - класс героя]
  !!VRy2::6 *3 R2;                    [y2 - Замок для отстройки (один из 3х дружественной фракции)]
  !!VRy3:S0 R6;                       [шанс замены жилища на спец. строение 1/7]
  !!if&y3=1;                          [Спецстроение]
    !!VRy4:S0 R1;                     [y4 -номер строения]
    !!SN:W^b%X2.%Y2.%Y4^/?y5;         [y5 - наличие строения]
    !!SN:W^b%X2.%Y2.0^/?y6;           [y6 - наличие 1го строения]
    !!SN:W^b%X2.%Y2.1^/?y7;           [y7 - наличие 2го строения]
    !!SN:W^b%X2.%Y2.2^/?y8;           [y8 - наличие 3го строения]
    !!VRy4&y6>0/y7>0:S2;              [если оба расовых строения уже есть...]
    !!VRy5&y6>0/y7>0:Sy8;             [...предлагаем грааль]
    !!if&y5=0;                        [если строения еще нет]
      !!VRy6:Sy2 *3 +y4;              [y6 - сквозной номер строения (0..26)]
      !!VRy7:S179208 +y6 -y2;         [y7 - индекс ert-переменной]
      !!VRy7&y4=2:S179279 +y2;        [y7 - индекс ert-переменной для граалей]
      !!VRz8:Szy7;                    [z8 - строка действия]
      !!VRx3:S5;                      [возврат типа действия: 5]
      !!VRx4:S9;                      [возврат подтипа действия: 9]
      !!VRx5:Sy6;                     [возврат значения действия]
      !!VRx6:S0;                      [возврат бонуса маны]
    !!en; 
  !!el; 
    !!VRy15:Sy2 %3;                     [y15 - номер расы для отстройки]
    !!VRy16:Sx2 *3 +9980 +y15;          [y16 - индекс v-переменной, с отстройкой для расы]
    !!if&vy16<14;                       [если есть хоть одно непостроенное жилище расы]
      !!VRy3:Svy16 %2 *7;               [y3 = 0/7 - улучшенное/неулучшенное жилище для отстройки]
      !!VRy5:Svy16 :2;                  [y5 уровень жилища для отстройки (0..6)]
      !!VRy4:S30 +y5 +y3;               [y4 - номер жилища для отстройки]
      !!UN:N2/9/y2/y4;                  [z9 - Название здания]
      !!VRz8:Sz179987;                  [z8 - строка действия]
      !!VRx3:S5;                        [возврат типа действия: 5]
      !!VRx4:Sy2;                       [возврат подтипа действия]
      !!VRx5:Sy4;                       [возврат значения действия]
      !!VRx6:S0;                        [возврат бонуса маны]
    !!en; 
  !!en; 
!!en; 
*** 6. Улучшение командира (параметр/способность) (x1=6, x2=0-6/7 параметр/способность, x3 - прирост параметра/номер способности)
!!if&y1=6;                            [6. Улучшение командира]
  !!VRy2:S0 R7;                       [y2=0-6/7 параметр/способность]
  !!HEx1:N?y7;                        [y7 - номер командира]
  !!if&y2<7;                          [повышение параметра]
    !!VRy3|y2=0/y2=1:S4;              [y3 - базовые значения прироста для атаки/защиты = 4 ...]
    !!VRy3|y2=3:S8;                   [для урона = 8 ...]
    !!VRy3|y2=2:S250;                 [для здоровья = 250 (увеличение максимума и лечение) ...]
    !!VRy3|y2=4:S1;                   [для силы магии = 1 (увеличение силы и получение доп. заклинаний) ...]
    !!VRy3|y2=5:S1;                   [для скорости = 1 ...]
    !!VRy3|y2=6:S10;                  [для сопротивления = 10]
    !!VRy4|y2=0/y2=1:S50;             [y4 - предельные значения для атаки/защиты = 50 ...]
    !!VRy4|y2=3:S50;                  [для урона = 50 ...]
    !!VRy4|y2=2:S10000;               [для здоровья = 10000 ...]
    !!VRy4|y2=4:S10;                  [для силы магии = 10 ...]
    !!VRy4|y2=5:S10;                  [для скорости = 10 ...]
    !!VRy4|y2=6:S100;                 [для сопротивления = 100]
    !!COy7:Py2/?y5;                   [y5 - текущее значение параметра]
    !!VRy5:+y3;                       [y5 - новое значение параметра]
    !!if&y5<=y4;                      [если повышение параметра (без бонуса) не превышает порог, возвращаем параметры действия]
      !!HEx1:S18/?y6;                 [y6 - Наставник (0..3)]
      !!SN:W^b%X2.1.0^/?k;            [k - наличие Фонтана фортуны]
      !!VRk:R1 :2;                    [k=0/1 если есть ФФ]
      !!VRi:S1 R9 -k;                 [i - случайное число (1..10 -0/1 за ФФ)]
      !!VRy5:+y3;                     [y5 - новое значение параметра с удвоенным бонусом]
      !!VRy3&i<=y6/y5<=y4:*2;         [y3 - удвоенный бонус, если "Наставник" сработал (шанс 10/20/30%) и порог не будет превышен]
      !!VRy6:S179986 -y2;             [y6 - индекс z-переменной из ert-файла]
      !!VRz8:Szy6;                    [z8 - строка действия]
      !!VRx3:S6;                      [возврат типа действия: 6]
      !!VRx4:Sy2;                     [возврат подтипа действия]
      !!VRx5:Sy3;                     [возврат значения действия]
      !!VRx6:S0;                      [возврат бонуса маны]
      !!if&y2=4;                      [для изучения заклинания командиром переопределяем тип и подтип действия]
        !!VRx3:S10;                   [возврат типа действия: 10]
        !!COy7:T?y11 P4/?y12;         [y11/y12 - тип/сила командира]
        !!VRy13:S3;                   [y13 - количество заклинаний для выбора -1 ]
        !!VRy13&y12>1:S7;             [...]
        !!VRy13&y12>3:S10;            [...]
        !!VRy13&y12>5:S12;            [...]
        !!VRy14:S0 Ry13;              [y14 - порядковый номер заклинания для класса]
        !!VRx4&y14=0:S15;             [0 (все)         - Волшебная стрела]
        !!VRx4&y11=0/y14=1:S27;       [1 (паладин)     - Щит]
        !!VRx4&y11=4/y14=1:S45;       [1 (пожиратель)  - Слабость]
        !!VRx4&y11=8/y14=1:S46;       [1 (астрал)      - Камнекожа]
        !!VRx4&y11=0/y14=2:S51;       [2 (паладин)     - Удача]
        !!VRx4&y11=4/y14=2:S43;       [2 (пожиратель)  - Кровожадность]
        !!VRx4&y11=8/y14=2:S52;       [2 (астрал)      - Неудача]
        !!VRx4&y11=0/y14=3:S28;       [3 (паладин)     - Возд.щит]
        !!VRx4&y11=4/y14=3:S61;       [3 (пожиратель)  - Забывчивость]
        !!VRx4&y11=8/y14=3:S44;       [3 (астрал)      - Точность]
        !!VRx4&y14=4:S16;             [4 (все)         - Ледяная молния]
        !!VRx4&y11=0/y14=5:S37;       [5 (паладин)     - Лечение]
        !!VRx4&y11=4/y14=5:S56;       [5 (пожиратель)  - Бешенство]
        !!VRx4&y11=8/y14=5:S64;       [5 (астрал)      - Перезарядка]
        !!VRx4&y11=0/y14=6:S53;       [6 (паладин)     - Ускорение]
        !!VRx4&y11=4/y14=6:S55;       [6 (пожиратель)  - Палач]
        !!VRx4&y11=8/y14=6:S29;       [6 (астрал)      - Огненный щит]
        !!VRx4&y11=0/y14=7:S69;       [7 (паладин)     - Призыв: Воздух]
        !!VRx4&y11=4/y14=7:S39;       [7 (пожиратель)  - Поднятие нежити]
        !!VRx4&y11=8/y14=7:S68;       [7 (астрал)      - Призыв: Вода]
        !!VRx4&y14=8:S17;             [8 (все)         - Удар молнии]
        !!VRx4&y11=0/y14=9:S41;       [9 (паладин)     - Благословение]
        !!VRx4&y11=4/y14=9:S42;       [9 (пожиратель)  - Проклятье]
        !!VRx4&y11=8/y14=9:S62;       [9 (астрал)      - Слепота]
        !!VRx4&y11=0/y14=10:S38;      [10 (паладин)    - Воскрешение]
        !!VRx4&y11=4/y14=10:S66;      [10 (пожиратель) - Призыв: Огонь]
        !!VRx4&y11=8/y14=10:S65;      [10 (астрал)     - Клон]
        !!VRx4&y11=0/y14=11:S34;      [11 (паладин)    - Антимагия]
        !!VRx4&y11=4/y14=11:S47;      [11 (пожиратель) - Разрушение]
        !!VRx4&y11=8/y14=11:S67;      [11 (астрал)     - Призыв: Земля]
        !!VRx4&y11=0/y14=12:S48;      [12 (паладин)    - Молитва]
        !!VRx4&y11=4/y14=12:S60;      [12 (пожиратель) - Гипноз]
        !!VRx4&y11=8/y14=12:S18;      [12 (астрал)     - Взрыв]
      !!en; 
    !!el;                             [если предел параметра достигнут]
      !!VRy2:S7;                      [попытка получить способность]
    !!en; 
  !!en; 
  !!if&y2=7;                          [получение способности 0-14 (кроме паралича,смертельного взгляда, полета, страха и кавалерийского бонуса - 10,12,14,1 и 13)]
    !!VRy3:S0 R9;                     [y3 - способность командира..]
    !!VRy6:S179979 -y3;               [y6 - индекс z-переменной из ert-файла]
    !!VRy3&y3=1:S11;                  [страх(1) меняем на регеренацию (11)]
    !!COy7:B1/y3/?y4;                 [y4=1, если способность уже есть]
    !!VRy4&y3=11/x2=0:Sv9964;         [...]
    !!VRy4&y3=11/x2=1:Sv9965;         [...]
    !!SN&y3=8:W^BH.Commander%X2.Hardiness^/?y4; [получить значение способности «Выносливость»]
    !!if&y4=0;                        [если способность еще не изучена]
      !!VRz8:Szy6;                    [z8 - строка действия]
      !!VRx3:S6;                      [возврат типа действия: 6]
      !!VRx4:Sy2;                     [возврат подтипа действия]
      !!VRx5:Sy3;                     [возврат значения действия]
      !!VRx6:S0;                      [возврат бонуса маны]
    !!en; 
  !!en; 
!!en; 
*** 7. Помощь гильдии
!!if&y1=7;                            [7. Помощь гильдии]
  !!HEx1:S4/?y2;                      [y2 - текущий уровень Дипломатии героя]
  !!VRy2&v997<30/y2>2:S2;             [запрет использования Экспертной Дипломатии до 30го раунда]
  !!VRy2&v997<15/y2>1:S1;             [запрет использования Продвинутой Дипломатии до 15го раунда]
  !!VRy3:S0 R4;                       [y3 - Гильдия 0-3(Кузнецы, Головорезы, Чародеи, Некроманты, Стрелки)]
  !!VRy4:S0 R9;                       [y4 - действие гильдии (0-9)]
  !!HEx1:A2/66/?i/?y20 A2/67/?i/?y21 A2/68/?i/?y22; [y20/y22 - Артефакты Дипломата]
  !!VRy20:+y21 +y22 *20 -100 *-1;     [y20 - стоимость услуг Гильдий -20% за каждый надетый артефакт Дипломата]
  !!if&y3=0;                          [Кузнецы - создать Подводу/Палатку/Баллисту/Отряд големов]
** y5 - номер призываемого существа
    !!VRy5&y2=0/y4>=0/y4<=2:S148;     [0:30% Подвода]
    !!VRy5&y2=0/y4>=3/y4<=5:S147;     [0:30% Палатка]
    !!VRy5&y2=0/y4>=6/y4<=7:S146;     [0:20% Баллиста]
    !!VRy5&y2=0/y4>=8/y4<=9:S145;     [0:20% Катапульта]
    !!VRy5&y2=1/y4>=0/y4<=1:S148;     [1:20% Подвода]
    !!VRy5&y2=1/y4>=2/y4<=4:S147;     [1:30% Палатка]
    !!VRy5&y2=1/y4>=5/y4<=6:S146;     [1:20% Баллиста]
    !!VRy5&y2=1/y4>=7/y4<=8:S145;     [1:20% Катапульта]
    !!VRy5&y2=1/y4>=9/y4<=9:S116;     [1:10% Механический голем]
    !!VRy5&y2=2/y4>=0/y4<=0:S148;     [2:10% Подвода]
    !!VRy5&y2=2/y4>=1/y4<=2:S147;     [2:20% Палатка]
    !!VRy5&y2=2/y4>=3/y4<=4:S146;     [2:20% Баллиста]
    !!VRy5&y2=2/y4>=5/y4<=6:S145;     [2:20% Катапульта]
    !!VRy5&y2=2/y4>=7/y4<=8:S116;     [2:20% Механический голем]
    !!VRy5&y2=2/y4>=9/y4<=9:S117;     [2:10% Штурмовой голем]
    !!VRy5&y2=3/y4>=0/y4<=0:S148;     [3:10% Подвода]
    !!VRy5&y2=3/y4>=1/y4<=1:S147;     [3:10% Палатка]
    !!VRy5&y2=3/y4>=2/y4<=3:S146;     [3:20% Баллиста]
    !!VRy5&y2=3/y4>=4/y4<=5:S145;     [3:20% Катапульта]
    !!VRy5&y2=3/y4>=6/y4<=7:S116;     [3:20% Механический голем]
    !!VRy5&y2=3/y4>=8/y4<=9:S117;     [3:20% Штурмовой голем]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!VRv1:S0;                        [инизиализация v1]
    !!DO9004/y11/y12/1:Py5;           [v1>0, если есть отряд для (до)призыва]
    !!VRy10&y5=148:S4;                [y10 - штраф маны Подвода 4 маны]
    !!VRy10&y5=147:S8;                [y10 - штраф маны Палатка 8 маны]
    !!VRy10&y5=145:S10;               [y10 - штраф маны Катапульта 10 маны]
    !!VRy10&y5=146:S8;                [y10 - штраф маны Баллиста 8 маны]
    !!VRy10&y5=116:S14;               [y10 - штраф маны Механический голем 14 маны]
    !!VRy10&y5=117:S16;               [y10 - штраф маны Штурмовой голем 16 маны]
    !!VRy10:*y20 :100;                [y10 - стоимост услуги с учетом скидки...]
    !!VRy10&y10<1:S1;                 [... но не менее 1 маны]
    !!HEx1:I?y11/1;                   [y11 - мана героя]
    !!if&v1<>0/y10<=y11;              [если БМ есть куда призывать и у героя достаточно маны]
      !!VRy7:S1;                      [y7 - количество призываемых существ: 1]
      !!UN&y5>117:N3/9/y5/0;          [z9 - Имя существ, еднст. число]
      !!UN&y5<118:N3/9/y5/1;          [z9 - Имя существ, множ. число]
      !!VRz8:Sz179963;                [z8 - строка действия]
      !!VRx3:S1;                      [возврат типа действия: 1]
      !!VRx4:Sy5;                     [возврат подтипа действия (существо)]
      !!VRx5:Sy7;                     [возврат значения действия (количество)]
      !!VRx6:S0 -y10;                 [возврат бонуса маны]
    !!en; 
  !!en; 
  !!if&y3=1;                          [Головорезы - призыв отряда]
    !!VRy5&y2=0/y4>=0/y4<=3:S143;     [y5 - номер призываемого существа (0:40% Воры)]
    !!VRy5&y2=0/y4>=4/y4<=6:S140;     [y5 - номер призываемого существа (0:30% Кабаны)]
    !!VRy5&y2=0/y4>=7/y4<=9:S142;     [y5 - номер призываемого существа (0:30% Кочевники)]
    !!VRy5&y2=1/y4>=0/y4<=1:S143;     [y5 - номер призываемого существа (1:20% Воры)]
    !!VRy5&y2=1/y4>=2/y4<=3:S140;     [y5 - номер призываемого существа (1:20% Кабаны)]
    !!VRy5&y2=1/y4>=4/y4<=5:S142;     [y5 - номер призываемого существа (1:20% Кочевники)]
    !!VRy5&y2=1/y4>=6/y4<=7:S194;     [y5 - номер призываемого существа (1:20% Оборотни)]
    !!VRy5&y2=1/y4>=8/y4<=9:S144;     [y5 - номер призываемого существа (1:20% Тролли)]
    !!VRy5&y2=2/y4=0:S143;            [y5 - номер призываемого существа (2:10% Воры)]
    !!VRy5&y2=2/y4>=1:S140;           [y5 - номер призываемого существа (2:10% Кабаны)]
    !!VRy5&y2=2/y4>=2/y4<=3:S142;     [y5 - номер призываемого существа (2:20% Кочевники)]
    !!VRy5&y2=2/y4>=4/y4<=5:S194;     [y5 - номер призываемого существа (2:20% Оборотни)]
    !!VRy5&y2=2/y4>=6/y4<=7:S144;     [y5 - номер призываемого существа (2:20% Тролли)]
    !!VRy5&y2=2/y4=8:S195;            [y5 - номер призываемого существа (2:10% Пожары)]
    !!VRy5&y2=2/y4=9:S168;            [y5 - номер призываемого существа (2:10% Горынычи)]
    !!VRy5&y2=3/y4=0:S143;            [y5 - номер призываемого существа (3:10% Воры)]
    !!VRy5&y2=3/y4=1:S140;            [y5 - номер призываемого существа (3:10% Кабаны)]
    !!VRy5&y2=3/y4=2:S142;            [y5 - номер призываемого существа (3:10% Кочевники)]
    !!VRy5&y2=3/y4=3:S194;            [y5 - номер призываемого существа (3:10% Оборотни)]
    !!VRy5&y2=3/y4>=4/y4<=5:S144;     [y5 - номер призываемого существа (3:20% Тролли)]
    !!VRy5&y2=3/y4>=6/y4<=7:S195;     [y5 - номер призываемого существа (3:20% Пожары)]
    !!VRy5&y2=3/y4>=8/y4<=9:S168;     [y5 - номер призываемого существа (3:20% Горынычи)]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!VRv1:S0;                        [инизиализация v1]
    !!DO9004/y11/y12/1:Py5;           [v1>0, если есть отряд для (до)призыва]
    !!VRy7&y5=143:Sy2 *15 +30;        [Воры: 30 + 15 * Уровень Дипломатии]
    !!VRy7&y5=140:Sy2 *12 +24;        [Кабаны: 24 + 12 * Уровень Дипломатии]
    !!VRy7&y5=142:Sy2 *10 +20;        [Кочевники: 20 + 10 * Уровень Дипломатии]
    !!VRy7&y5=194:Sy2 *5 +10;         [Оборотни: 10 + 5 * Уровень Дипломатии]
    !!VRy7&y5=144:Sy2 *3 +6;          [Тролли: 6 + 3 * Уровень Дипломатии]
    !!VRy7&y5=195:Sy2 *2 +4;          [Пожары: 4 + 2 * Уровень Дипломатии]
    !!VRy7&y5=168:Sy2 *1 +2;          [Горынычи: 1 + 1 * Уровень Дипломатии]
    !!MA:Fy5/?i;                      [i-боевая ценность существа]
    !!VRi:*y7;                        [i-боевая ценность отряда]
    !!VRy10:Si :500;                  [y10 - штраф маны (1 за каждые 500 FV)]
    !!VRy10:*y20 :100;                [y10 - стоимост услуги с учетом скидки...]
    !!VRy10&y10<1:S1;                 [... но не менее 1 маны]
    !!HEx1:I?y11/1;                   [y11 - мана героя]
    !!if&v1<>0/y10<=y11;              [если существо есть куда призывать и у героя достаточно маны]
      !!UN:N3/9/y5/1;                 [z9 - Имя существ, множ]
      !!VRz8:Sz179962;                [z8 - строка действия]
      !!VRx3:S1;                      [возврат типа действия: 1]
      !!VRx4:Sy5;                     [возврат подтипа действия (существо)]
      !!VRx5:Sy7;                     [возврат значения действия (количество)]
      !!VRx6:S0 -y10;                 [возврат бонуса маны]
    !!en; 
  !!en; 
  !!if&y3=4;                          [Стрелки - призыв отряда]
    !!VRy5&y2=0/y4>=0/y4<=3:S138;     [y5 - номер призываемого существа (0:40% Хоббиты)]
    !!VRy5&y2=0/y4>=4/y4<=7:S192;     [y5 - номер призываемого существа (0:40% Сильванские кентавры)]
    !!VRy5&y2=0/y4>=8/y4<=9:S137;     [y5 - номер призываемого существа (0:20% Снайперы)]
    !!VRy5&y2=1/y4>=0/y4<=2:S138;     [y5 - номер призываемого существа (1:30% Хоббиты)]
    !!VRy5&y2=1/y4>=3/y4<=5:S192;     [y5 - номер призываемого существа (1:30% Сильванские кентавры)]
    !!VRy5&y2=1/y4>=6/y4<=8:S137;     [y5 - номер призываемого существа (1:30% Снайперы)]
    !!VRy5&y2=1/y4=9:S171;            [y5 - номер призываемого существа (1:10% Лав.Снайперы)]
    !!VRy5&y2=2/y4>=0/y4<=2:S138;     [y5 - номер призываемого существа (2:30% Хоббиты)]
    !!VRy5&y2=2/y4>=3/y4<=5:S192;     [y5 - номер призываемого существа (2:30% Сильванские кентавры)]
    !!VRy5&y2=2/y4>=6/y4<=7:S137;     [y5 - номер призываемого существа (2:20% Снайперы)]
    !!VRy5&y2=2/y4=8:S171;            [y5 - номер призываемого существа (2:10% Лав.Снайперы)]
    !!VRy5&y2=2/y4=9:S170;            [y5 - номер призываемого существа (2:10% Аркт.Снайперы)]
    !!VRy5&y2=3/y4>=0/y4<=1:S138;     [y5 - номер призываемого существа (3:20% Хоббиты)]
    !!VRy5&y2=3/y4>=2/y4<=3:S192;     [y5 - номер призываемого существа (3:20% Сильванские кентавры)]
    !!VRy5&y2=3/y4>=4/y4<=5:S137;     [y5 - номер призываемого существа (3:20% Снайперы)]
    !!VRy5&y2=3/y4>=6/y4<=7:S171;     [y5 - номер призываемого существа (3:20% Лав.Снайперы)]
    !!VRy5&y2=3/y4>=8/y4<=9:S170;     [y5 - номер призываемого существа (3:20% Аркт.Снайперы)]
    !!VRy11:Sx2 *21;                  [y11 - первый отряд для поиска (0/21)]
    !!VRy12:Sy11 +20;                 [y12 - последний отряд для поиска (20/41)]
    !!VRv1:S0;                        [инизиализация v1]
    !!DO9004/y11/y12/1:Py5;           [v1>0, если есть отряд для (до)призыва]
    !!VRy7&y5=138:Sy2 *12 +24;        [Хоббиты: 24 + 12 * Уровень Дипломатии]
    !!VRy7&y5=192:Sy2 *5 +10;         [Сильв.кентавры: 10 + 5 * Уровень Дипломатии]
    !!VRy7&y5=137:Sy2 *3 +6;          [Снайперы: 6 + 3 * Уровень Дипломатии]
    !!VRy7&y5=171:Sy2 *3 +6;          [Лав.Снайперы: 6 + 3 * Уровень Дипломатии]
    !!VRy7&y5=170:Sy2 *3 +6;          [Арк.Снайперы: 6 + 3 * Уровень Дипломатии]
    !!MA:Fy5/?i;                      [i-боевая ценность существа]
    !!VRi:*y7;                        [i-боевая ценность отряда]
    !!VRy10:Si :400;                  [y10 - штраф маны (1 за каждые 400 FV)]
    !!VRy10:*y20 :100;                [y10 - стоимост услуги с учетом скидки...]
    !!VRy10&y10<1:S1;                 [... но не менее 1 маны]
    !!HEx1:I?y11/1;                   [y11 - мана героя]
    !!if&v1<>0/y10<=y11;              [если существо есть куда призывать и у героя достаточно маны]
      !!UN:N3/9/y5/1;                 [z9 - Имя существ, множ]
      !!VRz8:Sz179962;                [z8 - строка действия]
      !!VRx3:S1;                      [возврат типа действия: 1]
      !!VRx4:Sy5;                     [возврат подтипа действия (существо)]
      !!VRx5:Sy7;                     [возврат значения действия (количество)]
      !!VRx6:S0 -y10;                 [возврат бонуса маны]
    !!en; 
  !!en; 
  !!if&y3=2;                          [Гильдия Чародеев]
** 1: Карты судьбы (Герой получает возможность открыть до 5 случайных карт, стоимость 5 маны, шанс открытия карты 30/40/50/60%)
** 2: Перекачка маны (перекачивает герою-заказчику 50% маны героя-оппонента, стоимость 10 маны)
** Стоимость оплаты услуг взимается ПЕРЕД оказанием услуги.
** 169: Призыв Фанатиков (призывает 3 * (УД+1) фанатиков, стоимость 1 маны + 1 маны/раунд за фанатика)
** 193: Призыв Колдуний (призывает 3 * (УД+1) Колдуний, стоимость 1 маны + 1 маны/раунд за Колдунью)
** 136: Призыв Чародеев (призывает 3 * (УД+1) Чародеев, стоимость 1 маны + 1 маны/раунд за Чародея)
** Количество Колдуний и Чародеев не может превышать регенерацию маны героя
** При поглощении маны в начале раунда Колдуньи и Чародеи лечатся.
** При недостатке маны в начале раунда "неоплаченные" Фанатики, Колдуньи и Чародеи отзываются.
** Порядок "оплаты": Чародеи, Колдуньи, Фанатики, Дракон маны
** 134: Призыв Дракона маны (ДМ)(стоимость 20+ маны).
** При призыве ДМ поглощает всю ману героя, получая Уровень дипломатии*MP Здоровья.
** ДМ имеет бесконечный запас заклинаний
** После произнесении заклинания ДМ получает урон равный стоимости заклинания
** ДМ каждый раунд поглощает всю ману героя оставшуюся после оплаты найма Колдуний и Чародеев, излечиваясь на 3*MP Здоровья
**
** шансы выпадения услуг
    !!VRy5&y4>=0/y4<=1:S1;            [y5 - Карты судьбы      (х:20%)]
    !!VRy5&y4>=2/y4<=3:S2;            [y5 - Перекачка маны (х:20%)]
    !!VRy5&y2=0/y4>=4/y4<=6:S169;     [y5 - Фанатики   (0:30%)]
    !!VRy5&y2=0/y4>=7/y4<=8:S193;     [y5 - Волшебницы (0:20%)]
    !!VRy5&y2=0/y4>=9/y4<=9:S136;     [y5 - Чародеи    (0:10%)]
    !!VRy5&y2=1/y4>=4/y4<=5:S169;     [y5 - Фанатики   (1:20%)]
    !!VRy5&y2=1/y4>=6/y4<=7:S193;     [y5 - Волшебницы (1:20%)]
    !!VRy5&y2=1/y4>=8/y4<=9:S136;     [y5 - Чародеи    (1:20%)]
    !!VRy5&y2=2/y4>=4/y4<=4:S169;     [y5 - Фанатики   (2:10%)]
    !!VRy5&y2=2/y4>=5/y4<=6:S193;     [y5 - Волшебницы (2:20%)]
    !!VRy5&y2=2/y4>=7/y4<=8:S136;     [y5 - Чародеи    (2:20%)]
    !!VRy5&y2=2/y4>=9/y4<=9:S134;     [y5 - Сказочный Дракон (2:10%)]
    !!VRy5&y2=3/y4>=4/y4<=4:S169;     [y5 - Фанатики   (3:10%)]
    !!VRy5&y2=3/y4>=5/y4<=6:S193;     [y5 - Волшебницы (3:20%)]
    !!VRy5&y2=3/y4>=7/y4<=8:S136;     [y5 - Чародеи    (3:20%)]
    !!VRy5&y2=3/y4>=9/y4<=9:S134;     [y5 - Сказочный Дракон (3:10%)]
** стоимость услуг
    !!VRy10:S0;                       [y10 - стоимость услуги]
    !!VRy10&y5=1:S5;                  [y10 - стоимость услуги Карты Судьбы - 5 маны]
    !!VRy10&y5=2:S6;                  [y10 - стоимость услуги Перекачка маны - 6 маны]
    !!if|y5=193/y5=136/y5=169; 
      !!FU9046:Px1/x2/?y11;           [y11 - макс. возможное кол-во Фанатиков/Волшебниц/Чародеев для призыва]
      !!FU&y11<1:E;                   [выход, если регенерации маны недостаточно для призыва]
      !!VRy10:Sy2 +1 *4;              [y10 - стоимость Фанатиков/Волшебниц/Чародеев - 1 маны за каждого: (УД+1)*4]
      !!VRy10&y10>y11:Sy11;           [... но не больше макс. возможного количества для призыва]
    !!en; 
    !!VRy10&y5=134:S20;               [y10 - стоимость призыва ДМ - не менее 20 маны]
    !!VRy10:*y20 :100;                [y10 - стоимость услуги с учетом скидки...]
    !!VRy10&y10<1:S1;                 [... но не менее 1 маны]
    !!HEx1:I?y12/1;                   [y12 - мана героя]
    !!VRy13:Sx2 *21;                  [y13 - первый отряд для поиска (0/21)]
    !!VRy14:Sy13 +20;                 [y14 - последний отряд для поиска (20/41)]
    !!VRv1:S0;                        [инизиализация v1]
    !!DO9004/y13/y14/1:Py5;           [v1>0, если есть отряд для (до)призыва]
    !!if&y5=1/y10<=y12;               [если хватает маны, Карты Судьбы]
      !!VRy7:Sy2 *10 +30;             [y7 - шанс открытия карты 30/40/50/60%]
      !!VRz8:Sz179195;                [z8 - строка действия]
      !!VRx3:S8;                      [возврат типа действия: 8]
      !!VRx4:S1;                      [возврат подтипа действия: 1 (Карты Судьбы)]
      !!VRx5:Sy7;                     [возврат значения действия (шанс открытия)]
      !!VRx6:S0 -y10;                 [возврат стоимости услуги]
    !!en; 
    !!if&y5=2/y10<=y12;               [если хватает маны, Перекачка маны]
      !!VRi:Sx2 *-1 +1;               [i - противоположная сторона]
      !!BA:Hi/?j;                     [j - вражеский герой]
      !!HEj:I?i/1;                    [i - мана вражеского героя]
      !!FU&i<y10:E;                   [не предлагаем услугу, если перекачивается меньше маны чем цена услуги]
      !!VRz8:Sz179194;                [z8 - строка действия]
      !!VRx3:S8;                      [возврат типа действия: 8]
      !!VRx4:S2;                      [возврат подтипа действия: 2 (Перекаяка маны)]
      !!VRx5:Si;                      [возврат значения действия (количество маны)]
      !!VRx6:S0 -y10;                 [возврат стоимости услуги]
    !!en; 
    !!if&y5>100/v1<>0/y10<=y12;       [если хватает маны и есть куда призывать, Призыв Фанатиков/Волшебниц/Чародеев]
      !!if|y5=169/y5=193/y5=136;      [если Призыв Фанатиков/Волшебниц/Чародеев]
        !!UN:N3/9/y5/1;               [z9 - Имя существ, множ]
        !!VRy7:Sy2 +1 *4;             [Кол-во существ 4 * (Дипломатия + 1)]
        !!VRy7&y7>y11:Sy11;           [ограничение количества по регенерации маны]
        !!VRz8:Sz179192;              [z8 - строка действия]
        !!VRx3:S1;                    [возврат типа действия: 1]
        !!VRx4:Sy5;                   [возврат подтипа действия (существо)]
        !!VRx5:Sy7;                   [возврат значения действия (количество)]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
      !!if&y5=134;                    [если Призыв ДМ]
        !!VRy7:Sy12 *2;               [y7 - Здоровье ДМ (2*мана героя)]
        !!VRz8:Sz179193;              [z8 - строка действия]
        !!VRx3:S8;                    [возврат типа действия: 8]
        !!VRx4:S3;                    [возврат подтипа действия: 3 (ДМ)]
        !!VRx5:Sy7;                   [возврат значения действия (количество здоровья)]
        !!VRx6:S0 -y12;               [возврат бонуса маны (вся мана)]
      !!en; 
    !!en; 
  !!en; 
  !!if&y3=3;                          [Некроманты - ритуалы]
    !!VRy5&y2=0/y4>=0/y4<=4:S2;       [0:50% - Зомбирование]
    !!VRy5&y2=0/y4>=5/y4<=7:S3;       [0:30% - Обмен душ]
    !!VRy5&y2=0/y4>=8:S4;             [0:20% - Мумификация]
    !!VRy5&y2=1/y4>=0/y4<=3:S2;       [1:40% - Зомбирование]
    !!VRy5&y2=1/y4>=4/y4<=5:S3;       [1:20% - Обмен душ]
    !!VRy5&y2=1/y4>=6/y4<=7:S4;       [1:20% - Мумификация]
    !!VRy5&y2=1/y4>=8:S5;             [1:20% - Воплощение Кошмаров]
    !!VRy5&y2=2/y4>=0/y4<=2:S2;       [2:30% - Зомбирование]
    !!VRy5&y2=2/y4>=3/y4<=4:S3;       [2:20% - Обмен душ]
    !!VRy5&y2=2/y4>=5/y4<=6:S4;       [2:20% - Мумификация]
    !!VRy5&y2=2/y4>=7/y4<=8:S5;       [2:20% - Воплощение Кошмаров]
    !!VRy5&y2=2/y4=9:S1;              [2:10% - Реанимация Драколича]
    !!VRy5&y2=2/y4>=0/y4<=1:S2;       [2:20% - Зомбирование]
    !!VRy5&y2=2/y4>=2/y4<=3:S3;       [2:20% - Обмен душ]
    !!VRy5&y2=2/y4>=4/y4<=5:S4;       [2:20% - Мумификация]
    !!VRy5&y2=2/y4>=6/y4<=7:S5;       [2:20% - Воплощение Кошмаров]
    !!VRy5&y2=2/y4>=8:S1;             [2:20% - Реанимация Драколича]
    !!VRy10&y5=1:S30;                 [Реанимация Драколича - 30 маны]
    !!VRy10&y5=2:S5;                  [Зомбирование - 5 маны]
    !!VRy10&y5=3:S15;                 [Обмен душ - 15 маны]
    !!VRy10&y5=4:S10;                 [Мумификация - 10 маны]
    !!VRy10&y5=5:S20;                 [Воплощение Кошмаров - 20 маны]
    !!VRy10:*y20 :100;                [y10 - стоимост услуги с учетом скидки...]
    !!VRy10&y10<1:S1;                 [... но не менее 1 маны]
    !!HEx1:I?y11/1;                   [y11 - мана героя]
    !!if&y5=1/y10<=y11;               [Некроманты - Реанимация Драколича]
      !!VRy11:Sx2 *21;                [y11 - первый отряд для поиска (0/21)]
      !!VRy12:Sy11 +20;               [y12 - последний отряд для поиска (20/41)]
      !!VRv1:S0;                      [инизиализация v1]
      !!DO9020/y11/y12/1:P0/1/0;      [v1 - количество здоровья "живых" отрядов у героя]
      !!if&v1>0;                      [если есть хоть один живой отряд]
        !!MA:P196/?y8;                [y8 - здоровье Драколича]
        !!VRv1&y2<3::2;               [для Дипломатии ниже экспертной здоровье Драколичей снижено вдвое]
        !!VRy6:Sv1 :y8;               [y6 - Количество восстанавливаемых Драколичей]
        !!VRy7:Sv1 %y8;               [...]
        !!VRy6&y7>0:+1;               [...]
        !!VRz8:Sz179961;              [z8 - строка действия]
        !!VRx3:S7;                    [возврат типа действия: 7]
        !!VRx4:S1;                    [возврат подтипа действия 1]
        !!VRx5:Sv1;                   [возврат количества здоровья Драколичей]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
    !!en; 
    !!if&y5=5/y10<=y11;               [Некроманты - Воплощение Кошмаров]
      !!VRy11:Sx2 *21;                [y11 - первый отряд для поиска (0/21)]
      !!VRy12:Sy11 +20;               [y12 - последний отряд для поиска (20/41)]
      !!VRv1:S0;                      [инизиализация v1]
      !!DO9020/y11/y12/1:P0/1/0;      [v1 - количество здоровья "живых" отрядов у героя]
      !!if&v1>0;                      [если есть хоть один живой отряд]
        !!MA:P172/?y8;                [y8 - здоровье Кошмара]
        !!VRv1&y2<2::2;               [для Дипломатии ниже продвинутой здоровье Кошмаров снижено вдвое]
        !!VRy6:Sv1 :y8;               [y6 - Количество восстанавливаемых Кошмаров]
        !!VRy7:Sv1 %y8;               [...]
        !!VRy6&y7>0:+1;               [...]
        !!VRz8:Sz179190;              [z8 - строка действия]
        !!VRx3:S7;                    [возврат типа действия: 7]
        !!VRx4:S5;                    [возврат подтипа действия 5]
        !!VRx5:Sv1;                   [возврат количества здоровья Кошмаров]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
    !!en; 
    !!if&y5=2/y10<=y11;               [Некроманты - Зомбирование]
      !!VRy11:Sx2 *21;                [y11 - первый отряд для поиска (0/21)]
      !!VRy12:Sy11 +20;               [y12 - последний отряд для поиска (20/41)]
      !!VRv1:S0;                      [инизиализация v1]
      !!DO9020/y11/y12/1:P0/1/0;      [v1 - количество здоровья "живых" отрядов у героя]
      !!if&v1>0;                      [если есть хоть один живой отряд]
        !!MA:P59/?y8;                 [y5 - здоровье Зомби]
        !!VRy6:Sy2 +2 *v1 :y8;        [y6 - Количество восстанавливаемых Зомби (по здоровью с бонусом 2/3/4/5)]
        !!VRy7:Sv1 %y8;               [...]
        !!VRy6&y7>0:+1;               [...]
        !!VRv1:S0;                    [инизиализация v1]
        !!DO9020/y11/y12/1:P0/2/0;    [v1 - количество "живых" существ у героя]
        !!VRy6&y6>v1:Sv1;             [y6 - Количество восстанавливаемых Зомби (по здоровью и количеству)]
        !!VRv1:S0;                    [инизиализация v1]
        !!DO9020/y11/y12/1:P0/3/0;    [v1 - FV "живых" отрядов у героя]
        !!MA:F59/?i;                  [i - FV отряда Зомби]
        !!VRi:*y6;                    {...]
        !!FU&i<=v1:E;                 [выход, если FV полученных Зомби менее FV жертв]
        !!VRz8:Sz179959;              [z8 - строка действия]
        !!VRx3:S7;                    [возврат типа действия: 7]
        !!VRx4:S2;                    [возврат подтипа действия 2]
        !!VRx5:Sy6;                   [возврат количества существ]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
    !!en; 
    !!if&y5=3/y10<=y11;               [Некроманты - Обмен душ]
      !!VRy11:Sx2 *21;                [y11 - первый отряд для поиска (0/21)]
      !!VRy12:Sy11 +20;               [y12 - последний отряд для поиска (20/41)]
      !!VRv1:S0;                      [инизиализация v1]
      !!DO9020/y11/y12/1:P0/3/0;      [v1 - FV "живых" существ у героя, принесенных в жертву]
      !!if&v1>0;                      [если есть хоть один живой отряд]
        !!MA:F159/?i;                 [i - FV привидения]
        !!VRy6:Sv1 *12 :10 :i +1;     [y6 - Количество восстанавливаемых Привидений (120% FV жертв)]
        !!VRv1:S0;                    [инизиализация v1]
        !!DO9020/y11/y12/1:P0/2/0;    [v1 - количество "живых" существ у героя, принесенных в жертву]
        !!VRy6&y6<v1:Sv1;             [y6 - Количество восстанавливаемых Привидений (не менее количества пожертвованных существ)]
        !!VRz8:Sz179960;              [z8 - строка действия]
        !!VRx3:S7;                    [возврат типа действия: 7]
        !!VRx4:S3;                    [возврат подтипа действия 3]
        !!VRx5:Sy6;                   [возврат количества существ]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
    !!en; 
    !!if&y5=4/y10<=y11;               [Некроманты - Мумификация]
      !!VRy11:Sx2 *21;                [y11 - первый отряд для поиска (0/21)]
      !!VRy12:Sy11 +20;               [y12 - последний отряд для поиска (20/41)]
      !!VRv1:S0;                      [инизиализация v1]
      !!DO9020/y11/y12/1:P0/1/0;      [v1 - количество здоровья "живых" отрядов у героя]
      !!if&v1>0;                      [если есть хоть один живой отряд]
        !!MA:P141/?y8;                [y8 - здоровье Мумии]
        !!VRy6:Sy2 +2 *v1 :y8;        [y6 - Количество восстанавливаемых Мумий (по здоровью с бонусом 2/3/4/5)]
        !!VRy7:Sv1 %y8;               [...]
        !!VRy6&y7>0:+1;               [...]
        !!VRv1:S0;                    [инизиализация v1]
        !!DO9020/y11/y12/1:P0/2/0;    [v1 - количество "живых" существ у героя]
        !!VRy6&y6>v1:Sv1;             [y6 - Количество восстанавливаемых Мумий (по здоровью и количеству)]
        !!VRv1:S0;                    [инизиализация v1]
        !!DO9020/y11/y12/1:P0/3/0;    [v1 - FV "живых" отрядов у героя]
        !!MA:F141/?i;                 [i - FV отряда Мумий]
        !!VRi:*y6;                    {...]
        !!FU&i<=v1:E;                 [выход, если FV полученных Мумий менее FV жертв]
        !!VRz8:Sz179944;              [z8 - строка действия]
        !!VRx3:S7;                    [возврат типа действия: 7]
        !!VRx4:S4;                    [возврат подтипа действия 4]
        !!VRx5:Sy6;                   [возврат количества существ]
        !!VRx6:S0 -y10;               [возврат бонуса маны]
      !!en; 
    !!en; 
  !!en; 
***
!!en; 
*** завершение подбора
!!VRi:Sx3 *100 +x4;                   [i - контрольное число действия]
!!VRx3|i=v101/i=v102/i=v103/i=v104/i=v105:S0; [обнуляем действие, если уже предлагается действие с аналогичным контрольным числом]
!!VRx16&x3>0:S250;                    [Завершение цикла, если действие подобрано]

!?FU9011;                             [Определение номера существа x4 по городу x1, уровню x2(0..6) и признаку улучшения x3(0..1)]
!!VRx2:*2 +x3;                        [x2 - сдвиг существа внутри города]
!!VRx4:Sx1 *14 +x2;                   [x4 - номер существа]
!!VRx4&x4=125:S131;                   [Феникс]
!!VRx4&x4=124:S130;                   [Огн. Птица]
!!VRx4&x4=119:S129;                   [Энерг. эл.]
!!VRx4&x4=115:S127;                   [Шторм. эл.]
!!VRx4&x4=121:S125;                   [Магм. эл.]
!!VRx4&x4=123:S121;                   [Маг. эл.]
!!VRx4&x4=113:S119;                   [Фея]
!!VRx4&x4=120:S113;                   [Земл. эл.]
!!VRx4&x4=122:S120;                   [Псих. эл.]
!!VRx4&x4=117:S123;                   [Лед. эл.]
!!VRx4&x4=116:S115;                   [Водн. эл.]
!!VRx4&x4=112:S218;                   [мал.Фея]
!!VRx4&x4=114:S112;                   [Возд. эл.]
!!VRx4&x4=118:S114;                   [Огн. эл.]
!!VRx4&x4=218:S118;                   [мал.Фея]
!!VRx4&x4=106:S202;                   [Горгона]
!!VRx4&x4=107:S203;                   [М.Горгона]
!!VRx4&x4=104:S106;                   [Василиск]
!!VRx4&x4=105:S107;                   [В.Василиск]
!!VRx4&x4=102:S104;                   [Змий]
!!VRx4&x4=103:S105;                   [Змий-Дракон]
!!VRx4&x4=202:S102;                   [Горгона]
!!VRx4&x4=203:S103;                   [М.Горгона]

!?FU9012;                             [установка в vx1 номера отряда x16, если это отряд-командир]
!!BMx16:T?y1;                         [y1 - тип отряда]
!!FU|y1<174/y1>191:E;                 [выход, если не командир]
!!VRvx1:Sx16;                         [vx1 - номер отряда-командира]
!!VRx16:S50;                          [прерывание цикла]

!?FU9013;                             [x1 - герой, x2 - уровень заклинания, x3 - номер заклинания для изучения. Возврат: v1 - количество заклинаний (x3=0) или номер x3-го неизученного заклинания]
!!SSx16:L?y1;                         [y1 - уровень заклинания x16]
!!HEx1:Mx16/?y2;                      [y2=1, если заклинание известно герою]
!!FU|y1<>x2/y2<>0:E;                  [выход, если заклинание не нужного уровня или уже известно]
** выход, если заклинание в "черном списке"
** Радость, Печаль, Землетрясение, Мины, Зыбучие пески, Гром Титанов,
** Жертва, Волш. зеркало, Защита от Воздуха/Земли/Огня, Стена огня
!!FU|x16=49/x16=50/x16=14/x16=11/x16=10/x16=57/x16=40/x16=36/x16=30/x16=31/x16=33/x16=13:E;
!!VRv1:+1;                            [v1++]
!!if&v1=x3;                           [если требуемый номер неизученного заклинания]
  !!VRv1:Sx16;                        [v1 - номер заклинания]
  !!VRx16:S70;                        [прерываем цикл]
!!en; 

!?FU9014;                             [Увеличение атаки/защиты стека x16, x1 - герой (-10/-20), x2 - +Атаки, x3 - +Защиты]
!!BMx16:Adx2 Ddx3;                    [увеличивыаем атаку/защиту отрядам]

!?FU9015;                             [возвращает в v1 количество (x1=0) или номер (x1>0) x1-й свободной позиции, x2 - сторона, x3=1 для двухгексовых существ]
!!BU:Dx16/?y1 Ox16/?y2 Ex16/?y4;      [y1=-1, y2=0, y4=-1 если на позиции нет отрядов и препятствий]
!!FU|y1<>-1/y2>0/y4<>-1:E;            [выход, если позиция занята]
!!if&x3>0;                            [для двухгексовых существ]
  !!VRy3:Sx2 *-2 +1 +x16;             [y3 - 2й гекс]
  !!BU:Dy3/?y1 Oy3/?y2 Ey3/?y4;       [y1=-1, y2=0, y4=-1 если на позиции нет отрядов и препятствий]
  !!FU|y1<>-1/y2>0/y4<>-1:E;          [выход, если позиция занята]
!!en; 
!!VRv1:+1;                            [увеличиваем счетчик доступных позиций]
!!if&x1=v1;                           [если найдена нужная свободная позиция]
  !!VRv1:Sx16;                        [v1 - позииция для призыва]
  !!VRx16:S200;                       [прерываем цикл, если нужная позиция найдена]
!!en; 

!?FU9016;                             [отзыв отряда x16]
!!FU|x16=i^bh_commander_stack_0^/x16=i^bh_commander_stack_1^:E;           [отряды командиров не отзываются]
!!BMx16:N?y1 F?y2;                    [y1 - текущее количество существ, y2 - флаги]
!!VRy2&y1>0:|64;                      [выставляем флаг осадного орудия]
!!BMx16&y1>0:B0 Fy2;                  [обнуление базового количества и выставление флага БМ отряду в котором есть существа]

!?FU9017;                             [установка командиру x1 базовых параметров]
!!COx1:P0/20 P1/20 P2/500 P3/20 P4/0 P5/1 P6/0;  [первичные параметры(атак,защ,здор,урон,сила,скор,сопр)]
!!COx1:S0/0 S1/0 S2/0 S3/0 S4/0 S5/0 S6/0;       [вторичные навыки(атак,защ,здор,урон,сила,скор,сопр)]
!!COx1:B0/0 X0/100500;                [сброс способностей и установка опыта до следующего уровня]

!?FU9018;                             [увеличение скорости отряда x16 на x1]
!!BMx16:T?y1;                         [y1 - тип отряда]
!!FU&y1>=145/y1<=148:E;               [выход, если отряд - боевая машина]
!!BMx16:Sdx1;                         [...]

!?FU9019;                             [Восстановление боезапаса отряду x16]
!!BMx16:T?y1;                         [y1 - тип отряда]
!!FU&y1<0:E;                          [выход, елси отряда нет]
!!MA:Ny1/?y2;                         [y2 - базовое количество выстрелов существа]
!!BMx16&y1<174/y2>0:U3/y2;            [восстанавливаем боезапас отряду (не командирам)]
!!BMx16&y1>191/y2>0:U3/y2;            [...]
!!FU|y1<174/y1>191:E;                 [выход, если не командир]
!!COv9998&x16<21:B1/4/?y3;            [y3=1, если у командира есть способность стрелять]
!!COv9999&x16>20:B1/4/?y3;            [...]
!!BMx16&y3=1:U3/24;                   [восстанавливаем боезапас стреляющему командиру]

!?FU9020;                             [Подсчет параметров отрядов в v1 и их уничтожение (x1=1)]
** x1 = 0/1 (подсчет/подсчет и уничтожение)]
** x2=0/1/2/3  (подсчет количества отрядов/здоровья/количества существ/FV существ)
** x3=0/1 "живые отряды" / "боевые машины и големы"
!!BMx16:T?y1 F?y2 N?y3 H?y4 L?y5 P?y6;[y1 - тип существа, y2 - флаги, y3 - количество существ, y4/y5 - максимальное/потерянное здоровье отряда, y6 - позиция на поле боя]
!!VRy7:Sy2 &8388608;                  [y7>0, если отряд - клон]
!!VRy2:&16;                           [y2>0, если отряд "живой"]
!!VRy8|y1=145/y1=146/y1=147/y1=148/y1=116/y1=117/y1=32/y1=33:S1; [y8=1, если отряд - БМ/голем]
!!FU|y3<1/x16=i^bh_commander_stack_0^/x16=i^bh_commander_stack_1^/y7>0:E; [выход, если отряда нет, отряд клон или командир]
!!FU&y1>=150/y1<=158:E;               [выход, если отряд - Хранитель]
!!FU&y2=0/x3=0:E;                     [выход если нужно считать жывые отряды, а отряд не живой]
!!FU&y8=0/x3=1:E;                     [выход если нужно считать БМ, а отряд не БМ]
!!MA:Fy1/?y8;                         [y8 - FV существа]
!!VRy7:Sy3 *y4 -y5;                   [y7 - Здоровье принесенного в жертву отряда]
!!VRy8 *y3;                           [y8 - суммарное FV отряда]
!!if&x1=1;                            [уничтожение отрядов]
  !!BMx16:F?y10;                      [y10 - флаги отряда]
  !!VRy10:|8388608 |536870912;        [выставляем фраг клона]
  !!BMx16:Fy10 N0 B0 K1;              [убиваем без обновления поля]
  !!VRy10&x16<21:Sx16 :4 +7910;       [y10 - индекс v-переменной "помеченной группы"]
  !!VRy10&x16>20:Sx16 -21 :4 +7915;   [...]
  !!VRy11:Sx16 %21 %4;                [y11 - номер байта]
  !!VRvy10&y11=0:+1;                  ["пометка отряда"]
  !!VRvy10&y11=1:+256;                [...]
  !!VRvy10&y11=2:+65536;              [...]
  !!VRvy10&y11=3:+16777216;           [...]
!!en; 
!!VRv1&x2=0:+1;                       [увеличение счетчика количества живых отрядов]
!!VRv1&x2=1:+y7;                      [увеличение счетчика "жертвенного здоровья"]
!!VRv1&x2=2:+y3;                      [увеличение счетчика "живых" сужеств]
!!VRv1&x2=3:+y8;                      [увеличение счетчика "FV жертв"]

!?FU9022;                             [чистка подвисающих отрядов]
!!BMx16:N?y1 O?y2;                    [y1 - текущее количество существ, y2 - номер слота в армии героя]
!!BMx16&y1<1:B0 O-1;                  [если отряд мертв, обнуляем его базовое количество]
!!BA&x16<21/y2>-1:M0/y2/-1/0;         [удаление погибшего монстра из армии героя для сброса бонусов/штрафов к стоимости заклинаний]
!!BA&x16>20/y2>-1:M1/y2/-1/0;         [...]

!?FU77007;                            [фаза регенерации: проверка на смерть командиров, регенерация и ход командира]
!!FU(BH_BattleStatsInit)&-445:P;                      [перед началом боя выполняем подготовительные действия]
** Проверка на смерть командиров
!!BMi^bh_commander_stack_1^:N?y1;                       [y1=0, если командир правого мертв...]
!!BMi^bh_commander_stack_0^:N?y2;                       [y2=0, если командир левого мертв...]
!!if|y1=0/y2=0;                       [если погиб один из командиров]
  !!FU9017:Pv9998 Pv9999;             [сброс параметров командиров]
  !!FU9056:P-10/0 P-20/1;             [отмена усиления Университета Магии]
  !!DO9002/0/69/1:Pv9998/11 Pv9999/12;[восстановление параметров, заклианний и навыков у героев, если бой завершен]
  !!DO9016/0/41/1:P;                  [отзыв отрядов]
  !!FU:E;                             [выход, если бой закончен]
!!en; 
** Некромантия - проверка статуса отрядов, активация навыка, учет артефактов некроманта
!!FU9040&444:P;                       [если некромантия не проверялась, вызываем проверку]
** регенерация командира
!!SN:X?y1;                            [y1 - номер отряда]
!!FU&y1<>i^bh_commander_stack_0^/y1<>i^bh_commander_stack_1^:E;           [выход, если не ход командира]
!!BMy1:H?y2 L?y5;                     [y2 - макс./потер. здоровье командира]
!!COv9998&y1=i^bh_commander_stack_0^:N?z2;              [z2 - имя командира]
!!COv9999&y1=i^bh_commander_stack_1^:N?z2;              [...]
!!VRy3&y1=i^bh_commander_stack_0^:Sv9964;               [y3=1, если есть способность Повышенная регенерация...]
!!VRy3&y1=i^bh_commander_stack_1^:Sv9965;               [...]
!!VRy4&y3=0:Sy2 :100;                 [y4 - реген. здоровье (обычная регенерация - 1% от максимального здоровья)]
!!VRy4&y3=1:Sy2 :50;                  [y4 - реген. здоровье (повышенная регенерация - 2% от максимального здоровья)]
!!VRy4&y4>y5:Sy5;                     [реген. здоровье не превышает потерянное]
!!VRy5:-y4;                           [уменьшение потерянного здоровья]
!!if&y4>0; 
  !!VRz77:S^REGENER.wav^;             [z1 - звук "исцеления"]
  !!SN:Pz77;                          [воспроизведение звука]
  !!BMy1:Ly5 V79;                     [Восполнение здоровья командира и анимация лечения]
  !!VRz1:Sz179948;                    [формирование сообщения о регенерации командира]
  !!MM:Sz1;                           [вывод сообщения в лог битвы]
!!en; 
!!SN:X?y1/1;                          [блокирование регенерации командира от навыка]
*** фикс уменьшающейся защиты из-за способности "Блокирование урона"
!!BMy1:T?y3 F?y2;                     [y3/y2 - тип/флаги отряда]
!!VRy4:Sy2 &134217728;                [y4>0, если у командира выставлен флаг "отряд в защитном положении"]
!!if&y4>0; 
  !!SN:W^algor_cbf_a^/?y5 W^algor_cbf_d^/?y6;[y5/y6 - последние действия командиров]
  !!VRy2&y3>=174/y3<=182/y5<>3:-134217728;[снимаем флаг с атакующего командира, если он не должен быть выставлен]
  !!VRy2&y3>=183/y3<=191/y6<>3:-134217728;[снимаем флаг с защищающегося командира, если он не должен быть выставлен]
  !!BMy1:Fy2;                         [обновляем флаги командира]
!!en; 

!?FU9099;                             [x1 - призванное существо, x2 - сторона (0/1), x3 - возвр. № отряда]
!!VRx3:S-1;                           [по умолчанию отряд не найден]
!!VRy1:Sx2 *21 +x16;                  [y1 - проверяемый отряд]
!!BMy1:T?y2 F?y3 N?y4;                [y2/y3/y4 - тип/флаги/количество существ отряда]
!!FU|y2<>x1/y4<1:E;                   [выход, если тип существа не совпадает с призываемым или отряд мертв]
!!VRy3:&4194304;                      [y3>0, если отряд призван]
!!VRx3&y3>0:Sy1;                      [возвращаем номер найденного отряда]
!!VRx16&y3>0:S20;                     [завершаем перебор отрядов]

!?MF1;                                [перед нанесением физического урона]
!!MF:N?y1;                            [y1 - отряд получающий урон]
!!BMy1:T?y2;                          [тип отряда]
!!BMy1&y2>=145/y2<=148:R0;            [если атакуется БМ, убираем ответные удары]

*** (Не)удача
!?BG0;                                [перед действием]
!!BG:N?y1 A?y2 E?y3;                  [y1/y2/y3 - активный отряд/действие/целевой отряд]
!!FU&y3=-1:E;                         [выход, если целевой отряд не существует (например, убит абилкой перед основной атакой)]
!!if|y2=6/y2=7;                       [если отряд атакует]
  !!BMy1:G213/?v7907/d G213/0/d;      [сохранение в v7907 и обнуление текущей (не)удачи атакующего отряда]
  !!BMy3:G213/?v7908/d G213/0/d;      [сохранение в v7908 и обнуление текущей (не)удачи целевого отряда]
!!en; 

!?MF1;                                [перед нанесением физического урона]
!!MF:W?y1 N?y3;                       [y1/y3 - тип атаки, отряд получающий урон]
!!FU&y1>0:E;                          [выход, если урон от рва или башни]
!!BG:N?y1 E?y4;                       [y1/y4 - ходящий отряд/цель]
!!FU|y1<0/y4<0:E;                     [выход, если одного из взаимодействующих отрядов нет (например, огненный щит от трупа)]
!!VRy2:Sv7907;                        [y2 - (не)удача атакующего отряда]
!!if&y3=y1;                           [если ответный удар]
  !!VRy1:Sy4;                         [y1 - отряд, наносящий урон - отряд-цель]
  !!VRy2:Sv7908;                      [y2 - текущая (не)удача отряда-цели]
!!en; 
!!FU&y2=0:E;                          [выход если (не)удача нулевая]
!!BMy1:G213/0/d;                      [обнуляем текущую (не)удачу отряда]
!!VRy5:Sy2 *10;                       [y5 - шанс выпадения (не)удачи 10% за уровень (не)удачи отряда]
!!VRy5&y2<0:*-1;                      [...]
!!VRy4:S0 R99;                        [y4 - случайное число 0.99]
!!FU&y5<y4:E;                         [выход, если (не)удача не выпала]
!!MF:F?y6;                            [y6 - урон, который получит отряд]
!!BMy1:T?y7;                          [y7 - тип существ в отряде наносящем урон]
!!UN:N3/2/y7/1;                       [Z2 - название существ наносящих урон (мн.число)]
!!if&y2>0;                            [срабатывание удачи]
  !!VRy6:*3 :2;                       [урон 150%]
  !!VRz1:Sz179186;                    [получаем текст для вывода в лог битвы из ert]
  !!MM:Sz1;                           [вывод текста в лог битвы]
  !!VRz77:S^FORTUNE^;                 [z1 - звуковой файл удачи]
  !!SN:Pz77;                          [вывод звука удачи]
  !!BMy1:V18;                         [анимация удачи на отряде]
!!el;                                 [срабатывание неудачи]
  !!VRy6::2;                          [урон 50%...]
  !!VRy6&y6=0:S1;                     [...но не менее 1]
  !!VRz1:Sz179187;                    [получаем текст для вывода в лог битвы из ert]
  !!MM:Sz1;                           [вывод текста в лог битвы]
  !!VRz77:S^MISFORT^;                 [z1 - звуковой файл неудачи]
  !!SN:Pz77;                           [вывод звука неудачи]
  !!BMy1:V48;                         [анимация неудачи на отряде]
!!en; 
!!MF:Fy6;                             [корректировка урона]

** "Выносливость" командира
!?MF1;                                [перед нанесением физического урона]
!!MF:N?y1;                            [y1 - отряд получающий урон]
!!FU&y1<>i^bh_commander_stack_0^/y1<>i^bh_commander_stack_1^:E;           [выход, если урон получает не командир]
!!VRy2:Sy1 :21;                       [y2=0/1 - сторона командира]
!!SN:W^BH.Commander%Y2.Hardiness^/?y3; [y3=1, если у командира есть "Выносливость"]
!!FU&y3=0:E;                          [выход, если нет "Выносливости"]
!!BMy1:H?y2 L?y3;                     [y2/y3 - общее/потерянное здоровье командира]
!!VRy3:*100 :y2 :2;                   [y3 - 1/2 от процента потерянного здоровья - процент снижения урона]
!!MF:F?y2;                            [y2 - получаемый урон]
!!VRy3:*y2 :100;                      [y3 - игнорируемый урон]
!!VRy3&y3<1:S1;                       [... не менее 1]
!!VRy2:-y3;                           [y2 - получаемый урон]
!!VRy2&y2<1:S1;                       [... не менее 1]
!!MF:Fy2;                             [обновление получаемого урона]

** Фикс оригинального бага SoD, когда летающий отряд теряет ход, если гекс, на который летяющий отряд должен встать занят другим отрядом.
!?BG0;
!!BG:A?y1 S?y2;                       [y1/y2 - действие/клетка для атаки]
!!BG&y1=6/y2=-1:A0;                   [отменить действие, если невозможно переместиться на позицию для рукопашной атаки]

!?FU9046;                             [возврат в x3 возможного количества призываемых Фанатиков/Колдуний/Чародеев для героя x1, стороны х2]
!!FU9047:Px1/?y1;                     [y1 - регенерация маны героя]
!!VRy31:Sx2 *21;                      [y31 - первый отряд героя]
!!VRy32:Sy31+20;                      [y32 - последний отряд героя]
!!VRy33:Sx2*16;                       [y33 - гекс героя]
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P169;              [v1>0, если есть отряд для допризыва, v1<0, если есть свободный отряд]
!!VRy2&v1>0:Sv1 -1;                   [y2 - номер отряда Фанатиков]
!!BMy2&v1>0:N?y3;                     [y3 - текущая численность отряда Фанатиков]
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P193;              [v1>0, если есть отряд для допризыва, v1<0, если есть свободный отряд]
!!VRy2&v1>0:Sv1 -1;                   [y2 - номер отряда Волшебниц]
!!BMy2&v1>0:N?y4;                     [y4 - текущая численность отряда Волшебниц]
!!VRv1:S0;                            [обнуление v1]
!!DO9004/y31/y32/1:P136;              [v1>0, если есть отряд для допризыва, v1<0, если есть свободный отряд]
!!VRy2&v1>0:Sv1 -1;                   [y2 - номер отряда Чародеев]
!!BMy2&v1>0:N?y5;                     [y5 - текущая численность отряда Чародеев]
!!VRy3:+1 :2;                         [y3 - стоимость содержания Фанатиков]
!!VRy4:+1 :2;                         [y4 - стоимость содержания Волшебниц]
!!VRy5:+1 :2;                         [y5 - стоимость содержания Чародеев]
!!VRx3:Sy1 -y3 -y4 -y5 *2;            [возможное количество призываемых Фанатиков/Волшебниц/Чародеев = 2 * незарезервированная регенерация маны]

!?FU9047;                             [возврат в x2 значения регенерации маны героя x1]
!!HEx1:Fd/d/d/?y1 S8/?y2 A2/73/?i/?y3 A2/74/?i/?y4 A2/75/?i/?y5 A2/138/?i/?y6;[y1-y6 - параметры героя отвечающие за регенерацию маны]
!!VRx2:S0 +y1;                        [x2 - регенерация маны героя без Мистицизма...]
!!VRx2&y3>0:+1;                       [... с учетом артефактов восстановления маны]
!!VRx2&y4>0:+2;                       [...]
!!VRx2&y5>0:+3;                       [...]
!!VRx2&y6>0:+10;                      [...]
!!VRy6:Sy2 *30 *x2 :100;              [Восстановление маны Мистицизмом (30% за уровень навыка)]
!!VRy7:Sy2 *2;                        [Восстановление маны Мистицизмом (мин. значение 2 * уровень навыка)]
!!VRy6&y7>y6:Sy7;                     [Восстановление маны Мистицизмом]
!!VRx2:+y6;                           [Возврат регенерации маны]

!?FU9048;
!!SN:W^b%X2.1.0^/?k;                  [k - наличие Фонтана фортуны]
!!VRk:*5;                             [k=5 если есть ФФ]
!!VRi:S1 R99 -k;                      [i - случайное число 1.100 -5 за ФФ]
!!FU9005&x3>=i:Px1/x2/1;              [предлагаем случайное действие герою, если карта открылась]

*** фикс стрельбы командира
!?BA52;                               [перед началом битвы]
!!SN:W^algor_csf_stack^/-1 W^algor_csf_cmndr^/-1; [сброс переменных]

!?BA53;                               [перед началом битвы]
!!SN:W^algor_csf_stack^/?y1 W^algor_csf_cmndr^/?y2; [y1/y2 - номер отряда/командира с удаленной стрельбой]
!!COy2&y1>-1/y2>-1:B1/4/1;            [восстановление навыка стрельбы у командира]
!!SN:W^algor_csf_stack^/-1 W^algor_csf_cmndr^/-1; [сброс переменных]

!?BG1;
** восстановление навыка стрельбы
!!SN:W^algor_csf_stack^/?y1 W^algor_csf_cmndr^/?y2; [y1/y2 - номер отряда/командира с удаленной стрельбой]
!!if&y1>-1/y2>-1; 
  !!COy2:B1/4/1;                      [восстановление навыка стрельбы у командира]
  !!BMy1:F?y3;                        [...и у отряда]
  !!VRy3:|4;                          [...]
  !!BMy1:Fy3;                         [...]
  !!SN:W^algor_csf_stack^/-1 W^algor_csf_cmndr^/-1; [сброс переменных]
!!en; 
** отключение навыка стрельбы
!!BG:N?y2;
!!VRy1:Sy2 :21;
!!VRy3:S-1;                           [тип отряда по умолчанию]
!!BMy2&y2>=0:T?y3 P?y4;               [y3/y4 - тип/позиция активного отряда]
!!FU|y3<174/y3>191:E;                 [выход, если не командир]
!!FU9049:Py4/?y9/?y10;                [y9/y10 - количество атакующих/защищающихся отрядов рядом с позицией]
!!HE-10&y1=0:N?y12;                   [y12 - номер командира]
!!HE-20&y1=1:N?y12;                   [...]
!!VRy15:S0;                           [y15 = 0/1 если рядом нет/есть враги]
!!VRy15&y1=0/y10>0:S1;                [...]
!!VRy15&y1=1/y9>0:S1;                 [...]
!!COy12:B1/4/?y13;                    [y13 - значение навыка стрельбы у командира]
!!BMy2:U3/?y16;                       [y16 - количество выстрелов у командира]
!!VRy15&y16<1:S1;                     [если выстрелов не осталось, выставляем признак врагов рядом]
!!if&y15=1/y13=1;                     [если рядом есть враги и командир может стрелять]
  !!SN:W^algor_csf_stack^/y2 W^algor_csf_cmndr^/y12; [сохраняем значение навыка стрельбы]
  !!COy12:B1/4/0;                     [убираем навык стрельбы]
  !!BMy2:F?y14;                       [y14 - текущие флаги отряда]
  !!VRy14:|4 -4;                      [удаление флага стрельбы]
  !!BMy2:Fy14;                        [обновление флагов]
!!en; 

!?BG1;                                [после действия]
!!BG:A?y1;                            [y1 - тип действия]
!!FU&y1<>0:E;                         [выход, если действие не "отменено"]
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?FU9049;                             [возвращает в x2/x3 количество атакующих/защищающихся отрядов рядом с позицией x1]
!!VRy4:Sx1;                           [y4 - проверяемая позиция]
!!VRy9:S0;                            [y9 - соседние отряды атакующего]
!!VRy10:S0;                           [y10 - соседние отряды защищающегося]
!!VRy5:Sy4 :17;                       [y5 - линия]
!!VRy6:Sy5 %2;                        [y6 - четность линии]
!!VRy7:Sy4 %17;                       [y7 - позиция в линии]
!!if&y5>0/y7>y6;                      [1я соседняя позиция]
  !!VRy8:Sy4 -17 -y6;                 [y8 - номер позиции]
  !!BU:Ey8/?y11;                      [y11 - номер отряда в позиции]
  !!VRy9&y11>=0/y11<=20:+1;           [счетчик атакующих]
  !!VRy10&y11>=21:+1;                 [счетчик защищающихся]
!!en; 
!!if|y7<15/y6=1;                      [2я соседняя позиция]
!!if&y5>0;                            [...]
  !!VRy8:Sy4 -16 -y6;                 [y8 - номер позиции]
  !!BU:Ey8/?y11;                      [y11 - номер отряда в позиции]
  !!VRy9&y11>=0/y11<=20:+1;           [счетчик атакующих]
  !!VRy10&y11>=21:+1;                 [счетчик защищающихся]
!!en; 
!!en; 
!!if&y7<15;                           [3я соседняя позиция]
  !!VRy8:Sy4 +1;                      [y8 - номер позиции]
  !!BU:Ey8/?y11;                      [y11 - номер отряда в позиции]
  !!VRy9&y11>=0/y11<=20:+1;           [счетчик атакующих]
  !!VRy10&y11>=21:+1;                 [счетчик защищающихся]
!!en; 
!!if|y7<15/y6=1;                      [4я соседняя позиция]
  !!if&y5<10;                         [...]
    !!VRy8:Sy4 +18 -y6;               [y8 - номер позиции]
    !!BU:Ey8/?y11;                    [y11 - номер отряда в позиции]
    !!VRy9&y11>=0/y11<=20:+1;         [счетчик атакующих]
    !!VRy10&y11>=21:+1;               [счетчик защищающихся]
  !!en; 
!!en; 
!!if&y5<10/y7>y6;                     [5я соседняя позиция]
  !!VRy8:Sy4 +17 -y6;                 [y8 - номер позиции]
  !!BU:Ey8/?y11;                      [y11 - номер отряда в позиции]
  !!VRy9&y11>=0/y11<=20:+1;           [счетчик атакующих]
  !!VRy10&y11>=21:+1;                 [счетчик защищающихся]
!!en; 
!!if&y7>1;                            [6я соседняя позиция]
  !!VRy8:Sy4 -1;                      [y8 - номер позиции]
  !!BU:Ey8/?y11;                      [y11 - номер отряда в позиции]
  !!VRy9&y11>=0/y11<=20:+1;           [счетчик атакующих]
  !!VRy10&y11>=21:+1;                 [счетчик защищающихся]
!!en; 
!!VRx2:Sy9;                           [возврат значений]
!!VRx3:Sy10;                          [...]

!?FU9052;                             [логирование состояния ИИ после окончания боя]
** x1 - герой, x2(-1/0..7) - поражение/победа, x3(0/1) - сторона ИИ
!!SN:W^BH.AI.LOG^/?z12;               [z12 - базовое имя лог-файла]
!!VRy1:S10000 R9999;                  [y1 - log_id]
!!VRz10:S^Mods\BattleHeroes rus\Log\%Z12_%Y1.log^; [z10 - имя лог-файла]
!!VRz11:S^1 Битва^;                    [z11 - имя секции]
!!VRz20:S^==========================^;[...]
!!UN:N5/20/99/11/10;                  [...]
!!VRz12:S^Схема: %Z12^;               [1 - схема]
!!UN:N5/12/1/11/10;                   [...]
!!VRz12:S^ИИ победил!^;               [2 - победа]
!!VRz12&x2<0:S^ИИ проиграл.^;         [...]
!!UN:N5/12/2/11/10;                   [...]
!!VRy1:Sv997 +1;                      [3 - раунд]
!!VRz12:S^Раунд: %Y1^;                [...]
!!UN:N5/12/3/11/10;                   []
!!UN:J2/?y1;                          [4 - уровень сложности]
!!VRz12:S^Уровень сложности: %Y1^;    [...]
!!UN:N5/12/4/11/10;                   [...]
!!HEx1:B0/?z12;                       [5 - имя героя]
!!VRz12:S^Герой: № %X1 %Z12^;         [...]
!!UN:N5/12/5/11/10;                   [...]
!!VRz11:S^2 Строения существ^;        [z11 - имя секцми]
!!UN:N5/20/99/11/10;                  [...]
!!HEx1:B2/?y2;                        [y2 - класс героя]
!!VRy2::2;                            [y2 - родной город героя]
!!VRy3|y2=0/y2=1/y2=2:S0;             [y3 - 1-й город для класса]
!!VRy3|y2=3/y2=4/y2=5:S3;             [y3 - 1-й город для класса]
!!VRy3|y2=6/y2=7/y2=8:S6;             [y3 - 1-й город для класса]
!!VRy4&x3=0:Sv9980 -1 :2;             [y4 - уровень отстроенного здания в 1-м городе]
!!VRy5&x3=0:Sv9980 -1 %2;             [y5 - грейд отстроенного здания в 1-м городе]
!!VRy4&x3=1:Sv9983 -1 :2;             [...]
!!VRy5&x3=1:Sv9983 -1 %2;             [...]
!!UN:Ty3/y4/y5/?y6;                   [y6 - тип существа]
!!UN:N3/12/y6/1;                      [...]
!!UN:N5/12/1/11/10;                   [...]
!!VRy3|y2=0/y2=1/y2=2:S1;             [y3 - 2-й город для класса]
!!VRy3|y2=3/y2=4/y2=5:S4;             [y3 - 2-й город для класса]
!!VRy3|y2=6/y2=7/y2=8:S7;             [y3 - 2-й город для класса]
!!VRy4&x3=0:Sv9981 -1 :2;             [y4 - уровень отстроенного здания в 2-м городе]
!!VRy5&x3=0:Sv9981 -1 %2;             [y5 - грейд отстроенного здания в 2-м городе]
!!VRy4&x3=1:Sv9984 -1 :2;             [...]
!!VRy5&x3=0:Sv9984 -1 %2;             [...]
!!UN:Ty3/y4/y5/?y6;                   [y6 - тип существа]
!!UN:N3/12/y6/1;                      [...]
!!UN:N5/12/2/11/10;                   [...]
!!VRy3|y2=0/y2=1/y2=2:S2;             [y3 - 3-й город для класса]
!!VRy3|y2=3/y2=4/y2=5:S5;             [y3 - 3-й город для класса]
!!VRy3|y2=6/y2=7/y2=8:S8;             [y3 - 3-й город для класса]
!!VRy4&x3=0:Sv9982 -1 :2;             [y4 - уровень отстроенного здания в 3-м городе]
!!VRy5&x3=0:Sv9982 -1 %2;             [y5 - грейд отстроенного здания в 3-м городе]
!!VRy4&x3=1:Sv9985 -1 :2;             [...]
!!VRy5&x3=1:Sv9985 -1 %2;             [...]
!!UN:Ty3/y4/y5/?y6;                   [y6 - тип существа]
!!UN:N3/12/y6/1;                      [...]
!!UN:N5/12/3/11/10;                   [...]
!!VRz11:S^3 Герой: параметры^;           [z11 - имя секции]
!!UN:N5/20/99/11/10;                  [...]
!!HEx1:F?y1/?y2/?y3/?y4 I?y5/1;       [первичные параметры героя]
!!VRy4:+1 *10;                        [...]
!!FU9047:Px1/?y6;                     [...]
!!VRz12:S^Атака: %Y1^;                [...]
!!VRz13:S^Защита: %Y2^;               [...]
!!VRz14:S^Сила: %Y3^;                 [...]
!!VRz15:S^Мана: %Y5/%Y4 (+%Y6)^;      [...]
!!UN:N5/12/1/11/10 N5/13/2/11/10 N5/14/3/11/10 N5/15/4/11/10; [...]
!!VRz11:S^4 Герой: навыки^;           [z11 - имя секции]
!!UN:N5/20/99/11/10;                  [...]
!!DO9053/0/27/1:Px1/x3;               [вторичные навыки героя]
!!VRz11:S^5 Герой: магия^;       [z11 - имя секцми]
!!UN:N5/20/99/11/10;                  [...]
!!DO9054/0/69/1:Px1;                  [заклинания героя]
!!VRz11:S^6 Командир: параметры^;     [z11 - имя секцми]
!!UN:N5/20/99/11/10;                  [...]
!!VRy1&x3=0:Sv9998;                   [y1 - Номер командира]
!!VRy2&x3=0:Si^bh_commander_stack_0^;                   [y2 - Номер отряда командира]
!!VRy1&x3=1:Sv9999;                   [...]
!!VRy2&x3=1:Si^bh_commander_stack_1^;                   [...]
!!BMy2:T?y3 A?y11 D?y12 U3/?y13 U1/?y14 U2/?y15 H?y16 L?y17 S?y18; [параметры отряда командира]
!!COy1:P6/?y21 P4/?y22;               [y21/y22 - сопротивление/сила командира]
!!VRy17:-y16 *-1;                     [y17 - текущее здоровье командира]
!!MA:Ny3/?y23;                        [y23 - макс. боезапас]
!!VRz12:S^Атака: %Y11^;               [...]
!!VRz13:S^Защита: %Y12^;              [...]
!!VRz14:S^Боезапас: %Y13/%Y23^;       [...]
!!VRz15:S^Урон: %Y14-%Y15^;         [...]
!!VRz15&y14=y15:S^Урон: %Y14^;        [...]
!!VRy30&y2=i^bh_commander_stack_0^:Sv9964;              [y30=1, если есть способность Повышенная регенерация]
!!VRy30&y2=i^bh_commander_stack_1^:Sv9965;              [y30=1, если есть способность Повышенная регенерация]
!!VRy30&y30=1:Sy16 :50;               [y36 - регенерация командира]
!!VRy30&y30=0:Sy16 :100;              [...]
!!VRz16:S^Здоровье: %Y17/%Y16 (+%Y30)^;[...]
!!VRz17:S^Скорость: %Y18^;            [...]
!!VRz18:S^Сопротивление: %Y21%%^;     [...]
!!VRz19:S^Сила магии: %Y22^;          [...]
!!UN:N5/12/1/11/10 N5/13/2/11/10 N5/14/3/11/10 N5/15/4/11/10 N5/15/4/11/10 N5/16/5/11/10 N5/17/6/11/10 N5/18/7/11/10 N5/19/8/11/10; [...]
!!VRz11:S^7 Командир: навыки^;        [z11 - имя секции]
!!UN:N5/20/99/11/10;                  [...]
!!COy1:B1/0/?y10 B1/2/?y12 B1/3/?y13 B1/4/?y14 B1/5/?y15 B1/6/?y16 B1/7/?y17 B1/9/?y19;  [...]
!!VRy11&x3=0:Sv9964;                  [...]
!!VRy11&x3=1:Sv9965;                  [...]
!!VRy98:Sy2 :21;                      [y98 - сторона командира]
!!SN:W^BH.Commander%Y98.Hardiness^/?y18; [y2 - есть ли способность]
!!VRz12&y10=1:S^Уменьшение защиты^;   [...]
!!UN&y10=1:N5/12/0/11/10;             [...]
!!VRz12&y11=1:S^Повышенная регенерация^;[...]
!!UN&y11=1:N5/12/1/11/10;             [...]
!!VRz12&y12=1:S^Максимальный урон^;   [...]
!!UN&y12=1:N5/12/2/11/10;             [...]
!!VRz12&y13=1:S^Безответный удар^;    [...]
!!UN&y13=1:N5/12/3/11/10;             [...]
!!VRz12&y14=1:S^Стрельба^;            [...]
!!UN&y14=1:N5/12/4/11/10;             [...]
!!VRz12&y15=1:S^Неограниченная контратака^;[...]
!!UN&y15=1:N5/12/5/11/10;             [...]
!!VRz12&y16=1:S^Круговая атака^;      [...]
!!UN&y16=1:N5/12/6/11/10;             [...]
!!VRz12&y17=1:S^Огненный щит^;        [...]
!!UN&y17=1:N5/12/7/11/10;             [...]
!!VRz12&y18=1:S^Выносливость^;        [...]
!!UN&y18=1:N5/12/8/11/10;             [...]
!!VRz12&y19=1:S^Двойной удар^;        [...]
!!UN&y19=1:N5/12/9/11/10;             [...]
!!VRz11:S^8 Командир: магия^;    [z11 - имя секции]
!!UN:N5/20/99/11/10;                  [...]
!!DO9055/0/9/1:Px3;                   [...]

!?FU9053;
!!HEx1:Sx16/?y1;                      [y1 - уровень навыка]
!!UN:N4/12/x16;                       [...]
!!if&x16=5; 
  !!SN:W^spec_%X2^/?y2;               [y2 - специализация]
  !!VRz12&y2=1:S^Специализация: Призыв^;    [...]
  !!VRz12&y2=2:S^Специализация: Заклинания^;[...]
  !!VRz12&y2=3:S^Специализация: Герой^;     [...]
  !!VRz12&y2=4:S^Специализация: Отстройка^; [...]
  !!VRz12&y2=5:S^Специализация: Командир^;  [...]
  !!VRz12&y2=6:S^Специализация: Гильдии^;   [...]
!!en; 
!!VRz12&y1=0:S^%Z12 [Нет]^;           [...]
!!VRz12&y1=1:S^%Z12 [Базовый]^;       [...]
!!VRz12&y1=2:S^%Z12 [Продвинутый]^;   [...]
!!VRz12&y1=3:S^%Z12 [Эксперт]^;       [...]
!!UN&y1>0:N5/12/x16/11/10;            [...]

!?FU9054;
!!HEx1:Mx16/?y1;                      [y1 - заклинание]
!!FU&y1=0:E;                          [...]
!!UN:N1/12/x16;                       [...]
!!UN:N5/12/x16/11/10;                 [...]

!?FU9055;
!!SN:W^Cmndr%X1Sp%X16^/?y1;           [y1 - заклинание в слоте]
!!FU&y1<0:E;                          [...]
!!UN:N1/12/y1;                        [...]
!!UN:N5/12/x16/11/10;                 [...]

** Действия строений после выбора карт героями
!?FU9062;                             [x1 - героя (-10/-20), x2 - сторона (0/1)]
** Библиотека - шанс изучить случайное заклинание
!!SN:W^b%X2.2.0^/?y1;                 [y1 - наличие Библиотеки]
!!VRy2:S0 R9;                         [шанс изучения заклинания - 10%]
!!if&y1=1/y2=1; 
  !!HEx1:S7/?y2;                      [y2 - Уровень мудрости героя]
  !!VRy2:+1;                          [y2 - макс. доступный для изучения уровень заклинания (1..4)]
  !!VRy3:S1 Ry2;                      [y3 - случ. уровень изучаемого заклинания (1..5)]
  !!VRv1:S0;                          [обнуление v1]
  !!DO9013/10/69/1:Px1/y3/0;          [v1 - количество неизученны боевых заклианний нужного уровня героем]
  !!if&v1>0;                          [если есть хоть одно неизученое заклинание нужного уровня]
    !!VRv1:-1;
    !!VRy2:S1 Rv1;                    [y2 - порядковый номер изучаемого неизученного заклинания нужного уровня]
    !!VRv1:S0;                        [обнуление v1]
    !!DO9013/10/69/1:Px1/y3/y2;       [v1 - номер изучаемого заклинания]
    !!HEx1:Mv1/1 B0/?z7;              [z7 - имя героя]
    !!UN:N1/8/v1;                     [z8 - Название заклинания]
    !!VRz9:Sz179196;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!HEx1:My2/1;                     [Изучение заклинания]
    !!FU(BH_PlayAnimationOnHero):P20/x2;                  [анимация Морали на герое]
  !!en; 
!!en; 
** Стена Знаний - шанс повысить Знание героя
!!SN:W^b%X2.2.1^/?y1;                 [y1 - наличие Стены Знаний]
!!VRy2:S0 R9;                         [шанс Повышения Знания - 10%]
!!if&y1=1/y2=1; 
    !!HEx1:B0/?z7 Fd/d/d/d1;          [z7 - имя героя, повышение Знания]
    !!VRz9:Sz179197;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU(BH_PlayAnimationOnHero):P20/x2;                  [анимация Морали на герое]
!!en; 
** Орден Огня - шанс повысить Силу героя
!!SN:W^b%X2.3.1^/?y1;                 [y1 - наличие Ордена Огня]
!!VRy2:S0 R9;                         [шанс Повышения Знания - 10%]
!!if&y1=1/y2=1; 
    !!HEx1:B0/?z7 Fd/d/d1/d;          [z7 - имя героя, повышение Силы]
    !!UN:C6919200/4/?y5;              [повышение Силы магии героя, используемой при наложени заклинания...]
    !!VRy6:Sx2 *4 +21460 +y5;         [...отдельное большое спасибо Sav'у за пример...]
    !!UN:Cy6/4/d1;                    [...]
    !!VRz9:Sz179199;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU(BH_PlayAnimationOnHero):P20/x2;                  [анимация Морали на герое]
!!en; 
** Клеть Богов Войны - шанс повысить Защиту героя
!!SN:W^b%X2.7.1^/?y1;                 [y1 - наличие Клети Богов Войны]
!!VRy2:S0 R9;                         [шанс Повышения Защиты - 10%]
!!if&y1=1/y2=1; 
    !!HEx1:B0/?z7 Fd/d1/d/d;          [z7 - имя героя, повышение Защиты]

    !!DO9014/0/20/1&x2=0/y2<33:Px1/0/1;[Увеличение атаки/защиты стеков левого]
    !!DO9014/21/41/1&x2=1/y2<33:Px1/0/1;[Увеличение атаки/защиты стеков правого]
    !!VRz9:Sz179200;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU(BH_PlayAnimationOnHero):P20/x2;                  [анимация Морали на герое]
!!en; 
** Храм Валгаллы - шанс повысить Атаку героя
!!SN:W^b%X2.6.0^/?y1;                 [y1 - наличие Храма Валгаллы]
!!VRy2:S0 R9;                         [шанс Повышения Атаки - 10%]
!!if&y1=1/y2=1; 
    !!HEx1:B0/?z7 Fd1/d/d/d;          [z7 - имя героя, повышение Атаки]
    !!DO9014/0/20/1&x2=0/y2<33:Px1/1/0;[Увеличение атаки/защиты стеков левого]
    !!DO9014/21/41/1&x2=1/y2<33:Px1/1/0;[Увеличение атаки/защиты стеков правого]
    !!VRz9:Sz179201;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU(BH_PlayAnimationOnHero):P20/x2;                  [анимация Морали на герое]
!!en; 
** Вихрь Маны - шанс восполнить ману героя до удвоенного максимума
!!SN:W^b%X2.5.0^/?y1;                 [y1 - наличие Вихря маны]
!!VRy2:S0 R19;                        [шанс активации - 5%]
!!if&y1=1/y2=1; 
  !!HEx1:Fd/d/d/?y3;                  [y3 - удвоенный максимум маны героя]
  !!VRy3:*10 +10 *2;                  [...]
  !!HEx1:B0/?z7 Iy3/1;                [z7 - имя героя, наполнение маной]
  !_!VRy4:Sx1 *-1 -30;                 [y4 - вражеский герой]
  !_!VRy5:Sx2 *-1 +1;                  [y5 - вражеская сторона]
  !!HEx1:B0/?z7 Iy3/1;                [z7 - имя героя, наполнение маной]
  !_!HEy4:B0/?z8 I0/1;                 [z8 - имя героя врага, осушение]
  !!VRz9:Sz179198;                    [z9 - строка действия]
  !!BU:Mz9;                           [вывод сообщения в лог боя]
  !!FU(BH_PlayAnimationOnHero):P75/x2; P76/y5;             [анимация добавления/высасывания маны на героях]
!!en; 
** Университет Магии - Усилении случайного навыка Школы
!!SN:W^b%X2.8.0^/?y1;                 [y1 - наличие Университета Магии]
!!if&y1=1; 
  !!HEx1:S14/?y2 S15/?y3 S16/?y4 S17/?y5; [y2-y5 - навыки Школ героя]
  !!VRy2:S14 R3;                      [y2 - усиливаемый навык Школы]
  !!HEx1:Sy2/?y3;                     [y3 - уровень Школы у егроя]
  !!VRy4:S1 R2 +y3;                   [y4 - уровень Школы после усиления]
  !!VRy4&y4>3:S3;                     [...]
  !!VRy5:Sy4 -y3;                     [y5 - бонус усиления]
  !!if&y5>0; 
    !!HEx1:B0/?z7 Sy2/y4;             [z7 - имя героя, усиление навыка]
    !!UN:N4/8/y2;                     [z8 - название навыка]
    !!VRz9:Sz179202;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!SN:W^um%X2.skill^/y2 W^um%X2.bonus^/y5; [сохранение усиливаемого навыка и бонуса усиления]
  !!en; 
!!en; 
** Гильдия Горняков - призыв гномов/боевых гномов
!!SN:W^b%X2.1.1^/?y1;                 [y1 - наличие Гильдии Горняков]
!!if&y1=1; 
  !!VRy2:S16 R1;                      [y2 - Призываемое существо]
  !!MA:Fy2/?y3;                       [y3 - FV существа]
  !!VRy4:S300 R700 :y3 +1;            [y4 - кол-во существ для призыва - 300..1000 FV +1]
  !!FU9010:Py2/x2/y4/0/4;             [призыв Гильдии Горняков]
!!en; 
** Портал Вызова - призыв случайных отстроенных существ
!!SN:W^b%X2.5.1^/?y1;                 [y1 - наличие Портала Вызова]
!!if&y1=1; 
  !!VRy2:S16 R1;                      [y2 - Призываемое существо]
  !!HEx1:B2/?y2;                      [y2 - класс героя (0..17)]
  !!VRy2::6 *3 R2;                    [y2 - Замок для призыва (один из 3х дружественной фракции)]
  !!VRy15:Sy2 %3;                     [y15 - номер расы для призыва]
  !!VRy16:Sx2 *3 +9980 +y15;          [y16 - индекс v-переменной, с отстройкой для расы]
  !!VRy17:Svy16 -1 :2 +1;             [y17 - макс. отстроенный уровень существ выбранной расы (1..7)]
  !!VRy18:S1;                         [y18 - мин. уровень существа для призыва...]
  !!VRy18&y17>3:Sy17 -2;              [...N-2, но не меньше 1]
  !!VRy19:Sy17 -y18;                  [y19 - разброс для случайного выбора]
  !!VRy5:Sy18 Ry19 -1;                [y5 - призываемый уровень (N-2..N)]
  !!VRy6:Sy5 *2 +2;                   [y6 - номер улучшенного жилища призываемого существа]
  !!VRy6&y6<=vy16:S1;                 [y6=1, если отстроены улучшенные существа]
  !!VRy6&y6>vy16:S0;                  [y6=0, если НЕ отстроены улучшенные существа]
  !!FU9011:Py2/y5/y6/?y8;             [y8 - номер призываемого существа]
  !!FU9010:Py8/x2/1/0/6;              [призыв Портала Вызова]
!!en; 
** Гильдия Наемников - призыв наемников
!!SN:W^b%X2.6.1^/?y1;                 [y1 - наличие Гильдии Наемников]
!!if&y1=1; 
  !!VRy2:S0 R8;                       [y2 - Призываемое существо]
  !!VRy5&y2=0:S143;                   [Воры]
  !!VRy5&y2=1:S140;                   [Кабаны]
  !!VRy5&y2=2:S142;                   [Кочевники]
  !!VRy5&y2=3:S194;                   [Оборотни]
  !!VRy5&y2=4:S138;                   [Хоббиты]
  !!VRy5&y2=5:S192;                   [Сильванские кентавры]
  !!VRy5&y2=6:S137;                   [Снайперы]
  !!VRy5&y2=7:S171;                   [Л.Снайперы]
  !!VRy5&y2=8:S170;                   [А.Снайперы]
  !!MA:Fy5/?y3;                       [y3 - FV существа]
  !!VRy4:S300 R700 :y3 +1;            [y4 - кол-во существ для призыва - 300..1000 FV +1]
  !!FU9010:Py5/x2/y4/0/7;             [призыв Гильдии Наемников]
!!en; 
** Колосс
!!SN:W^b%X2.0.2^/?y1;                 [y1 - наличие Колосса]
!!if&y1>0; 
  !!FU9060:P150/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179288;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P150/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.0.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Хранитель Духа
!!SN:W^b%X2.1.2^/?y1;                 [y1 - наличие Хранителя Духа]
!!if&y1>0; 
  !!FU9060:P151/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179289;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P151/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.1.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Небесный Корабль
!!SN:W^b%X2.2.2^/?y1;                 [y1 - наличие Небесного Корабля]
!!if&y1>0; 
  !!FU9060:P152/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179290;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P152/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.2.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Бог Огня
!!SN:W^b%X2.3.2^/?y1;                 [y1 - наличие Бога Огня]
!!if&y1>0; 
  !!FU9060:P153/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179291;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P153/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.3.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Темница Дух
!!SN:W^b%X2.4.2^/?y1;                 [y1 - наличие Темницы Душ]
!!if&y1>0; 
  !!FU9060:P154/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179292;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P154/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.4.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Хранитель Земли
!!SN:W^b%X2.5.2^/?y1;                 [y1 - наличие Хранителя Земли]
!!if&y1>0; 
  !!FU9060:P155/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179293;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P155/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.5.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Памятник Богам Войны
!!SN:W^b%X2.6.2^/?y1;                 [y1 - наличие Памятника Богам Войны]
!!if&y1>0; 
  !!FU9060:P156/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179294;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P156/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.6.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Плотоядное Растение
!!SN:W^b%X2.7.2^/?y1;                 [y1 - наличие Плотоядного Растения]
!!if&y1>0; 
  !!FU9060:P157/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179295;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P157/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.7.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Сияние
!!SN:W^b%X2.8.2^/?y1;                 [y1 - наличие Сияния]
!!if&y1>0; 
  !!FU9060:P158/x2;                   [v1 - наличие Хранителя в армии]
  !!VRy2:Sv1;                         [y2 - наличие Хранителя в армии]
  !!if&y2<0/y1=2;                     [если Хранителя нет и время его призвать]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179296;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
    !!FU9010:P158/x2/1/0/8;           [призыв Грааля]
    !!VRy1:S1;                        [состояние Грааля]
    !!VRy2:S0;                        [флаг "есть Хранитель"]
  !!en; 
  !!VRy1&y2<0/y1=1:S11;               [если Хранитель убит, запускаем счетчик перезарядки грааля на 10 раундов]
  !!VRy1&y1>1:-1;                     [уменьшаем счетчик]
  !!SN:W^b%X2.8.2^/y1;                [обновляем состояние Грааля]
!!en; 
** Сад Жизни - повышает максимальный запас здоровья командира за счет живых существ в армии героя
!!SN:W^b%X2.8.1^/?y1;                 [y1 - наличие Сада Жизни]
!!if&y1=1; 
  !!VRy3:Sx2 *21;                     [y3 - первый отряд героя]
  !!VRy4:Sy3 +20;                     [y4 - последний отряд героя]
  !!VRv1:S0;                          [Обнуление v1]
  !!DO9057/y3/y4/1:P;                 [Снижение макс здоровья живых существ в армии героя]
  !!if&v1>0; 
    !!VRy5:Sv1;                       [y5 - бонус макс. здоровью командира]
    !!VRz1:S^MIRTH^;                  [z1 - звуковой файл]
    !!SN:P1;                          [вывод звука]
    !!BMi^bh_commander_stack_%x2^:Hdy5 V77;                 [Повышение макс. здоровья командира]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179203;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
  !!en; 
!!en; 
** Братство Меча - до конца раунда повышает атаку и защиту командира на 1 за каждый союзный отряд на поле боя
!!SN:W^b%X2.0.0^/?y1;                 [y1 - наличие Братства Меча]
!!if&y1=1; 
  !!VRy3:Sx2 *21;                     [y3 - первый отряд героя]
  !!VRy4:Sy3 +20;                     [y4 - последний отряд героя]
  !!VRv1:S0;                          [Обнуление v1]
  !!DO9058/y3/y4/1:P;                 [подсчет союзных отрядов]
  !!if&v1>0; 
    !!VRy5:Sv1;                       [y5 - бонус макс. здоровью командира]
    !!BMi^bh_commander_stack_%x2^:Ady5 Ddy5;                [Повышение атаки и защиты]
    !!SN:W^bm%X2.bonus^/y5;           [сохранение бонуса усиления]
    !!HEx1:B0/?z7;                    [z7 - имя героя]
    !!VRz9:Sz179206;                  [z9 - строка действия]
    !!BU:Mz9;                         [вывод сообщения в лог боя]
!!en; 
!!UN:C6919200/4/?y2; !!SN:E4797616/2/y2/0/1; !!SN:D;    [перерисовываем тень перемещения]

!?FU(BH_PlayAnimationOnHero);                             [анимация x1 на герое стороны x2 (0/1)]
!#VA(animId:x) (side:x);
!!VRz1:S^CHAT^;                       [z1 - звуковой файл по умолчанию]
!!VRz1&x1=6:S^BLIND^;                 [z1 - звуковой файл ослепления]
!!VRz1&x1=20:S^MIRTH^;                [z1 - звуковой файл морали]
!!VRz1&x1=75:S^MIRTH^;                [z1 - звуковой файл морали]
!!SN:Pz1;                              [вывод звука]
!!UN:C(COMBAT_MANAGER)/4/?(mgr:y);                   [анимация на герое]
!!VR(hexId:y):S(side) *16;                        [j=0/16 для атакующего, защищающегося героя]
!!SN:E4810128/2/(mgr)/x1/(side)/1/0;      [...]
*!SN&x2=1:E4810128/2/i/x1/j/1/0;      [...]
496590
!?FU9056;                             [сброс бонусов Университета магии и Братства Меча]
!!SN:W^um%X2.skill^/?y1 W^um%X2.bonus^/?y2; [y1/y2 - усиленный навык/бонус усиления Университета]
!!if&y1>0; 
  !!HEx1:Sy1/?y3;                     [y3 - текущий уровень навыка]
  !!VRy3:-y2;                         [y3 - уровень навыка без усиления]
  !!VRy3&y3<0:S0;                     [...]
  !!HEx1:Sy1/y3;                      [сброс усиления навыка]
  !!SN:W^um%X2.skill^/-1 W^um%X2.bonus^/0; [сброс усиливаемого навыка и бонуса усиления]
!!en; 
!!SN:W^bm%X2.bonus^/?y1;              [y1 - бонус усиления Братства]
!!if&y1>=0; 
  !!VRy1:*-1;                         [y1 - штраф]
  !!BMi^bh_commander_stack_%x2^:Ady1 Ddy1 A?y1 D?y2;        [y1/y2 - атака/защита командира]
  !!VRy1&y1<0:S0;                     [...]
  !!VRy2&y2<0:S0;                     [...]
  !!BMi^bh_commander_stack_%x2^:Ay1 Dy2;                    [обновление атаки/защиты командира]
  !!SN:W^bm%X2.bonus^/0;              [сброс бонуса усиления Братства]
!!en; 

!?FU9057;                             [перекачка макс. здоровья командиру]
!!FU|x16=i^bh_commander_stack_0^/x16=i^bh_commander_stack_1^:E;           [отряд командира не участвует в подсчете]
!!BMx16:T?y1 N?y2 H?y3 L?y4;          [y1/y2/y3/y4 - тип/кол-во/макс.Здр/потер.Здр существ в отряде]
!!FU|y1<0/y2<1/y3<4:E;                [выход, если существ нет или их запас здоровья истощен (<4)]
!!BMx16:F?y5;                         [y5 - флаги отряда]
!!VRy5:&16;                           [y5>0 для живых существ]
!!FU&y5=0:E;                          [выход, если существо не живое]
!!VRy3:-1;                            [y3 новое макс. Здр существ]
!!VRy2&y4>=y3:-1;                     [если последнее существо при смерти, не перекачиваем здоровье из него]
!!VRy4&y4>=y3:-1;                     [...]
!!BMx16:Hy3 Ly4;                      [Обновляем параметры отряда]
!!VRv1:+y2;                           [Накапливаем здоровье для передачи командиру]

!?FU9058;                             [подсчет союзных отрядов]
!!FU|x16=i^bh_commander_stack_0^/x16=i^bh_commander_stack_1^:E;           [отряд командира не участвует в подсчете]
!!BMx16:T?y1 N?y2;                    [y1/y2 - тип/кол-во существ в отряде]
!!VRv1&y1>=0/y2>0:+1;                 [учет отряда]

** Знаки страха - 5% шанс повергнуть в ужас вражеский отряд
!?FU77007;                            [фаза регенерации]
!!SN:X?y2;                            [y2 - Отряд]
!!VRy1:Sy2 :21;                       [y1 - сторона]
!!VRy3:Sy1 -1 *-1;                    [y3 - вражеская сторона]
!!SN:W^b%Y3.7.0^/?y3;                 [y1 - наличие Знаков Страха]
!!VRy4:S0 R19;                        [шанс срабатывания - 5%]
!!BMy2:F?y5 T?y7;                     [y5/y7 - флаги/тип существа]
!!VRy6:Sy5 &16;                       [y6>0 для "живых" существ]
!!VRy7&y7>=150/y7<=158:S-1;           [y7=-1 для Хранителей]
!!if&y3=1/y4=1/y6>0/y7>0;             [если испуг сработал]
  !!VRy5:|67108864;                   [добавляем флаг "уже ходил"]
  !!VRz1:S^FEAR^;                     [z1 - звуковой файл Страха]
  !!SN:P1;                            [вывод звука Страха]
  !!BMy2:Fy5 R0 V15 G74/1/?i;         [обновление флагов, обнуление контрударов и Анимация Страха и парализация на 1 ход]
  !!VRz9:Sz179207;                    [z9 - строка действия]
  !!BU:Mz9;                           [вывод сообщения в лог боя]
  !!SN:X?i/?j/1;                      [блокируем фазу регенерации]
!!en; 

!?FU9060;                             [возврат в v1 номера живого отряда существ x1 на стороне x2]
!!VRy1:Sx2 *21;                       [y1-y2 - отряды для поиска]
!!VRy2:Sy1 +20;                       [...]
!!VRv1:S-1;                           [инициализация v1]
!!DO9061/y1/y2/1:Px1;                 [поиск отряда нужных существ в v1]

!?FU9061;                             [возврат в v1 номера живого отряда существ x1]
!!BMx16:T?y1 N?y2;                    [y1/y2 - тип/кол-ао существ]
!!VRv1&x1=y1/y2>0:Sx16;               [v1=номер отряда, если существо найдено]
!!VRx16&x1=y1/y2>0:S99;               [прерываем поиск, если существо найдено]]

*** Использование заклинаний призыва ИИ
!?BG0;                                [перед действием отряда]
!!BG:N?y1 Q?y3;                       [y1/y3 - текущий отряд/сторона]
!!BHy3:M?y6;                          [y6=0, если герой еще не колдовал в раунде]
!!FU&y6=1:E;                          [выход, если герой уже колдовал]
!!BMy1:T?y2;                          [y2 - тип активного отряда]
!!FU&y2<>174/y2<>178/y2<>182/y2<>183/y2<>187/y2<>192/y2<>164/y2<>165/y2<>166/y2<>167:E; [выход, если не командир или посланник]
!!VRy4&y3=0:Sv9998; !!VRy4&y3=1:Sv9999; [y4 - герой]
!!HEy4:Fd/d/?y6/d;                    [y6 - SP героя]
!!FU&y6<5:E;                          [выход, если SP героя ниже 5]
!!HEy4:O?y5 I?y7/1;                   [y5/y7 - владелец/мана текущего героя]
!!OW:Iy5/?y6;                         [y6 = 1 для ИИ]
!!FU&y6=0:E;                          [выход, если ходит не ИИ]
!!HEy4:M69/?y11 M68/?y12 M66/?y13 M67/?y14; [y11-y14 - заклинания призыва героя]
!!FU&y11=0/y12=0/y13=0/y14=0:E;       [выход, если герой не знает заклинаний призыва]
!!HEy4:S15/?y21 S16/?y22 S14/?y23 S17/?y24; [y21-y24 - уровни школ магии героя]
!!SS69:Cy21/?y31; !!SS68:Cy22/?y32; !!SS66:Cy23/?y33; !!SS67:Cy24/?y34; [y31-y34 - стоимости заклинаний]
!!VRy8&y11=1/y31<=y7:S69;             [y8 - наиболее эффективное заклианние призыва, на которое хватает маны]
!!VRy9&y11=1/y31<=y7:Sy21;            [y9 - уровень соответствующей школы]
!!VRy8&y12=1/y32<=y7/y22>=y9:S68;     [...]
!!VRy9&y12=1/y32<=y7/y22>=y9:Sy22;    [...]
!!VRy8&y13=1/y33<=y7/y23>=y9:S66;     [...]
!!VRy9&y13=1/y33<=y7/y23>=y9:Sy23;    [...]
!!VRy8&y14=1/y34<=y7/y24>=y9:S67;     [...]
!!VRy9&y14=1/y34<=y7/y24>=y9:Sy24;    [...]
!!FU&y8=0:E;                          [выход, если заклиание призыва не доступно (нет маны)]
!!BG:A1 Sy8;                          [каст заклинания героем]

!?CM4;                                [клик на поле боя]
!!CM:I?y1 F?y2;                       [y1/y2 - место и тип клика]
!!CM&y1=2010/y2=512:R0;               [отмена ПКМ по кнопке "Защищаться" (отключение возможности выбора типа атаки)]

** end
